'use strict';

exports.__esModule = true;

var _values = require('babel-runtime/core-js/object/values');

var _values2 = _interopRequireDefault(_values);

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _builtIn = require('./built-in');

var _builtIn2 = _interopRequireDefault(_builtIn);

var _pluginHost = require('./plugin-host');

var _pluginHost2 = _interopRequireDefault(_pluginHost);

var _parseProviderName = require('./parse-provider-name');

var _parseProviderName2 = _interopRequireDefault(_parseProviderName);

var _ = require('./');

var _2 = _interopRequireDefault(_);

var _connection = require('../connection');

var _connection2 = _interopRequireDefault(_connection);

var _runtime = require('../../errors/runtime');

var _message = require('../../errors/runtime/message');

var _message2 = _interopRequireDefault(_message);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const BROWSER_PROVIDER_RE = /^([^:\s]+):?(.*)?$/;

exports.default = {
    providersCache: {},

    _handlePathAndCmd(alias) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const browserName = (0, _stringify2.default)(alias);
            const providerName = 'path';
            const provider = yield _this.getProvider(providerName);

            return { provider, providerName, browserName };
        })();
    },

    _parseAliasString(alias) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const providerRegExpMatch = BROWSER_PROVIDER_RE.exec(alias);

            if (!providerRegExpMatch) throw new _runtime.GeneralError(_message2.default.cantFindBrowser, alias);

            let providerName = providerRegExpMatch[1];
            let browserName = providerRegExpMatch[2] || '';

            let provider = yield _this2.getProvider(providerName);

            if (!provider && providerRegExpMatch[2]) provider = yield _this2.getProvider(providerName + ':');

            if (!provider) {
                providerName = 'locally-installed';
                provider = yield _this2.getProvider(providerName);
                browserName = providerRegExpMatch[1] || '';
            }

            return { provider, providerName, browserName };
        })();
    },

    _parseAlias(alias) {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (alias && alias.path) return _this3._handlePathAndCmd(alias);

            if (typeof alias === 'string') return _this3._parseAliasString(alias);

            throw new _runtime.GeneralError(_message2.default.cantFindBrowser, alias);
        })();
    },

    _getInfoForAllBrowserNames(provider, providerName) {
        return (0, _asyncToGenerator3.default)(function* () {
            const allBrowserNames = provider.isMultiBrowser ? yield provider.getBrowserList() : [];

            if (!allBrowserNames.length) return { provider, providerName, browserName: '' };

            return allBrowserNames.map(function (browserName) {
                return { provider, providerName, browserName };
            });
        })();
    },

    _getProviderModule(providerName, moduleName) {
        try {
            const providerObject = require(moduleName);

            this.addProvider(providerName, providerObject);
            return this._getProviderFromCache(providerName);
        } catch (e) {
            return null;
        }
    },

    _getProviderFromCache(providerName) {
        return this.providersCache[providerName] || null;
    },

    _getBuiltinProvider(providerName) {
        const providerObject = _builtIn2.default[providerName];

        if (!providerObject) return null;

        this.addProvider(providerName, providerObject);

        return this._getProviderFromCache(providerName);
    },

    getBrowserInfo(alias) {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (alias instanceof _connection2.default) return alias;

            const browserInfo = yield _this4._parseAlias(alias);

            const provider = browserInfo.provider,
                  providerName = browserInfo.providerName,
                  browserName = browserInfo.browserName;


            if (browserName === 'all') return yield _this4._getInfoForAllBrowserNames(provider, providerName);

            if (!(yield provider.isValidBrowserName(browserName))) throw new _runtime.GeneralError(_message2.default.cantFindBrowser, alias);

            return (0, _extends3.default)({ alias }, browserInfo);
        })();
    },

    addProvider(providerName, providerObject) {
        providerName = (0, _parseProviderName2.default)(providerName).providerName;

        this.providersCache[providerName] = new _2.default(new _pluginHost2.default(providerObject, providerName));
    },

    removeProvider(providerName) {
        providerName = (0, _parseProviderName2.default)(providerName).providerName;

        delete this.providersCache[providerName];
    },

    getProvider(providerName) {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const parsedProviderName = (0, _parseProviderName2.default)(providerName);
            const moduleName = parsedProviderName.moduleName;

            providerName = parsedProviderName.providerName;

            const provider = _this5._getProviderFromCache(providerName) || _this5._getProviderModule(providerName, moduleName) || _this5._getBuiltinProvider(providerName);

            if (provider) yield _this5.providersCache[providerName].init();

            return provider;
        })();
    },

    dispose() {
        return _pinkie2.default.all((0, _values2.default)(this.providersCache).map(item => item.dispose()));
    }
};
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL3Bvb2wuanMiXSwibmFtZXMiOlsiQlJPV1NFUl9QUk9WSURFUl9SRSIsInByb3ZpZGVyc0NhY2hlIiwiX2hhbmRsZVBhdGhBbmRDbWQiLCJhbGlhcyIsImJyb3dzZXJOYW1lIiwicHJvdmlkZXJOYW1lIiwicHJvdmlkZXIiLCJnZXRQcm92aWRlciIsIl9wYXJzZUFsaWFzU3RyaW5nIiwicHJvdmlkZXJSZWdFeHBNYXRjaCIsImV4ZWMiLCJHZW5lcmFsRXJyb3IiLCJNRVNTQUdFIiwiY2FudEZpbmRCcm93c2VyIiwiX3BhcnNlQWxpYXMiLCJwYXRoIiwiX2dldEluZm9Gb3JBbGxCcm93c2VyTmFtZXMiLCJhbGxCcm93c2VyTmFtZXMiLCJpc011bHRpQnJvd3NlciIsImdldEJyb3dzZXJMaXN0IiwibGVuZ3RoIiwibWFwIiwiX2dldFByb3ZpZGVyTW9kdWxlIiwibW9kdWxlTmFtZSIsInByb3ZpZGVyT2JqZWN0IiwicmVxdWlyZSIsImFkZFByb3ZpZGVyIiwiX2dldFByb3ZpZGVyRnJvbUNhY2hlIiwiZSIsIl9nZXRCdWlsdGluUHJvdmlkZXIiLCJCVUlMVF9JTl9QUk9WSURFUlMiLCJnZXRCcm93c2VySW5mbyIsIkJyb3dzZXJDb25uZWN0aW9uIiwiYnJvd3NlckluZm8iLCJpc1ZhbGlkQnJvd3Nlck5hbWUiLCJCcm93c2VyUHJvdmlkZXIiLCJCcm93c2VyUHJvdmlkZXJQbHVnaW5Ib3N0IiwicmVtb3ZlUHJvdmlkZXIiLCJwYXJzZWRQcm92aWRlck5hbWUiLCJpbml0IiwiZGlzcG9zZSIsIlByb21pc2UiLCJhbGwiLCJpdGVtIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOzs7Ozs7QUFFQSxNQUFNQSxzQkFBc0Isb0JBQTVCOztrQkFFZTtBQUNYQyxvQkFBZ0IsRUFETDs7QUFHTEMs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LEtBMUdVOztBQTRHWGdDLG1CQUFnQmhDLFlBQWhCLEVBQThCO0FBQzFCQSx1QkFBZSxpQ0FBa0JBLFlBQWxCLEVBQWdDQSxZQUEvQzs7QUFFQSxlQUFPLEtBQUtKLGNBQUwsQ0FBb0JJLFlBQXBCLENBQVA7QUFDSCxLQWhIVTs7QUFrSExFLGVBQU4sQ0FBbUJGLFlBQW5CLEVBQWlDO0FBQUE7O0FBQUE7QUFDN0Isa0JBQU1pQyxxQkFBcUIsaUNBQWtCakMsWUFBbEIsQ0FBM0I7QUFDQSxrQkFBTWtCLGFBQXFCZSxtQkFBbUJmLFVBQTlDOztBQUVBbEIsMkJBQWVpQyxtQkFBbUJqQyxZQUFsQzs7QUFFQSxrQkFBTUMsV0FBVyxPQUFLcUIscUJBQUwsQ0FBMkJ0QixZQUEzQixLQUNGLE9BQUtpQixrQkFBTCxDQUF3QmpCLFlBQXhCLEVBQXNDa0IsVUFBdEMsQ0FERSxJQUVGLE9BQUtNLG1CQUFMLENBQXlCeEIsWUFBekIsQ0FGZjs7QUFJQSxnQkFBSUMsUUFBSixFQUNJLE1BQU0sT0FBS0wsY0FBTCxDQUFvQkksWUFBcEIsRUFBa0NrQyxJQUFsQyxFQUFOOztBQUVKLG1CQUFPakMsUUFBUDtBQWI2QjtBQWNoQyxLQWhJVTs7QUFrSVhrQyxjQUFXO0FBQ1AsZUFBT0MsaUJBQVFDLEdBQVIsQ0FBWSxzQkFBYyxLQUFLekMsY0FBbkIsRUFBbUNvQixHQUFuQyxDQUF1Q3NCLFFBQVFBLEtBQUtILE9BQUwsRUFBL0MsQ0FBWixDQUFQO0FBQ0g7QUFwSVUsQyIsImZpbGUiOiJicm93c2VyL3Byb3ZpZGVyL3Bvb2wuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUHJvbWlzZSBmcm9tICdwaW5raWUnO1xuaW1wb3J0IEJVSUxUX0lOX1BST1ZJREVSUyBmcm9tICcuL2J1aWx0LWluJztcbmltcG9ydCBCcm93c2VyUHJvdmlkZXJQbHVnaW5Ib3N0IGZyb20gJy4vcGx1Z2luLWhvc3QnO1xuaW1wb3J0IHBhcnNlUHJvdmlkZXJOYW1lIGZyb20gJy4vcGFyc2UtcHJvdmlkZXItbmFtZSc7XG5pbXBvcnQgQnJvd3NlclByb3ZpZGVyIGZyb20gJy4vJztcbmltcG9ydCBCcm93c2VyQ29ubmVjdGlvbiBmcm9tICcuLi9jb25uZWN0aW9uJztcbmltcG9ydCB7IEdlbmVyYWxFcnJvciB9IGZyb20gJy4uLy4uL2Vycm9ycy9ydW50aW1lJztcbmltcG9ydCBNRVNTQUdFIGZyb20gJy4uLy4uL2Vycm9ycy9ydW50aW1lL21lc3NhZ2UnO1xuXG5jb25zdCBCUk9XU0VSX1BST1ZJREVSX1JFID0gL14oW146XFxzXSspOj8oLiopPyQvO1xuXG5leHBvcnQgZGVmYXVsdCB7XG4gICAgcHJvdmlkZXJzQ2FjaGU6IHt9LFxuXG4gICAgYXN5bmMgX2hhbmRsZVBhdGhBbmRDbWQgKGFsaWFzKSB7XG4gICAgICAgIGNvbnN0IGJyb3dzZXJOYW1lICA9IEpTT04uc3RyaW5naWZ5KGFsaWFzKTtcbiAgICAgICAgY29uc3QgcHJvdmlkZXJOYW1lID0gJ3BhdGgnO1xuICAgICAgICBjb25zdCBwcm92aWRlciAgICAgPSBhd2FpdCB0aGlzLmdldFByb3ZpZGVyKHByb3ZpZGVyTmFtZSk7XG5cbiAgICAgICAgcmV0dXJuIHsgcHJvdmlkZXIsIHByb3ZpZGVyTmFtZSwgYnJvd3Nlck5hbWUgfTtcbiAgICB9LFxuXG4gICAgYXN5bmMgX3BhcnNlQWxpYXNTdHJpbmcgKGFsaWFzKSB7XG4gICAgICAgIGNvbnN0IHByb3ZpZGVyUmVnRXhwTWF0Y2ggPSBCUk9XU0VSX1BST1ZJREVSX1JFLmV4ZWMoYWxpYXMpO1xuXG4gICAgICAgIGlmICghcHJvdmlkZXJSZWdFeHBNYXRjaClcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoTUVTU0FHRS5jYW50RmluZEJyb3dzZXIsIGFsaWFzKTtcblxuICAgICAgICBsZXQgcHJvdmlkZXJOYW1lID0gcHJvdmlkZXJSZWdFeHBNYXRjaFsxXTtcbiAgICAgICAgbGV0IGJyb3dzZXJOYW1lICA9IHByb3ZpZGVyUmVnRXhwTWF0Y2hbMl0gfHwgJyc7XG5cbiAgICAgICAgbGV0IHByb3ZpZGVyID0gYXdhaXQgdGhpcy5nZXRQcm92aWRlcihwcm92aWRlck5hbWUpO1xuXG4gICAgICAgIGlmICghcHJvdmlkZXIgJiYgcHJvdmlkZXJSZWdFeHBNYXRjaFsyXSlcbiAgICAgICAgICAgIHByb3ZpZGVyID0gYXdhaXQgdGhpcy5nZXRQcm92aWRlcihwcm92aWRlck5hbWUgKyAnOicpO1xuXG4gICAgICAgIGlmICghcHJvdmlkZXIpIHtcbiAgICAgICAgICAgIHByb3ZpZGVyTmFtZSA9ICdsb2NhbGx5LWluc3RhbGxlZCc7XG4gICAgICAgICAgICBwcm92aWRlciAgICAgPSBhd2FpdCB0aGlzLmdldFByb3ZpZGVyKHByb3ZpZGVyTmFtZSk7XG4gICAgICAgICAgICBicm93c2VyTmFtZSAgPSBwcm92aWRlclJlZ0V4cE1hdGNoWzFdIHx8ICcnO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHsgcHJvdmlkZXIsIHByb3ZpZGVyTmFtZSwgYnJvd3Nlck5hbWUgfTtcbiAgICB9LFxuXG4gICAgYXN5bmMgX3BhcnNlQWxpYXMgKGFsaWFzKSB7XG4gICAgICAgIGlmIChhbGlhcyAmJiBhbGlhcy5wYXRoKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZVBhdGhBbmRDbWQoYWxpYXMpO1xuXG4gICAgICAgIGlmICh0eXBlb2YgYWxpYXMgPT09ICdzdHJpbmcnKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlQWxpYXNTdHJpbmcoYWxpYXMpO1xuXG4gICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoTUVTU0FHRS5jYW50RmluZEJyb3dzZXIsIGFsaWFzKTtcbiAgICB9LFxuXG4gICAgYXN5bmMgX2dldEluZm9Gb3JBbGxCcm93c2VyTmFtZXMgKHByb3ZpZGVyLCBwcm92aWRlck5hbWUpIHtcbiAgICAgICAgY29uc3QgYWxsQnJvd3Nlck5hbWVzID0gcHJvdmlkZXIuaXNNdWx0aUJyb3dzZXIgP1xuICAgICAgICAgICAgYXdhaXQgcHJvdmlkZXIuZ2V0QnJvd3Nlckxpc3QoKSA6XG4gICAgICAgICAgICBbXTtcblxuICAgICAgICBpZiAoIWFsbEJyb3dzZXJOYW1lcy5sZW5ndGgpXG4gICAgICAgICAgICByZXR1cm4geyBwcm92aWRlciwgcHJvdmlkZXJOYW1lLCBicm93c2VyTmFtZTogJycgfTtcblxuICAgICAgICByZXR1cm4gYWxsQnJvd3Nlck5hbWVzXG4gICAgICAgICAgICAubWFwKGJyb3dzZXJOYW1lID0+ICh7IHByb3ZpZGVyLCBwcm92aWRlck5hbWUsIGJyb3dzZXJOYW1lIH0pKTtcbiAgICB9LFxuXG4gICAgX2dldFByb3ZpZGVyTW9kdWxlIChwcm92aWRlck5hbWUsIG1vZHVsZU5hbWUpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHByb3ZpZGVyT2JqZWN0ID0gcmVxdWlyZShtb2R1bGVOYW1lKTtcblxuICAgICAgICAgICAgdGhpcy5hZGRQcm92aWRlcihwcm92aWRlck5hbWUsIHByb3ZpZGVyT2JqZWN0KTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9nZXRQcm92aWRlckZyb21DYWNoZShwcm92aWRlck5hbWUpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBfZ2V0UHJvdmlkZXJGcm9tQ2FjaGUgKHByb3ZpZGVyTmFtZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm92aWRlcnNDYWNoZVtwcm92aWRlck5hbWVdIHx8IG51bGw7XG4gICAgfSxcblxuICAgIF9nZXRCdWlsdGluUHJvdmlkZXIgKHByb3ZpZGVyTmFtZSkge1xuICAgICAgICBjb25zdCBwcm92aWRlck9iamVjdCA9IEJVSUxUX0lOX1BST1ZJREVSU1twcm92aWRlck5hbWVdO1xuXG4gICAgICAgIGlmICghcHJvdmlkZXJPYmplY3QpXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcblxuICAgICAgICB0aGlzLmFkZFByb3ZpZGVyKHByb3ZpZGVyTmFtZSwgcHJvdmlkZXJPYmplY3QpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLl9nZXRQcm92aWRlckZyb21DYWNoZShwcm92aWRlck5hbWUpO1xuICAgIH0sXG5cbiAgICBhc3luYyBnZXRCcm93c2VySW5mbyAoYWxpYXMpIHtcbiAgICAgICAgaWYgKGFsaWFzIGluc3RhbmNlb2YgQnJvd3NlckNvbm5lY3Rpb24pXG4gICAgICAgICAgICByZXR1cm4gYWxpYXM7XG5cbiAgICAgICAgY29uc3QgYnJvd3NlckluZm8gPSBhd2FpdCB0aGlzLl9wYXJzZUFsaWFzKGFsaWFzKTtcblxuICAgICAgICBjb25zdCB7IHByb3ZpZGVyLCBwcm92aWRlck5hbWUsIGJyb3dzZXJOYW1lIH0gPSBicm93c2VySW5mbztcblxuICAgICAgICBpZiAoYnJvd3Nlck5hbWUgPT09ICdhbGwnKVxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2dldEluZm9Gb3JBbGxCcm93c2VyTmFtZXMocHJvdmlkZXIsIHByb3ZpZGVyTmFtZSk7XG5cbiAgICAgICAgaWYgKCFhd2FpdCBwcm92aWRlci5pc1ZhbGlkQnJvd3Nlck5hbWUoYnJvd3Nlck5hbWUpKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihNRVNTQUdFLmNhbnRGaW5kQnJvd3NlciwgYWxpYXMpO1xuXG4gICAgICAgIHJldHVybiB7IGFsaWFzLCAuLi5icm93c2VySW5mbyB9O1xuICAgIH0sXG5cbiAgICBhZGRQcm92aWRlciAocHJvdmlkZXJOYW1lLCBwcm92aWRlck9iamVjdCkge1xuICAgICAgICBwcm92aWRlck5hbWUgPSBwYXJzZVByb3ZpZGVyTmFtZShwcm92aWRlck5hbWUpLnByb3ZpZGVyTmFtZTtcblxuICAgICAgICB0aGlzLnByb3ZpZGVyc0NhY2hlW3Byb3ZpZGVyTmFtZV0gPSBuZXcgQnJvd3NlclByb3ZpZGVyKFxuICAgICAgICAgICAgbmV3IEJyb3dzZXJQcm92aWRlclBsdWdpbkhvc3QocHJvdmlkZXJPYmplY3QsIHByb3ZpZGVyTmFtZSlcbiAgICAgICAgKTtcbiAgICB9LFxuXG4gICAgcmVtb3ZlUHJvdmlkZXIgKHByb3ZpZGVyTmFtZSkge1xuICAgICAgICBwcm92aWRlck5hbWUgPSBwYXJzZVByb3ZpZGVyTmFtZShwcm92aWRlck5hbWUpLnByb3ZpZGVyTmFtZTtcblxuICAgICAgICBkZWxldGUgdGhpcy5wcm92aWRlcnNDYWNoZVtwcm92aWRlck5hbWVdO1xuICAgIH0sXG5cbiAgICBhc3luYyBnZXRQcm92aWRlciAocHJvdmlkZXJOYW1lKSB7XG4gICAgICAgIGNvbnN0IHBhcnNlZFByb3ZpZGVyTmFtZSA9IHBhcnNlUHJvdmlkZXJOYW1lKHByb3ZpZGVyTmFtZSk7XG4gICAgICAgIGNvbnN0IG1vZHVsZU5hbWUgICAgICAgICA9IHBhcnNlZFByb3ZpZGVyTmFtZS5tb2R1bGVOYW1lO1xuXG4gICAgICAgIHByb3ZpZGVyTmFtZSA9IHBhcnNlZFByb3ZpZGVyTmFtZS5wcm92aWRlck5hbWU7XG5cbiAgICAgICAgY29uc3QgcHJvdmlkZXIgPSB0aGlzLl9nZXRQcm92aWRlckZyb21DYWNoZShwcm92aWRlck5hbWUpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2dldFByb3ZpZGVyTW9kdWxlKHByb3ZpZGVyTmFtZSwgbW9kdWxlTmFtZSkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZ2V0QnVpbHRpblByb3ZpZGVyKHByb3ZpZGVyTmFtZSk7XG5cbiAgICAgICAgaWYgKHByb3ZpZGVyKVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5wcm92aWRlcnNDYWNoZVtwcm92aWRlck5hbWVdLmluaXQoKTtcblxuICAgICAgICByZXR1cm4gcHJvdmlkZXI7XG4gICAgfSxcblxuICAgIGRpc3Bvc2UgKCkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoT2JqZWN0LnZhbHVlcyh0aGlzLnByb3ZpZGVyc0NhY2hlKS5tYXAoaXRlbSA9PiBpdGVtLmRpc3Bvc2UoKSkpO1xuICAgIH1cbn07XG4iXX0=
