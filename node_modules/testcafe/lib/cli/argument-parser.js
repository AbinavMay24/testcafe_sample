'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _commander = require('commander');

var _dedent = require('dedent');

var _dedent2 = _interopRequireDefault(_dedent);

var _readFileRelative = require('read-file-relative');

var _runtime = require('../errors/runtime');

var _message = require('../errors/runtime/message');

var _message2 = _interopRequireDefault(_message);

var _typeAssertions = require('../errors/runtime/type-assertions');

var _getViewportWidth = require('../utils/get-viewport-width');

var _getViewportWidth2 = _interopRequireDefault(_getViewportWidth);

var _string = require('../utils/string');

var _getOptions = require('../utils/get-options');

var _getFilterFn = require('../utils/get-filter-fn');

var _getFilterFn2 = _interopRequireDefault(_getFilterFn);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const REMOTE_ALIAS_RE = /^remote(?::(\d*))?$/;

const DESCRIPTION = (0, _dedent2.default)(`
    In the browser list, you can use browser names (e.g. "ie", "chrome", etc.) as well as paths to executables.

    To run tests against all installed browsers, use the "all" alias.

    To use a remote browser connection (e.g., to connect a mobile device), specify "remote" as the browser alias.
    If you need to connect multiple devices, add a colon and the number of browsers you want to connect (e.g., "remote:3").

    To run tests in a browser accessed through a browser provider plugin, specify a browser alias that consists of two parts - the browser provider name prefix and the name of the browser itself; for example, "saucelabs:chrome@51".

    You can use one or more file paths or glob patterns to specify which tests to run.

    More info: https://devexpress.github.io/testcafe/documentation
`);

class CLIArgumentParser {
    constructor(cwd) {
        this.program = new _commander.Command('testcafe');

        this.cwd = cwd || process.cwd();

        this.src = null;
        this.browsers = null;
        this.filter = null;
        this.remoteCount = 0;
        this.opts = null;

        this._describeProgram();
    }

    static _parsePortNumber(value) {
        (0, _typeAssertions.assertType)(_typeAssertions.is.nonNegativeNumberString, null, 'Port number', value);

        return parseInt(value, 10);
    }

    static _getDescription() {
        // NOTE: add empty line to workaround commander-forced indentation on the first line.
        return '\n' + (0, _string.wordWrap)(DESCRIPTION, 2, (0, _getViewportWidth2.default)(process.stdout));
    }

    _describeProgram() {
        const version = JSON.parse((0, _readFileRelative.readSync)('../../package.json')).version;

        this.program.version(version, '-v, --version').usage('[options] <comma-separated-browser-list> <file-or-glob ...>').description(CLIArgumentParser._getDescription()).option('-b, --list-browsers [provider]', 'output the aliases for local browsers or browsers available through the specified browser provider').option('-r, --reporter <name[:outputFile][,...]>', 'specify the reporters and optionally files where reports are saved').option('-s, --screenshots <path>', 'enable screenshot capturing and specify the path to save the screenshots to').option('-S, --screenshots-on-fails', 'take a screenshot whenever a test fails').option('-p, --screenshot-path-pattern <pattern>', 'use patterns to compose screenshot file names and paths: ${BROWSER}, ${BROWSER_VERSION}, ${OS}, etc.').option('-q, --quarantine-mode', 'enable the quarantine mode').option('-d, --debug-mode', 'execute test steps one by one pausing the test after each step').option('-e, --skip-js-errors', 'make tests not fail when a JS error happens on a page').option('-u, --skip-uncaught-errors', 'ignore uncaught errors and unhandled promise rejections, which occur during test execution').option('-t, --test <name>', 'run only tests with the specified name').option('-T, --test-grep <pattern>', 'run only tests matching the specified pattern').option('-f, --fixture <name>', 'run only fixtures with the specified name').option('-F, --fixture-grep <pattern>', 'run only fixtures matching the specified pattern').option('-a, --app <command>', 'launch the tested app using the specified command before running tests').option('-c, --concurrency <number>', 'run tests concurrently').option('-L, --live', 'enable live mode. In this mode, TestCafe watches for changes you make in the test files. These changes immediately restart the tests so that you can see the effect.').option('--test-meta <key=value[,key2=value2,...]>', 'run only tests with matching metadata').option('--fixture-meta <key=value[,key2=value2,...]>', 'run only fixtures with matching metadata').option('--debug-on-fail', 'pause the test if it fails').option('--app-init-delay <ms>', 'specify how much time it takes for the tested app to initialize').option('--selector-timeout <ms>', 'set the amount of time within which selectors make attempts to obtain a node to be returned').option('--assertion-timeout <ms>', 'set the amount of time within which assertion should pass').option('--page-load-timeout <ms>', 'set the amount of time within which TestCafe waits for the `window.load` event to fire on page load before proceeding to the next test action').option('--speed <factor>', 'set the speed of test execution (0.01 ... 1)').option('--ports <port1,port2>', 'specify custom port numbers').option('--hostname <name>', 'specify the hostname').option('--proxy <host>', 'specify the host of the proxy server').option('--proxy-bypass <rules>', 'specify a comma-separated list of rules that define URLs accessed bypassing the proxy server').option('--ssl <options>', 'specify SSL options to run TestCafe proxy server over the HTTPS protocol').option('--video <path>', ' record videos of test runs').option('--video-options <option=value[,...]>', 'specify video recording options').option('--video-encoding-options <option=value[,...]>', 'specify encoding options').option('--disable-page-reloads', 'disable page reloads between tests').option('--dev', 'enables mechanisms to log and diagnose errors').option('--qr-code', 'outputs QR-code that repeats URLs used to connect the remote browsers').option('--sf, --stop-on-first-fail', 'stop an entire test run if any test fails')

        // NOTE: these options will be handled by chalk internally
        .option('--color', 'force colors in command line').option('--no-color', 'disable colors in command line');
    }

    _filterAndCountRemotes(browser) {
        const remoteMatch = browser.match(REMOTE_ALIAS_RE);

        if (remoteMatch) {
            this.remoteCount += parseInt(remoteMatch[1], 10) || 1;
            return false;
        }

        return true;
    }

    _parseFilteringOptions() {
        this.filter = (0, _getFilterFn2.default)(this.opts);
    }

    _parseAppInitDelay() {
        if (this.opts.appInitDelay) {
            (0, _typeAssertions.assertType)(_typeAssertions.is.nonNegativeNumberString, null, 'Tested app initialization delay', this.opts.appInitDelay);

            this.opts.appInitDelay = parseInt(this.opts.appInitDelay, 10);
        }
    }

    _parseSelectorTimeout() {
        if (this.opts.selectorTimeout) {
            (0, _typeAssertions.assertType)(_typeAssertions.is.nonNegativeNumberString, null, 'Selector timeout', this.opts.selectorTimeout);

            this.opts.selectorTimeout = parseInt(this.opts.selectorTimeout, 10);
        }
    }

    _parseAssertionTimeout() {
        if (this.opts.assertionTimeout) {
            (0, _typeAssertions.assertType)(_typeAssertions.is.nonNegativeNumberString, null, 'Assertion timeout', this.opts.assertionTimeout);

            this.opts.assertionTimeout = parseInt(this.opts.assertionTimeout, 10);
        }
    }

    _parsePageLoadTimeout() {
        if (this.opts.pageLoadTimeout) {
            (0, _typeAssertions.assertType)(_typeAssertions.is.nonNegativeNumberString, null, 'Page load timeout', this.opts.pageLoadTimeout);

            this.opts.pageLoadTimeout = parseInt(this.opts.pageLoadTimeout, 10);
        }
    }

    _parseSpeed() {
        if (this.opts.speed) this.opts.speed = parseFloat(this.opts.speed);
    }

    _parseConcurrency() {
        if (this.opts.concurrency) this.opts.concurrency = parseInt(this.opts.concurrency, 10);
    }

    _parsePorts() {
        if (this.opts.ports) {
            this.opts.ports = this.opts.ports.split(',').map(CLIArgumentParser._parsePortNumber);

            if (this.opts.ports.length < 2) throw new _runtime.GeneralError(_message2.default.portsOptionRequiresTwoNumbers);
        }
    }

    _parseBrowserList() {
        const browsersArg = this.program.args[0] || '';

        this.browsers = (0, _string.splitQuotedText)(browsersArg, ',').filter(browser => browser && this._filterAndCountRemotes(browser));
    }

    _parseSslOptions() {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this.opts.ssl) _this.opts.ssl = yield (0, _getOptions.getSSLOptions)(_this.opts.ssl);
        })();
    }

    _parseReporters() {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const reporters = _this2.opts.reporter ? _this2.opts.reporter.split(',') : [];

            _this2.opts.reporter = reporters.map(function (reporter) {
                const separatorIndex = reporter.indexOf(':');

                if (separatorIndex < 0) return { name: reporter };

                const name = reporter.substring(0, separatorIndex);
                const output = reporter.substring(separatorIndex + 1);

                return { name, output };
            });
        })();
    }

    _parseFileList() {
        this.src = this.program.args.slice(1);
    }

    _parseVideoOptions() {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            _this3.opts.videoOptions = typeof _this3.opts.videoOptions === 'string' ? yield (0, _getOptions.getVideoOptions)(_this3.opts.videoOptions) : null;
            _this3.opts.videoEncodingOptions = typeof _this3.opts.videoEncodingOptions === 'string' ? yield (0, _getOptions.getVideoOptions)(_this3.opts.videoEncodingOptions) : null;
        })();
    }

    _getProviderName() {
        this.opts.providerName = this.opts.listBrowsers === true ? void 0 : this.opts.listBrowsers;
    }

    parse(argv) {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            _this4.program.parse(argv);

            _this4.opts = _this4.program.opts();

            // NOTE: the '-list-browsers' option only lists browsers and immediately exits the app.
            // Therefore, we don't need to process other arguments.
            if (_this4.opts.listBrowsers) {
                _this4._getProviderName();
                return;
            }

            _this4._parseFilteringOptions();
            _this4._parseSelectorTimeout();
            _this4._parseAssertionTimeout();
            _this4._parsePageLoadTimeout();
            _this4._parseAppInitDelay();
            _this4._parseSpeed();
            _this4._parsePorts();
            _this4._parseBrowserList();
            _this4._parseConcurrency();
            _this4._parseFileList();

            yield _this4._parseVideoOptions();
            yield _this4._parseSslOptions();
            yield _this4._parseReporters();
        })();
    }
}
exports.default = CLIArgumentParser;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvYXJndW1lbnQtcGFyc2VyLmpzIl0sIm5hbWVzIjpbIlJFTU9URV9BTElBU19SRSIsIkRFU0NSSVBUSU9OIiwiQ0xJQXJndW1lbnRQYXJzZXIiLCJjb25zdHJ1Y3RvciIsImN3ZCIsInByb2dyYW0iLCJDb21tYW5kIiwicHJvY2VzcyIsInNyYyIsImJyb3dzZXJzIiwiZmlsdGVyIiwicmVtb3RlQ291bnQiLCJvcHRzIiwiX2Rlc2NyaWJlUHJvZ3JhbSIsIl9wYXJzZVBvcnROdW1iZXIiLCJ2YWx1ZSIsImlzIiwibm9uTmVnYXRpdmVOdW1iZXJTdHJpbmciLCJwYXJzZUludCIsIl9nZXREZXNjcmlwdGlvbiIsInN0ZG91dCIsInZlcnNpb24iLCJKU09OIiwicGFyc2UiLCJ1c2FnZSIsImRlc2NyaXB0aW9uIiwib3B0aW9uIiwiX2ZpbHRlckFuZENvdW50UmVtb3RlcyIsImJyb3dzZXIiLCJyZW1vdGVNYXRjaCIsIm1hdGNoIiwiX3BhcnNlRmlsdGVyaW5nT3B0aW9ucyIsIl9wYXJzZUFwcEluaXREZWxheSIsImFwcEluaXREZWxheSIsIl9wYXJzZVNlbGVjdG9yVGltZW91dCIsInNlbGVjdG9yVGltZW91dCIsIl9wYXJzZUFzc2VydGlvblRpbWVvdXQiLCJhc3NlcnRpb25UaW1lb3V0IiwiX3BhcnNlUGFnZUxvYWRUaW1lb3V0IiwicGFnZUxvYWRUaW1lb3V0IiwiX3BhcnNlU3BlZWQiLCJzcGVlZCIsInBhcnNlRmxvYXQiLCJfcGFyc2VDb25jdXJyZW5jeSIsImNvbmN1cnJlbmN5IiwiX3BhcnNlUG9ydHMiLCJwb3J0cyIsInNwbGl0IiwibWFwIiwibGVuZ3RoIiwiR2VuZXJhbEVycm9yIiwiTUVTU0FHRSIsInBvcnRzT3B0aW9uUmVxdWlyZXNUd29OdW1iZXJzIiwiX3BhcnNlQnJvd3Nlckxpc3QiLCJicm93c2Vyc0FyZyIsImFyZ3MiLCJfcGFyc2VTc2xPcHRpb25zIiwic3NsIiwiX3BhcnNlUmVwb3J0ZXJzIiwicmVwb3J0ZXJzIiwicmVwb3J0ZXIiLCJzZXBhcmF0b3JJbmRleCIsImluZGV4T2YiLCJuYW1lIiwic3Vic3RyaW5nIiwib3V0cHV0IiwiX3BhcnNlRmlsZUxpc3QiLCJzbGljZSIsIl9wYXJzZVZpZGVvT3B0aW9ucyIsInZpZGVvT3B0aW9ucyIsInZpZGVvRW5jb2RpbmdPcHRpb25zIiwiX2dldFByb3ZpZGVyTmFtZSIsInByb3ZpZGVyTmFtZSIsImxpc3RCcm93c2VycyIsImFyZ3YiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUVBLE1BQU1BLGtCQUFrQixxQkFBeEI7O0FBRUEsTUFBTUMsY0FBYyxzQkFBUTs7Ozs7Ozs7Ozs7OztDQUFSLENBQXBCOztBQWVlLE1BQU1DLGlCQUFOLENBQXdCO0FBQ25DQyxnQkFBYUMsR0FBYixFQUFrQjtBQUNkLGFBQUtDLE9BQUwsR0FBZSxJQUFJQyxrQkFBSixDQUFZLFVBQVosQ0FBZjs7QUFFQSxhQUFLRixHQUFMLEdBQVdBLE9BQU9HLFFBQVFILEdBQVIsRUFBbEI7O0FBRUEsYUFBS0ksR0FBTCxHQUFtQixJQUFuQjtBQUNBLGFBQUtDLFFBQUwsR0FBbUIsSUFBbkI7QUFDQSxhQUFLQyxNQUFMLEdBQW1CLElBQW5CO0FBQ0EsYUFBS0MsV0FBTCxHQUFtQixDQUFuQjtBQUNBLGFBQUtDLElBQUwsR0FBbUIsSUFBbkI7O0FBRUEsYUFBS0MsZ0JBQUw7QUFDSDs7QUFFRCxXQUFPQyxnQkFBUCxDQUF5QkMsS0FBekIsRUFBZ0M7QUFDNUIsd0NBQVdDLG1CQUFHQyx1QkFBZCxFQUF1QyxJQUF2QyxFQUE2QyxhQUE3QyxFQUE0REYsS0FBNUQ7O0FBRUEsZUFBT0csU0FBU0gsS0FBVCxFQUFnQixFQUFoQixDQUFQO0FBQ0g7O0FBRUQsV0FBT0ksZUFBUCxHQUEwQjtBQUN0QjtBQUNBLGVBQU8sT0FBTyxzQkFBU2xCLFdBQVQsRUFBc0IsQ0FBdEIsRUFBeUIsZ0NBQWlCTSxRQUFRYSxNQUF6QixDQUF6QixDQUFkO0FBQ0g7O0FBRURQLHVCQUFvQjtBQUNoQixjQUFNUSxVQUFVQyxLQUFLQyxLQUFMLENBQVcsZ0NBQUssb0JBQUwsQ0FBWCxFQUF1Q0YsT0FBdkQ7O0FBRUEsYUFBS2hCLE9BQUwsQ0FDS2dCLE9BREwsQ0FDYUEsT0FEYixFQUNzQixlQUR0QixFQUVLRyxLQUZMLENBRVcsNkRBRlgsRUFHS0MsV0FITCxDQUdpQnZCLGtCQUFrQmlCLGVBQWxCLEVBSGpCLEVBS0tPLE1BTEwsQ0FLWSxnQ0FMWixFQUs4QyxvR0FMOUMsRUFNS0EsTUFOTCxDQU1ZLDBDQU5aLEVBTXdELG9FQU54RCxFQU9LQSxNQVBMLENBT1ksMEJBUFosRUFPd0MsNkVBUHhDLEVBUUtBLE1BUkwsQ0FRWSw0QkFSWixFQVEwQyx5Q0FSMUMsRUFTS0EsTUFUTCxDQVNZLHlDQVRaLEVBU3VELHNHQVR2RCxFQVVLQSxNQVZMLENBVVksdUJBVlosRUFVcUMsNEJBVnJDLEVBV0tBLE1BWEwsQ0FXWSxrQkFYWixFQVdnQyxnRUFYaEMsRUFZS0EsTUFaTCxDQVlZLHNCQVpaLEVBWW9DLHVEQVpwQyxFQWFLQSxNQWJMLENBYVksNEJBYlosRUFhMEMsNEZBYjFDLEVBY0tBLE1BZEwsQ0FjWSxtQkFkWixFQWNpQyx3Q0FkakMsRUFlS0EsTUFmTCxDQWVZLDJCQWZaLEVBZXlDLCtDQWZ6QyxFQWdCS0EsTUFoQkwsQ0FnQlksc0JBaEJaLEVBZ0JvQywyQ0FoQnBDLEVBaUJLQSxNQWpCTCxDQWlCWSw4QkFqQlosRUFpQjRDLGtEQWpCNUMsRUFrQktBLE1BbEJMLENBa0JZLHFCQWxCWixFQWtCbUMsd0VBbEJuQyxFQW1CS0EsTUFuQkwsQ0FtQlksNEJBbkJaLEVBbUIwQyx3QkFuQjFDLEVBb0JLQSxNQXBCTCxDQW9CWSxZQXBCWixFQW9CMEIsc0tBcEIxQixFQXFCS0EsTUFyQkwsQ0FxQlksMkNBckJaLEVBcUJ5RCx1Q0FyQnpELEVBc0JLQSxNQXRCTCxDQXNCWSw4Q0F0QlosRUFzQjRELDBDQXRCNUQsRUF1QktBLE1BdkJMLENBdUJZLGlCQXZCWixFQXVCK0IsNEJBdkIvQixFQXdCS0EsTUF4QkwsQ0F3QlksdUJBeEJaLEVBd0JxQyxpRUF4QnJDLEVBeUJLQSxNQXpCTCxDQXlCWSx5QkF6QlosRUF5QnVDLDZGQXpCdkMsRUEwQktBLE1BMUJMLENBMEJZLDBCQTFCWixFQTBCd0MsMkRBMUJ4QyxFQTJCS0EsTUEzQkwsQ0EyQlksMEJBM0JaLEVBMkJ3QywrSUEzQnhDLEVBNEJLQSxNQTVCTCxDQTRCWSxrQkE1QlosRUE0QmdDLDhDQTVCaEMsRUE2QktBLE1BN0JMLENBNkJZLHVCQTdCWixFQTZCcUMsNkJBN0JyQyxFQThCS0EsTUE5QkwsQ0E4QlksbUJBOUJaLEVBOEJpQyxzQkE5QmpDLEVBK0JLQSxNQS9CTCxDQStCWSxnQkEvQlosRUErQjhCLHNDQS9COUIsRUFnQ0tBLE1BaENMLENBZ0NZLHdCQWhDWixFQWdDc0MsOEZBaEN0QyxFQWlDS0EsTUFqQ0wsQ0FpQ1ksaUJBakNaLEVBaUMrQiwwRUFqQy9CLEVBa0NLQSxNQWxDTCxDQWtDWSxnQkFsQ1osRUFrQzhCLDZCQWxDOUIsRUFtQ0tBLE1BbkNMLENBbUNZLHNDQW5DWixFQW1Db0QsaUNBbkNwRCxFQW9DS0EsTUFwQ0wsQ0FvQ1ksK0NBcENaLEVBb0M2RCwwQkFwQzdELEVBcUNLQSxNQXJDTCxDQXFDWSx3QkFyQ1osRUFxQ3NDLG9DQXJDdEMsRUFzQ0tBLE1BdENMLENBc0NZLE9BdENaLEVBc0NxQiwrQ0F0Q3JCLEVBdUNLQSxNQXZDTCxDQXVDWSxXQXZDWixFQXVDeUIsdUVBdkN6QixFQXdDS0EsTUF4Q0wsQ0F3Q1ksNEJBeENaLEVBd0MwQywyQ0F4QzFDOztBQTBDSTtBQTFDSixTQTJDS0EsTUEzQ0wsQ0EyQ1ksU0EzQ1osRUEyQ3VCLDhCQTNDdkIsRUE0Q0tBLE1BNUNMLENBNENZLFlBNUNaLEVBNEMwQixnQ0E1QzFCO0FBNkNIOztBQUVEQywyQkFBd0JDLE9BQXhCLEVBQWlDO0FBQzdCLGNBQU1DLGNBQWNELFFBQVFFLEtBQVIsQ0FBYzlCLGVBQWQsQ0FBcEI7O0FBRUEsWUFBSTZCLFdBQUosRUFBaUI7QUFDYixpQkFBS2xCLFdBQUwsSUFBb0JPLFNBQVNXLFlBQVksQ0FBWixDQUFULEVBQXlCLEVBQXpCLEtBQWdDLENBQXBEO0FBQ0EsbUJBQU8sS0FBUDtBQUNIOztBQUVELGVBQU8sSUFBUDtBQUNIOztBQUVERSw2QkFBMEI7QUFDdEIsYUFBS3JCLE1BQUwsR0FBYywyQkFBWSxLQUFLRSxJQUFqQixDQUFkO0FBQ0g7O0FBRURvQix5QkFBc0I7QUFDbEIsWUFBSSxLQUFLcEIsSUFBTCxDQUFVcUIsWUFBZCxFQUE0QjtBQUN4Qiw0Q0FBV2pCLG1CQUFHQyx1QkFBZCxFQUF1QyxJQUF2QyxFQUE2QyxpQ0FBN0MsRUFBZ0YsS0FBS0wsSUFBTCxDQUFVcUIsWUFBMUY7O0FBRUEsaUJBQUtyQixJQUFMLENBQVVxQixZQUFWLEdBQXlCZixTQUFTLEtBQUtOLElBQUwsQ0FBVXFCLFlBQW5CLEVBQWlDLEVBQWpDLENBQXpCO0FBQ0g7QUFDSjs7QUFFREMsNEJBQXlCO0FBQ3JCLFlBQUksS0FBS3RCLElBQUwsQ0FBVXVCLGVBQWQsRUFBK0I7QUFDM0IsNENBQVduQixtQkFBR0MsdUJBQWQsRUFBdUMsSUFBdkMsRUFBNkMsa0JBQTdDLEVBQWlFLEtBQUtMLElBQUwsQ0FBVXVCLGVBQTNFOztBQUVBLGlCQUFLdkIsSUFBTCxDQUFVdUIsZUFBVixHQUE0QmpCLFNBQVMsS0FBS04sSUFBTCxDQUFVdUIsZUFBbkIsRUFBb0MsRUFBcEMsQ0FBNUI7QUFDSDtBQUNKOztBQUVEQyw2QkFBMEI7QUFDdEIsWUFBSSxLQUFLeEIsSUFBTCxDQUFVeUIsZ0JBQWQsRUFBZ0M7QUFDNUIsNENBQVdyQixtQkFBR0MsdUJBQWQsRUFBdUMsSUFBdkMsRUFBNkMsbUJBQTdDLEVBQWtFLEtBQUtMLElBQUwsQ0FBVXlCLGdCQUE1RTs7QUFFQSxpQkFBS3pCLElBQUwsQ0FBVXlCLGdCQUFWLEdBQTZCbkIsU0FBUyxLQUFLTixJQUFMLENBQVV5QixnQkFBbkIsRUFBcUMsRUFBckMsQ0FBN0I7QUFDSDtBQUNKOztBQUVEQyw0QkFBeUI7QUFDckIsWUFBSSxLQUFLMUIsSUFBTCxDQUFVMkIsZUFBZCxFQUErQjtBQUMzQiw0Q0FBV3ZCLG1CQUFHQyx1QkFBZCxFQUF1QyxJQUF2QyxFQUE2QyxtQkFBN0MsRUFBa0UsS0FBS0wsSUFBTCxDQUFVMkIsZUFBNUU7O0FBRUEsaUJBQUszQixJQUFMLENBQVUyQixlQUFWLEdBQTRCckIsU0FBUyxLQUFLTixJQUFMLENBQVUyQixlQUFuQixFQUFvQyxFQUFwQyxDQUE1QjtBQUNIO0FBQ0o7O0FBRURDLGtCQUFlO0FBQ1gsWUFBSSxLQUFLNUIsSUFBTCxDQUFVNkIsS0FBZCxFQUNJLEtBQUs3QixJQUFMLENBQVU2QixLQUFWLEdBQWtCQyxXQUFXLEtBQUs5QixJQUFMLENBQVU2QixLQUFyQixDQUFsQjtBQUNQOztBQUVERSx3QkFBcUI7QUFDakIsWUFBSSxLQUFLL0IsSUFBTCxDQUFVZ0MsV0FBZCxFQUNJLEtBQUtoQyxJQUFMLENBQVVnQyxXQUFWLEdBQXdCMUIsU0FBUyxLQUFLTixJQUFMLENBQVVnQyxXQUFuQixFQUFnQyxFQUFoQyxDQUF4QjtBQUNQOztBQUVEQyxrQkFBZTtBQUNYLFlBQUksS0FBS2pDLElBQUwsQ0FBVWtDLEtBQWQsRUFBcUI7QUFDakIsaUJBQUtsQyxJQUFMLENBQVVrQyxLQUFWLEdBQWtCLEtBQUtsQyxJQUFMLENBQVVrQyxLQUFWLENBQ2JDLEtBRGEsQ0FDUCxHQURPLEVBRWJDLEdBRmEsQ0FFVDlDLGtCQUFrQlksZ0JBRlQsQ0FBbEI7O0FBSUEsZ0JBQUksS0FBS0YsSUFBTCxDQUFVa0MsS0FBVixDQUFnQkcsTUFBaEIsR0FBeUIsQ0FBN0IsRUFDSSxNQUFNLElBQUlDLHFCQUFKLENBQWlCQyxrQkFBUUMsNkJBQXpCLENBQU47QUFDUDtBQUNKOztBQUVEQyx3QkFBcUI7QUFDakIsY0FBTUMsY0FBYyxLQUFLakQsT0FBTCxDQUFha0QsSUFBYixDQUFrQixDQUFsQixLQUF3QixFQUE1Qzs7QUFFQSxhQUFLOUMsUUFBTCxHQUFnQiw2QkFBZ0I2QyxXQUFoQixFQUE2QixHQUE3QixFQUNYNUMsTUFEVyxDQUNKa0IsV0FBV0EsV0FBVyxLQUFLRCxzQkFBTCxDQUE0QkMsT0FBNUIsQ0FEbEIsQ0FBaEI7QUFFSDs7QUFFSzRCLG9CQUFOLEdBQTBCO0FBQUE7O0FBQUE7QUFDdEIsZ0JBQUksTUFBSzVDLElBQUwsQ0FBVTZDLEdBQWQsRUFDSSxNQUFLN0MsSUFBTCxDQUFVNkMsR0FBVixHQUFnQixNQUFNLCtCQUFjLE1BQUs3QyxJQUFMLENBQVU2QyxHQUF4QixDQUF0QjtBQUZrQjtBQUd6Qjs7QUFFS0MsbUJBQU4sR0FBeUI7QUFBQTs7QUFBQTtBQUNyQixrQkFBTUMsWUFBWSxPQUFLL0MsSUFBTCxDQUFVZ0QsUUFBVixHQUFxQixPQUFLaEQsSUFBTCxDQUFVZ0QsUUFBVixDQUFtQmIsS0FBbkIsQ0FBeUIsR0FBekIsQ0FBckIsR0FBcUQsRUFBdkU7O0FBRUEsbUJBQUtuQyxJQUFMLENBQVVnRCxRQUFWLEdBQXFCRCxVQUFVWCxHQUFWLENBQWMsb0JBQVk7QUFDM0Msc0JBQU1hLGlCQUFpQkQsU0FBU0UsT0FBVCxDQUFpQixHQUFqQixDQUF2Qjs7QUFFQSxvQkFBSUQsaUJBQWlCLENBQXJCLEVBQ0ksT0FBTyxFQUFFRSxNQUFNSCxRQUFSLEVBQVA7O0FBRUosc0JBQU1HLE9BQVNILFNBQVNJLFNBQVQsQ0FBbUIsQ0FBbkIsRUFBc0JILGNBQXRCLENBQWY7QUFDQSxzQkFBTUksU0FBU0wsU0FBU0ksU0FBVCxDQUFtQkgsaUJBQWlCLENBQXBDLENBQWY7O0FBRUEsdUJBQU8sRUFBRUUsSUFBRixFQUFRRSxNQUFSLEVBQVA7QUFDSCxhQVZvQixDQUFyQjtBQUhxQjtBQWN4Qjs7QUFFREMscUJBQWtCO0FBQ2QsYUFBSzFELEdBQUwsR0FBVyxLQUFLSCxPQUFMLENBQWFrRCxJQUFiLENBQWtCWSxLQUFsQixDQUF3QixDQUF4QixDQUFYO0FBQ0g7O0FBRUtDLHNCQUFOLEdBQTRCO0FBQUE7O0FBQUE7QUFDeEIsbUJBQUt4RCxJQUFMLENBQVV5RCxZQUFWLEdBQWlDLE9BQU8sT0FBS3pELElBQUwsQ0FBVXlELFlBQWpCLEtBQWtDLFFBQWxDLEdBQTZDLE1BQU0saUNBQWdCLE9BQUt6RCxJQUFMLENBQVV5RCxZQUExQixDQUFuRCxHQUE2RixJQUE5SDtBQUNBLG1CQUFLekQsSUFBTCxDQUFVMEQsb0JBQVYsR0FBaUMsT0FBTyxPQUFLMUQsSUFBTCxDQUFVMEQsb0JBQWpCLEtBQTBDLFFBQTFDLEdBQXFELE1BQU0saUNBQWdCLE9BQUsxRCxJQUFMLENBQVUwRCxvQkFBMUIsQ0FBM0QsR0FBNkcsSUFBOUk7QUFGd0I7QUFHM0I7O0FBRURDLHVCQUFvQjtBQUNoQixhQUFLM0QsSUFBTCxDQUFVNEQsWUFBVixHQUF5QixLQUFLNUQsSUFBTCxDQUFVNkQsWUFBVixLQUEyQixJQUEzQixHQUFrQyxLQUFLLENBQXZDLEdBQTJDLEtBQUs3RCxJQUFMLENBQVU2RCxZQUE5RTtBQUNIOztBQUVLbEQsU0FBTixDQUFhbUQsSUFBYixFQUFtQjtBQUFBOztBQUFBO0FBQ2YsbUJBQUtyRSxPQUFMLENBQWFrQixLQUFiLENBQW1CbUQsSUFBbkI7O0FBRUEsbUJBQUs5RCxJQUFMLEdBQVksT0FBS1AsT0FBTCxDQUFhTyxJQUFiLEVBQVo7O0FBRUE7QUFDQTtBQUNBLGdCQUFJLE9BQUtBLElBQUwsQ0FBVTZELFlBQWQsRUFBNEI7QUFDeEIsdUJBQUtGLGdCQUFMO0FBQ0E7QUFDSDs7QUFFRCxtQkFBS3hDLHNCQUFMO0FBQ0EsbUJBQUtHLHFCQUFMO0FBQ0EsbUJBQUtFLHNCQUFMO0FBQ0EsbUJBQUtFLHFCQUFMO0FBQ0EsbUJBQUtOLGtCQUFMO0FBQ0EsbUJBQUtRLFdBQUw7QUFDQSxtQkFBS0ssV0FBTDtBQUNBLG1CQUFLUSxpQkFBTDtBQUNBLG1CQUFLVixpQkFBTDtBQUNBLG1CQUFLdUIsY0FBTDs7QUFFQSxrQkFBTSxPQUFLRSxrQkFBTCxFQUFOO0FBQ0Esa0JBQU0sT0FBS1osZ0JBQUwsRUFBTjtBQUNBLGtCQUFNLE9BQUtFLGVBQUwsRUFBTjtBQXpCZTtBQTBCbEI7QUFuTmtDO2tCQUFsQnhELGlCIiwiZmlsZSI6ImNsaS9hcmd1bWVudC1wYXJzZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21tYW5kIH0gZnJvbSAnY29tbWFuZGVyJztcbmltcG9ydCBkZWRlbnQgZnJvbSAnZGVkZW50JztcbmltcG9ydCB7IHJlYWRTeW5jIGFzIHJlYWQgfSBmcm9tICdyZWFkLWZpbGUtcmVsYXRpdmUnO1xuaW1wb3J0IHsgR2VuZXJhbEVycm9yIH0gZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUnO1xuaW1wb3J0IE1FU1NBR0UgZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUvbWVzc2FnZSc7XG5pbXBvcnQgeyBhc3NlcnRUeXBlLCBpcyB9IGZyb20gJy4uL2Vycm9ycy9ydW50aW1lL3R5cGUtYXNzZXJ0aW9ucyc7XG5pbXBvcnQgZ2V0Vmlld1BvcnRXaWR0aCBmcm9tICcuLi91dGlscy9nZXQtdmlld3BvcnQtd2lkdGgnO1xuaW1wb3J0IHsgd29yZFdyYXAsIHNwbGl0UXVvdGVkVGV4dCB9IGZyb20gJy4uL3V0aWxzL3N0cmluZyc7XG5pbXBvcnQgeyBnZXRTU0xPcHRpb25zLCBnZXRWaWRlb09wdGlvbnMgfSBmcm9tICcuLi91dGlscy9nZXQtb3B0aW9ucyc7XG5pbXBvcnQgZ2V0RmlsdGVyRm4gZnJvbSAnLi4vdXRpbHMvZ2V0LWZpbHRlci1mbic7XG5cbmNvbnN0IFJFTU9URV9BTElBU19SRSA9IC9ecmVtb3RlKD86OihcXGQqKSk/JC87XG5cbmNvbnN0IERFU0NSSVBUSU9OID0gZGVkZW50KGBcbiAgICBJbiB0aGUgYnJvd3NlciBsaXN0LCB5b3UgY2FuIHVzZSBicm93c2VyIG5hbWVzIChlLmcuIFwiaWVcIiwgXCJjaHJvbWVcIiwgZXRjLikgYXMgd2VsbCBhcyBwYXRocyB0byBleGVjdXRhYmxlcy5cblxuICAgIFRvIHJ1biB0ZXN0cyBhZ2FpbnN0IGFsbCBpbnN0YWxsZWQgYnJvd3NlcnMsIHVzZSB0aGUgXCJhbGxcIiBhbGlhcy5cblxuICAgIFRvIHVzZSBhIHJlbW90ZSBicm93c2VyIGNvbm5lY3Rpb24gKGUuZy4sIHRvIGNvbm5lY3QgYSBtb2JpbGUgZGV2aWNlKSwgc3BlY2lmeSBcInJlbW90ZVwiIGFzIHRoZSBicm93c2VyIGFsaWFzLlxuICAgIElmIHlvdSBuZWVkIHRvIGNvbm5lY3QgbXVsdGlwbGUgZGV2aWNlcywgYWRkIGEgY29sb24gYW5kIHRoZSBudW1iZXIgb2YgYnJvd3NlcnMgeW91IHdhbnQgdG8gY29ubmVjdCAoZS5nLiwgXCJyZW1vdGU6M1wiKS5cblxuICAgIFRvIHJ1biB0ZXN0cyBpbiBhIGJyb3dzZXIgYWNjZXNzZWQgdGhyb3VnaCBhIGJyb3dzZXIgcHJvdmlkZXIgcGx1Z2luLCBzcGVjaWZ5IGEgYnJvd3NlciBhbGlhcyB0aGF0IGNvbnNpc3RzIG9mIHR3byBwYXJ0cyAtIHRoZSBicm93c2VyIHByb3ZpZGVyIG5hbWUgcHJlZml4IGFuZCB0aGUgbmFtZSBvZiB0aGUgYnJvd3NlciBpdHNlbGY7IGZvciBleGFtcGxlLCBcInNhdWNlbGFiczpjaHJvbWVANTFcIi5cblxuICAgIFlvdSBjYW4gdXNlIG9uZSBvciBtb3JlIGZpbGUgcGF0aHMgb3IgZ2xvYiBwYXR0ZXJucyB0byBzcGVjaWZ5IHdoaWNoIHRlc3RzIHRvIHJ1bi5cblxuICAgIE1vcmUgaW5mbzogaHR0cHM6Ly9kZXZleHByZXNzLmdpdGh1Yi5pby90ZXN0Y2FmZS9kb2N1bWVudGF0aW9uXG5gKTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ0xJQXJndW1lbnRQYXJzZXIge1xuICAgIGNvbnN0cnVjdG9yIChjd2QpIHtcbiAgICAgICAgdGhpcy5wcm9ncmFtID0gbmV3IENvbW1hbmQoJ3Rlc3RjYWZlJyk7XG5cbiAgICAgICAgdGhpcy5jd2QgPSBjd2QgfHwgcHJvY2Vzcy5jd2QoKTtcblxuICAgICAgICB0aGlzLnNyYyAgICAgICAgID0gbnVsbDtcbiAgICAgICAgdGhpcy5icm93c2VycyAgICA9IG51bGw7XG4gICAgICAgIHRoaXMuZmlsdGVyICAgICAgPSBudWxsO1xuICAgICAgICB0aGlzLnJlbW90ZUNvdW50ID0gMDtcbiAgICAgICAgdGhpcy5vcHRzICAgICAgICA9IG51bGw7XG5cbiAgICAgICAgdGhpcy5fZGVzY3JpYmVQcm9ncmFtKCk7XG4gICAgfVxuXG4gICAgc3RhdGljIF9wYXJzZVBvcnROdW1iZXIgKHZhbHVlKSB7XG4gICAgICAgIGFzc2VydFR5cGUoaXMubm9uTmVnYXRpdmVOdW1iZXJTdHJpbmcsIG51bGwsICdQb3J0IG51bWJlcicsIHZhbHVlKTtcblxuICAgICAgICByZXR1cm4gcGFyc2VJbnQodmFsdWUsIDEwKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX2dldERlc2NyaXB0aW9uICgpIHtcbiAgICAgICAgLy8gTk9URTogYWRkIGVtcHR5IGxpbmUgdG8gd29ya2Fyb3VuZCBjb21tYW5kZXItZm9yY2VkIGluZGVudGF0aW9uIG9uIHRoZSBmaXJzdCBsaW5lLlxuICAgICAgICByZXR1cm4gJ1xcbicgKyB3b3JkV3JhcChERVNDUklQVElPTiwgMiwgZ2V0Vmlld1BvcnRXaWR0aChwcm9jZXNzLnN0ZG91dCkpO1xuICAgIH1cblxuICAgIF9kZXNjcmliZVByb2dyYW0gKCkge1xuICAgICAgICBjb25zdCB2ZXJzaW9uID0gSlNPTi5wYXJzZShyZWFkKCcuLi8uLi9wYWNrYWdlLmpzb24nKSkudmVyc2lvbjtcblxuICAgICAgICB0aGlzLnByb2dyYW1cbiAgICAgICAgICAgIC52ZXJzaW9uKHZlcnNpb24sICctdiwgLS12ZXJzaW9uJylcbiAgICAgICAgICAgIC51c2FnZSgnW29wdGlvbnNdIDxjb21tYS1zZXBhcmF0ZWQtYnJvd3Nlci1saXN0PiA8ZmlsZS1vci1nbG9iIC4uLj4nKVxuICAgICAgICAgICAgLmRlc2NyaXB0aW9uKENMSUFyZ3VtZW50UGFyc2VyLl9nZXREZXNjcmlwdGlvbigpKVxuXG4gICAgICAgICAgICAub3B0aW9uKCctYiwgLS1saXN0LWJyb3dzZXJzIFtwcm92aWRlcl0nLCAnb3V0cHV0IHRoZSBhbGlhc2VzIGZvciBsb2NhbCBicm93c2VycyBvciBicm93c2VycyBhdmFpbGFibGUgdGhyb3VnaCB0aGUgc3BlY2lmaWVkIGJyb3dzZXIgcHJvdmlkZXInKVxuICAgICAgICAgICAgLm9wdGlvbignLXIsIC0tcmVwb3J0ZXIgPG5hbWVbOm91dHB1dEZpbGVdWywuLi5dPicsICdzcGVjaWZ5IHRoZSByZXBvcnRlcnMgYW5kIG9wdGlvbmFsbHkgZmlsZXMgd2hlcmUgcmVwb3J0cyBhcmUgc2F2ZWQnKVxuICAgICAgICAgICAgLm9wdGlvbignLXMsIC0tc2NyZWVuc2hvdHMgPHBhdGg+JywgJ2VuYWJsZSBzY3JlZW5zaG90IGNhcHR1cmluZyBhbmQgc3BlY2lmeSB0aGUgcGF0aCB0byBzYXZlIHRoZSBzY3JlZW5zaG90cyB0bycpXG4gICAgICAgICAgICAub3B0aW9uKCctUywgLS1zY3JlZW5zaG90cy1vbi1mYWlscycsICd0YWtlIGEgc2NyZWVuc2hvdCB3aGVuZXZlciBhIHRlc3QgZmFpbHMnKVxuICAgICAgICAgICAgLm9wdGlvbignLXAsIC0tc2NyZWVuc2hvdC1wYXRoLXBhdHRlcm4gPHBhdHRlcm4+JywgJ3VzZSBwYXR0ZXJucyB0byBjb21wb3NlIHNjcmVlbnNob3QgZmlsZSBuYW1lcyBhbmQgcGF0aHM6ICR7QlJPV1NFUn0sICR7QlJPV1NFUl9WRVJTSU9OfSwgJHtPU30sIGV0Yy4nKVxuICAgICAgICAgICAgLm9wdGlvbignLXEsIC0tcXVhcmFudGluZS1tb2RlJywgJ2VuYWJsZSB0aGUgcXVhcmFudGluZSBtb2RlJylcbiAgICAgICAgICAgIC5vcHRpb24oJy1kLCAtLWRlYnVnLW1vZGUnLCAnZXhlY3V0ZSB0ZXN0IHN0ZXBzIG9uZSBieSBvbmUgcGF1c2luZyB0aGUgdGVzdCBhZnRlciBlYWNoIHN0ZXAnKVxuICAgICAgICAgICAgLm9wdGlvbignLWUsIC0tc2tpcC1qcy1lcnJvcnMnLCAnbWFrZSB0ZXN0cyBub3QgZmFpbCB3aGVuIGEgSlMgZXJyb3IgaGFwcGVucyBvbiBhIHBhZ2UnKVxuICAgICAgICAgICAgLm9wdGlvbignLXUsIC0tc2tpcC11bmNhdWdodC1lcnJvcnMnLCAnaWdub3JlIHVuY2F1Z2h0IGVycm9ycyBhbmQgdW5oYW5kbGVkIHByb21pc2UgcmVqZWN0aW9ucywgd2hpY2ggb2NjdXIgZHVyaW5nIHRlc3QgZXhlY3V0aW9uJylcbiAgICAgICAgICAgIC5vcHRpb24oJy10LCAtLXRlc3QgPG5hbWU+JywgJ3J1biBvbmx5IHRlc3RzIHdpdGggdGhlIHNwZWNpZmllZCBuYW1lJylcbiAgICAgICAgICAgIC5vcHRpb24oJy1ULCAtLXRlc3QtZ3JlcCA8cGF0dGVybj4nLCAncnVuIG9ubHkgdGVzdHMgbWF0Y2hpbmcgdGhlIHNwZWNpZmllZCBwYXR0ZXJuJylcbiAgICAgICAgICAgIC5vcHRpb24oJy1mLCAtLWZpeHR1cmUgPG5hbWU+JywgJ3J1biBvbmx5IGZpeHR1cmVzIHdpdGggdGhlIHNwZWNpZmllZCBuYW1lJylcbiAgICAgICAgICAgIC5vcHRpb24oJy1GLCAtLWZpeHR1cmUtZ3JlcCA8cGF0dGVybj4nLCAncnVuIG9ubHkgZml4dHVyZXMgbWF0Y2hpbmcgdGhlIHNwZWNpZmllZCBwYXR0ZXJuJylcbiAgICAgICAgICAgIC5vcHRpb24oJy1hLCAtLWFwcCA8Y29tbWFuZD4nLCAnbGF1bmNoIHRoZSB0ZXN0ZWQgYXBwIHVzaW5nIHRoZSBzcGVjaWZpZWQgY29tbWFuZCBiZWZvcmUgcnVubmluZyB0ZXN0cycpXG4gICAgICAgICAgICAub3B0aW9uKCctYywgLS1jb25jdXJyZW5jeSA8bnVtYmVyPicsICdydW4gdGVzdHMgY29uY3VycmVudGx5JylcbiAgICAgICAgICAgIC5vcHRpb24oJy1MLCAtLWxpdmUnLCAnZW5hYmxlIGxpdmUgbW9kZS4gSW4gdGhpcyBtb2RlLCBUZXN0Q2FmZSB3YXRjaGVzIGZvciBjaGFuZ2VzIHlvdSBtYWtlIGluIHRoZSB0ZXN0IGZpbGVzLiBUaGVzZSBjaGFuZ2VzIGltbWVkaWF0ZWx5IHJlc3RhcnQgdGhlIHRlc3RzIHNvIHRoYXQgeW91IGNhbiBzZWUgdGhlIGVmZmVjdC4nKVxuICAgICAgICAgICAgLm9wdGlvbignLS10ZXN0LW1ldGEgPGtleT12YWx1ZVssa2V5Mj12YWx1ZTIsLi4uXT4nLCAncnVuIG9ubHkgdGVzdHMgd2l0aCBtYXRjaGluZyBtZXRhZGF0YScpXG4gICAgICAgICAgICAub3B0aW9uKCctLWZpeHR1cmUtbWV0YSA8a2V5PXZhbHVlWyxrZXkyPXZhbHVlMiwuLi5dPicsICdydW4gb25seSBmaXh0dXJlcyB3aXRoIG1hdGNoaW5nIG1ldGFkYXRhJylcbiAgICAgICAgICAgIC5vcHRpb24oJy0tZGVidWctb24tZmFpbCcsICdwYXVzZSB0aGUgdGVzdCBpZiBpdCBmYWlscycpXG4gICAgICAgICAgICAub3B0aW9uKCctLWFwcC1pbml0LWRlbGF5IDxtcz4nLCAnc3BlY2lmeSBob3cgbXVjaCB0aW1lIGl0IHRha2VzIGZvciB0aGUgdGVzdGVkIGFwcCB0byBpbml0aWFsaXplJylcbiAgICAgICAgICAgIC5vcHRpb24oJy0tc2VsZWN0b3ItdGltZW91dCA8bXM+JywgJ3NldCB0aGUgYW1vdW50IG9mIHRpbWUgd2l0aGluIHdoaWNoIHNlbGVjdG9ycyBtYWtlIGF0dGVtcHRzIHRvIG9idGFpbiBhIG5vZGUgdG8gYmUgcmV0dXJuZWQnKVxuICAgICAgICAgICAgLm9wdGlvbignLS1hc3NlcnRpb24tdGltZW91dCA8bXM+JywgJ3NldCB0aGUgYW1vdW50IG9mIHRpbWUgd2l0aGluIHdoaWNoIGFzc2VydGlvbiBzaG91bGQgcGFzcycpXG4gICAgICAgICAgICAub3B0aW9uKCctLXBhZ2UtbG9hZC10aW1lb3V0IDxtcz4nLCAnc2V0IHRoZSBhbW91bnQgb2YgdGltZSB3aXRoaW4gd2hpY2ggVGVzdENhZmUgd2FpdHMgZm9yIHRoZSBgd2luZG93LmxvYWRgIGV2ZW50IHRvIGZpcmUgb24gcGFnZSBsb2FkIGJlZm9yZSBwcm9jZWVkaW5nIHRvIHRoZSBuZXh0IHRlc3QgYWN0aW9uJylcbiAgICAgICAgICAgIC5vcHRpb24oJy0tc3BlZWQgPGZhY3Rvcj4nLCAnc2V0IHRoZSBzcGVlZCBvZiB0ZXN0IGV4ZWN1dGlvbiAoMC4wMSAuLi4gMSknKVxuICAgICAgICAgICAgLm9wdGlvbignLS1wb3J0cyA8cG9ydDEscG9ydDI+JywgJ3NwZWNpZnkgY3VzdG9tIHBvcnQgbnVtYmVycycpXG4gICAgICAgICAgICAub3B0aW9uKCctLWhvc3RuYW1lIDxuYW1lPicsICdzcGVjaWZ5IHRoZSBob3N0bmFtZScpXG4gICAgICAgICAgICAub3B0aW9uKCctLXByb3h5IDxob3N0PicsICdzcGVjaWZ5IHRoZSBob3N0IG9mIHRoZSBwcm94eSBzZXJ2ZXInKVxuICAgICAgICAgICAgLm9wdGlvbignLS1wcm94eS1ieXBhc3MgPHJ1bGVzPicsICdzcGVjaWZ5IGEgY29tbWEtc2VwYXJhdGVkIGxpc3Qgb2YgcnVsZXMgdGhhdCBkZWZpbmUgVVJMcyBhY2Nlc3NlZCBieXBhc3NpbmcgdGhlIHByb3h5IHNlcnZlcicpXG4gICAgICAgICAgICAub3B0aW9uKCctLXNzbCA8b3B0aW9ucz4nLCAnc3BlY2lmeSBTU0wgb3B0aW9ucyB0byBydW4gVGVzdENhZmUgcHJveHkgc2VydmVyIG92ZXIgdGhlIEhUVFBTIHByb3RvY29sJylcbiAgICAgICAgICAgIC5vcHRpb24oJy0tdmlkZW8gPHBhdGg+JywgJyByZWNvcmQgdmlkZW9zIG9mIHRlc3QgcnVucycpXG4gICAgICAgICAgICAub3B0aW9uKCctLXZpZGVvLW9wdGlvbnMgPG9wdGlvbj12YWx1ZVssLi4uXT4nLCAnc3BlY2lmeSB2aWRlbyByZWNvcmRpbmcgb3B0aW9ucycpXG4gICAgICAgICAgICAub3B0aW9uKCctLXZpZGVvLWVuY29kaW5nLW9wdGlvbnMgPG9wdGlvbj12YWx1ZVssLi4uXT4nLCAnc3BlY2lmeSBlbmNvZGluZyBvcHRpb25zJylcbiAgICAgICAgICAgIC5vcHRpb24oJy0tZGlzYWJsZS1wYWdlLXJlbG9hZHMnLCAnZGlzYWJsZSBwYWdlIHJlbG9hZHMgYmV0d2VlbiB0ZXN0cycpXG4gICAgICAgICAgICAub3B0aW9uKCctLWRldicsICdlbmFibGVzIG1lY2hhbmlzbXMgdG8gbG9nIGFuZCBkaWFnbm9zZSBlcnJvcnMnKVxuICAgICAgICAgICAgLm9wdGlvbignLS1xci1jb2RlJywgJ291dHB1dHMgUVItY29kZSB0aGF0IHJlcGVhdHMgVVJMcyB1c2VkIHRvIGNvbm5lY3QgdGhlIHJlbW90ZSBicm93c2VycycpXG4gICAgICAgICAgICAub3B0aW9uKCctLXNmLCAtLXN0b3Atb24tZmlyc3QtZmFpbCcsICdzdG9wIGFuIGVudGlyZSB0ZXN0IHJ1biBpZiBhbnkgdGVzdCBmYWlscycpXG5cbiAgICAgICAgICAgIC8vIE5PVEU6IHRoZXNlIG9wdGlvbnMgd2lsbCBiZSBoYW5kbGVkIGJ5IGNoYWxrIGludGVybmFsbHlcbiAgICAgICAgICAgIC5vcHRpb24oJy0tY29sb3InLCAnZm9yY2UgY29sb3JzIGluIGNvbW1hbmQgbGluZScpXG4gICAgICAgICAgICAub3B0aW9uKCctLW5vLWNvbG9yJywgJ2Rpc2FibGUgY29sb3JzIGluIGNvbW1hbmQgbGluZScpO1xuICAgIH1cblxuICAgIF9maWx0ZXJBbmRDb3VudFJlbW90ZXMgKGJyb3dzZXIpIHtcbiAgICAgICAgY29uc3QgcmVtb3RlTWF0Y2ggPSBicm93c2VyLm1hdGNoKFJFTU9URV9BTElBU19SRSk7XG5cbiAgICAgICAgaWYgKHJlbW90ZU1hdGNoKSB7XG4gICAgICAgICAgICB0aGlzLnJlbW90ZUNvdW50ICs9IHBhcnNlSW50KHJlbW90ZU1hdGNoWzFdLCAxMCkgfHwgMTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIF9wYXJzZUZpbHRlcmluZ09wdGlvbnMgKCkge1xuICAgICAgICB0aGlzLmZpbHRlciA9IGdldEZpbHRlckZuKHRoaXMub3B0cyk7XG4gICAgfVxuXG4gICAgX3BhcnNlQXBwSW5pdERlbGF5ICgpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0cy5hcHBJbml0RGVsYXkpIHtcbiAgICAgICAgICAgIGFzc2VydFR5cGUoaXMubm9uTmVnYXRpdmVOdW1iZXJTdHJpbmcsIG51bGwsICdUZXN0ZWQgYXBwIGluaXRpYWxpemF0aW9uIGRlbGF5JywgdGhpcy5vcHRzLmFwcEluaXREZWxheSk7XG5cbiAgICAgICAgICAgIHRoaXMub3B0cy5hcHBJbml0RGVsYXkgPSBwYXJzZUludCh0aGlzLm9wdHMuYXBwSW5pdERlbGF5LCAxMCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfcGFyc2VTZWxlY3RvclRpbWVvdXQgKCkge1xuICAgICAgICBpZiAodGhpcy5vcHRzLnNlbGVjdG9yVGltZW91dCkge1xuICAgICAgICAgICAgYXNzZXJ0VHlwZShpcy5ub25OZWdhdGl2ZU51bWJlclN0cmluZywgbnVsbCwgJ1NlbGVjdG9yIHRpbWVvdXQnLCB0aGlzLm9wdHMuc2VsZWN0b3JUaW1lb3V0KTtcblxuICAgICAgICAgICAgdGhpcy5vcHRzLnNlbGVjdG9yVGltZW91dCA9IHBhcnNlSW50KHRoaXMub3B0cy5zZWxlY3RvclRpbWVvdXQsIDEwKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9wYXJzZUFzc2VydGlvblRpbWVvdXQgKCkge1xuICAgICAgICBpZiAodGhpcy5vcHRzLmFzc2VydGlvblRpbWVvdXQpIHtcbiAgICAgICAgICAgIGFzc2VydFR5cGUoaXMubm9uTmVnYXRpdmVOdW1iZXJTdHJpbmcsIG51bGwsICdBc3NlcnRpb24gdGltZW91dCcsIHRoaXMub3B0cy5hc3NlcnRpb25UaW1lb3V0KTtcblxuICAgICAgICAgICAgdGhpcy5vcHRzLmFzc2VydGlvblRpbWVvdXQgPSBwYXJzZUludCh0aGlzLm9wdHMuYXNzZXJ0aW9uVGltZW91dCwgMTApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgX3BhcnNlUGFnZUxvYWRUaW1lb3V0ICgpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0cy5wYWdlTG9hZFRpbWVvdXQpIHtcbiAgICAgICAgICAgIGFzc2VydFR5cGUoaXMubm9uTmVnYXRpdmVOdW1iZXJTdHJpbmcsIG51bGwsICdQYWdlIGxvYWQgdGltZW91dCcsIHRoaXMub3B0cy5wYWdlTG9hZFRpbWVvdXQpO1xuXG4gICAgICAgICAgICB0aGlzLm9wdHMucGFnZUxvYWRUaW1lb3V0ID0gcGFyc2VJbnQodGhpcy5vcHRzLnBhZ2VMb2FkVGltZW91dCwgMTApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgX3BhcnNlU3BlZWQgKCkge1xuICAgICAgICBpZiAodGhpcy5vcHRzLnNwZWVkKVxuICAgICAgICAgICAgdGhpcy5vcHRzLnNwZWVkID0gcGFyc2VGbG9hdCh0aGlzLm9wdHMuc3BlZWQpO1xuICAgIH1cblxuICAgIF9wYXJzZUNvbmN1cnJlbmN5ICgpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0cy5jb25jdXJyZW5jeSlcbiAgICAgICAgICAgIHRoaXMub3B0cy5jb25jdXJyZW5jeSA9IHBhcnNlSW50KHRoaXMub3B0cy5jb25jdXJyZW5jeSwgMTApO1xuICAgIH1cblxuICAgIF9wYXJzZVBvcnRzICgpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0cy5wb3J0cykge1xuICAgICAgICAgICAgdGhpcy5vcHRzLnBvcnRzID0gdGhpcy5vcHRzLnBvcnRzXG4gICAgICAgICAgICAgICAgLnNwbGl0KCcsJylcbiAgICAgICAgICAgICAgICAubWFwKENMSUFyZ3VtZW50UGFyc2VyLl9wYXJzZVBvcnROdW1iZXIpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5vcHRzLnBvcnRzLmxlbmd0aCA8IDIpXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihNRVNTQUdFLnBvcnRzT3B0aW9uUmVxdWlyZXNUd29OdW1iZXJzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9wYXJzZUJyb3dzZXJMaXN0ICgpIHtcbiAgICAgICAgY29uc3QgYnJvd3NlcnNBcmcgPSB0aGlzLnByb2dyYW0uYXJnc1swXSB8fCAnJztcblxuICAgICAgICB0aGlzLmJyb3dzZXJzID0gc3BsaXRRdW90ZWRUZXh0KGJyb3dzZXJzQXJnLCAnLCcpXG4gICAgICAgICAgICAuZmlsdGVyKGJyb3dzZXIgPT4gYnJvd3NlciAmJiB0aGlzLl9maWx0ZXJBbmRDb3VudFJlbW90ZXMoYnJvd3NlcikpO1xuICAgIH1cblxuICAgIGFzeW5jIF9wYXJzZVNzbE9wdGlvbnMgKCkge1xuICAgICAgICBpZiAodGhpcy5vcHRzLnNzbClcbiAgICAgICAgICAgIHRoaXMub3B0cy5zc2wgPSBhd2FpdCBnZXRTU0xPcHRpb25zKHRoaXMub3B0cy5zc2wpO1xuICAgIH1cblxuICAgIGFzeW5jIF9wYXJzZVJlcG9ydGVycyAoKSB7XG4gICAgICAgIGNvbnN0IHJlcG9ydGVycyA9IHRoaXMub3B0cy5yZXBvcnRlciA/IHRoaXMub3B0cy5yZXBvcnRlci5zcGxpdCgnLCcpIDogW107XG5cbiAgICAgICAgdGhpcy5vcHRzLnJlcG9ydGVyID0gcmVwb3J0ZXJzLm1hcChyZXBvcnRlciA9PiB7XG4gICAgICAgICAgICBjb25zdCBzZXBhcmF0b3JJbmRleCA9IHJlcG9ydGVyLmluZGV4T2YoJzonKTtcblxuICAgICAgICAgICAgaWYgKHNlcGFyYXRvckluZGV4IDwgMClcbiAgICAgICAgICAgICAgICByZXR1cm4geyBuYW1lOiByZXBvcnRlciB9O1xuXG4gICAgICAgICAgICBjb25zdCBuYW1lICAgPSByZXBvcnRlci5zdWJzdHJpbmcoMCwgc2VwYXJhdG9ySW5kZXgpO1xuICAgICAgICAgICAgY29uc3Qgb3V0cHV0ID0gcmVwb3J0ZXIuc3Vic3RyaW5nKHNlcGFyYXRvckluZGV4ICsgMSk7XG5cbiAgICAgICAgICAgIHJldHVybiB7IG5hbWUsIG91dHB1dCB9O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfcGFyc2VGaWxlTGlzdCAoKSB7XG4gICAgICAgIHRoaXMuc3JjID0gdGhpcy5wcm9ncmFtLmFyZ3Muc2xpY2UoMSk7XG4gICAgfVxuXG4gICAgYXN5bmMgX3BhcnNlVmlkZW9PcHRpb25zICgpIHtcbiAgICAgICAgdGhpcy5vcHRzLnZpZGVvT3B0aW9ucyAgICAgICAgID0gdHlwZW9mIHRoaXMub3B0cy52aWRlb09wdGlvbnMgPT09ICdzdHJpbmcnID8gYXdhaXQgZ2V0VmlkZW9PcHRpb25zKHRoaXMub3B0cy52aWRlb09wdGlvbnMpIDogbnVsbDtcbiAgICAgICAgdGhpcy5vcHRzLnZpZGVvRW5jb2RpbmdPcHRpb25zID0gdHlwZW9mIHRoaXMub3B0cy52aWRlb0VuY29kaW5nT3B0aW9ucyA9PT0gJ3N0cmluZycgPyBhd2FpdCBnZXRWaWRlb09wdGlvbnModGhpcy5vcHRzLnZpZGVvRW5jb2RpbmdPcHRpb25zKSA6IG51bGw7XG4gICAgfVxuXG4gICAgX2dldFByb3ZpZGVyTmFtZSAoKSB7XG4gICAgICAgIHRoaXMub3B0cy5wcm92aWRlck5hbWUgPSB0aGlzLm9wdHMubGlzdEJyb3dzZXJzID09PSB0cnVlID8gdm9pZCAwIDogdGhpcy5vcHRzLmxpc3RCcm93c2VycztcbiAgICB9XG5cbiAgICBhc3luYyBwYXJzZSAoYXJndikge1xuICAgICAgICB0aGlzLnByb2dyYW0ucGFyc2UoYXJndik7XG5cbiAgICAgICAgdGhpcy5vcHRzID0gdGhpcy5wcm9ncmFtLm9wdHMoKTtcblxuICAgICAgICAvLyBOT1RFOiB0aGUgJy1saXN0LWJyb3dzZXJzJyBvcHRpb24gb25seSBsaXN0cyBicm93c2VycyBhbmQgaW1tZWRpYXRlbHkgZXhpdHMgdGhlIGFwcC5cbiAgICAgICAgLy8gVGhlcmVmb3JlLCB3ZSBkb24ndCBuZWVkIHRvIHByb2Nlc3Mgb3RoZXIgYXJndW1lbnRzLlxuICAgICAgICBpZiAodGhpcy5vcHRzLmxpc3RCcm93c2Vycykge1xuICAgICAgICAgICAgdGhpcy5fZ2V0UHJvdmlkZXJOYW1lKCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9wYXJzZUZpbHRlcmluZ09wdGlvbnMoKTtcbiAgICAgICAgdGhpcy5fcGFyc2VTZWxlY3RvclRpbWVvdXQoKTtcbiAgICAgICAgdGhpcy5fcGFyc2VBc3NlcnRpb25UaW1lb3V0KCk7XG4gICAgICAgIHRoaXMuX3BhcnNlUGFnZUxvYWRUaW1lb3V0KCk7XG4gICAgICAgIHRoaXMuX3BhcnNlQXBwSW5pdERlbGF5KCk7XG4gICAgICAgIHRoaXMuX3BhcnNlU3BlZWQoKTtcbiAgICAgICAgdGhpcy5fcGFyc2VQb3J0cygpO1xuICAgICAgICB0aGlzLl9wYXJzZUJyb3dzZXJMaXN0KCk7XG4gICAgICAgIHRoaXMuX3BhcnNlQ29uY3VycmVuY3koKTtcbiAgICAgICAgdGhpcy5fcGFyc2VGaWxlTGlzdCgpO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuX3BhcnNlVmlkZW9PcHRpb25zKCk7XG4gICAgICAgIGF3YWl0IHRoaXMuX3BhcnNlU3NsT3B0aW9ucygpO1xuICAgICAgICBhd2FpdCB0aGlzLl9wYXJzZVJlcG9ydGVycygpO1xuICAgIH1cbn1cbiJdfQ==
