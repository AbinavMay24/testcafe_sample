'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _entries = require('babel-runtime/core-js/object/entries');

var _entries2 = _interopRequireDefault(_entries);

var _create = require('babel-runtime/core-js/object/create');

var _create2 = _interopRequireDefault(_create);

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _promisifiedFunctions = require('../utils/promisified-functions');

var _option = require('./option');

var _option2 = _interopRequireDefault(_option);

var _optionSource = require('./option-source');

var _optionSource2 = _interopRequireDefault(_optionSource);

var _lodash = require('lodash');

var _getOptions = require('../utils/get-options');

var _optionNames = require('./option-names');

var _optionNames2 = _interopRequireDefault(_optionNames);

var _getFilterFn = require('../utils/get-filter-fn');

var _getFilterFn2 = _interopRequireDefault(_getFilterFn);

var _resolvePathRelativelyCwd = require('../utils/resolve-path-relatively-cwd');

var _resolvePathRelativelyCwd2 = _interopRequireDefault(_resolvePathRelativelyCwd);

var _json = require('json5');

var _json2 = _interopRequireDefault(_json);

var _renderTemplate = require('../utils/render-template');

var _renderTemplate2 = _interopRequireDefault(_renderTemplate);

var _prepareReporters = require('../utils/prepare-reporters');

var _prepareReporters2 = _interopRequireDefault(_prepareReporters);

var _warningMessage = require('../notifications/warning-message');

var _warningMessage2 = _interopRequireDefault(_warningMessage);

var _log = require('../cli/log');

var _log2 = _interopRequireDefault(_log);

var _defaultValues = require('./default-values');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEBUG_LOGGER = (0, _debug2.default)('testcafe:configuration');

const CONFIGURATION_FILENAME = '.testcaferc.json';

const OPTION_FLAG_NAMES = [_optionNames2.default.skipJsErrors, _optionNames2.default.disablePageReloads, _optionNames2.default.quarantineMode, _optionNames2.default.debugMode, _optionNames2.default.debugOnFail, _optionNames2.default.skipUncaughtErrors, _optionNames2.default.stopOnFirstFail, _optionNames2.default.takeScreenshotsOnFails];

class Configuration {
    constructor() {
        this._options = {};
        this._filePath = (0, _resolvePathRelativelyCwd2.default)(CONFIGURATION_FILENAME);
        this._overridenOptions = [];
    }

    static _fromObj(obj) {
        const result = (0, _create2.default)(null);

        (0, _entries2.default)(obj).forEach(([key, value]) => {
            const option = new _option2.default(key, value);

            result[key] = option;
        });

        return result;
    }

    static _isConfigurationFileExists(path) {
        return (0, _asyncToGenerator3.default)(function* () {
            try {
                yield (0, _promisifiedFunctions.stat)(path);

                return true;
            } catch (error) {
                DEBUG_LOGGER((0, _renderTemplate2.default)(_warningMessage2.default.cannotFindConfigurationFile, path, error.stack));

                return false;
            }
        })();
    }

    static _showConsoleWarning(message) {
        _log2.default.write(message);
    }

    static _showWarningForError(error, warningTemplate, ...args) {
        const message = (0, _renderTemplate2.default)(warningTemplate, ...args);

        Configuration._showConsoleWarning(message);

        DEBUG_LOGGER(message);
        DEBUG_LOGGER(error);
    }

    _load() {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!(yield Configuration._isConfigurationFileExists(_this.filePath))) return;

            let configurationFileContent = null;

            try {
                configurationFileContent = yield (0, _promisifiedFunctions.readFile)(_this.filePath);
            } catch (error) {
                Configuration._showWarningForError(error, _warningMessage2.default.cannotReadConfigFile);

                return;
            }

            try {
                const optionsObj = _json2.default.parse(configurationFileContent);

                _this._options = Configuration._fromObj(optionsObj);
            } catch (error) {
                Configuration._showWarningForError(error, _warningMessage2.default.cannotParseConfigFile);

                return;
            }

            yield _this._normalizeOptionsAfterLoad();
        })();
    }

    _normalizeOptionsAfterLoad() {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this2._prepareSslOptions();
            _this2._prepareFilterFn();
            _this2._ensureArrayOption(_optionNames2.default.src);
            _this2._ensureArrayOption(_optionNames2.default.browsers);
            _this2._prepareReporters();
        })();
    }

    _ensureArrayOption(name) {
        const options = this._options[name];

        if (!options) return;

        options.value = (0, _lodash.castArray)(options.value);
    }

    _prepareFilterFn() {
        const filterOption = this._ensureOption(_optionNames2.default.filter, null);

        if (!filterOption.value) return;

        filterOption.value = (0, _getFilterFn2.default)(filterOption.value);
    }

    _prepareReporters() {
        const reporterOption = this._options[_optionNames2.default.reporter];

        if (!reporterOption) return;

        const optionValue = (0, _lodash.castArray)(reporterOption.value);

        reporterOption.value = (0, _prepareReporters2.default)(optionValue);
    }

    _prepareSslOptions() {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const sslOptions = _this3._options[_optionNames2.default.ssl];

            if (!sslOptions) return;

            sslOptions.value = yield (0, _getOptions.getSSLOptions)(sslOptions.value);
        })();
    }

    _ensureOption(name, value, source) {
        let option = null;

        if (name in this._options) option = this._options[name];else {
            option = new _option2.default(name, value, source);

            this._options[name] = option;
        }

        return option;
    }

    _ensureOptionWithValue(name, defaultValue, source) {
        const option = this._ensureOption(name, defaultValue, source);

        if (option.value !== void 0) return;

        option.value = defaultValue;
        option.source = source;
    }

    init(options = {}) {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this4._load();
            _this4.mergeOptions(options);
        })();
    }

    mergeOptions(options) {
        (0, _entries2.default)(options).map(([key, value]) => {
            const option = this._ensureOption(key, value, _optionSource2.default.input);

            if (value === void 0) return;

            if (option.value !== value && option.source === _optionSource2.default.configuration) this._overridenOptions.push(key);

            option.value = value;
            option.source = _optionSource2.default.input;
        });
    }

    _prepareFlags() {
        OPTION_FLAG_NAMES.forEach(name => {
            const option = this._ensureOption(name, void 0, _optionSource2.default.configuration);

            option.value = !!option.value;
        });
    }

    _setDefaultValues() {
        this._ensureOptionWithValue(_optionNames2.default.selectorTimeout, _defaultValues.DEFAULT_TIMEOUT.selector, _optionSource2.default.configuration);
        this._ensureOptionWithValue(_optionNames2.default.assertionTimeout, _defaultValues.DEFAULT_TIMEOUT.assertion, _optionSource2.default.configuration);
        this._ensureOptionWithValue(_optionNames2.default.pageLoadTimeout, _defaultValues.DEFAULT_TIMEOUT.pageLoad, _optionSource2.default.configuration);
        this._ensureOptionWithValue(_optionNames2.default.speed, _defaultValues.DEFAULT_SPEED_VALUE, _optionSource2.default.configuration);
        this._ensureOptionWithValue(_optionNames2.default.appInitDelay, _defaultValues.DEFAULT_APP_INIT_DELAY, _optionSource2.default.configuration);
        this._ensureOptionWithValue(_optionNames2.default.concurrency, _defaultValues.DEFAULT_CONCURRENCY_VALUE, _optionSource2.default.configuration);
    }

    prepare() {
        this._prepareFlags();
        this._setDefaultValues();
    }

    notifyAboutOverridenOptions() {
        if (!this._overridenOptions.length) return;

        const optionsStr = this._overridenOptions.map(option => `"${option}"`).join(', ');
        const optionsSuffix = this._overridenOptions.length > 1 ? 's' : '';

        Configuration._showConsoleWarning((0, _renderTemplate2.default)(_warningMessage2.default.configOptionsWereOverriden, optionsStr, optionsSuffix));

        this._overridenOptions = [];
    }

    getOption(key) {
        if (!key) return void 0;

        const option = this._options[key];

        if (!option) return void 0;

        return option.value;
    }

    getOptions() {
        const result = (0, _create2.default)(null);

        (0, _entries2.default)(this._options).forEach(([name, option]) => {
            result[name] = option.value;
        });

        return result;
    }

    clone() {
        return (0, _lodash.cloneDeep)(this);
    }

    get startOptions() {
        const result = {
            hostname: this.getOption('hostname'),
            port1: this.getOption('port1'),
            port2: this.getOption('port2'),
            options: {
                ssl: this.getOption('ssl'),
                developmentMode: this.getOption('developmentMode'),
                retryTestPages: !!this.getOption('retryTestPages')
            }
        };

        if (result.options.retryTestPages) result.options.staticContentCaching = _defaultValues.STATIC_CONTENT_CACHING_SETTINGS;

        return result;
    }

    get filePath() {
        return this._filePath;
    }
}
exports.default = Configuration;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb25maWd1cmF0aW9uL2luZGV4LmpzIl0sIm5hbWVzIjpbIkRFQlVHX0xPR0dFUiIsIkNPTkZJR1VSQVRJT05fRklMRU5BTUUiLCJPUFRJT05fRkxBR19OQU1FUyIsIk9QVElPTl9OQU1FUyIsInNraXBKc0Vycm9ycyIsImRpc2FibGVQYWdlUmVsb2FkcyIsInF1YXJhbnRpbmVNb2RlIiwiZGVidWdNb2RlIiwiZGVidWdPbkZhaWwiLCJza2lwVW5jYXVnaHRFcnJvcnMiLCJzdG9wT25GaXJzdEZhaWwiLCJ0YWtlU2NyZWVuc2hvdHNPbkZhaWxzIiwiQ29uZmlndXJhdGlvbiIsImNvbnN0cnVjdG9yIiwiX29wdGlvbnMiLCJfZmlsZVBhdGgiLCJfb3ZlcnJpZGVuT3B0aW9ucyIsIl9mcm9tT2JqIiwib2JqIiwicmVzdWx0IiwiZm9yRWFjaCIsImtleSIsInZhbHVlIiwib3B0aW9uIiwiT3B0aW9uIiwiX2lzQ29uZmlndXJhdGlvbkZpbGVFeGlzdHMiLCJwYXRoIiwiZXJyb3IiLCJXQVJOSU5HX01FU1NBR0VTIiwiY2Fubm90RmluZENvbmZpZ3VyYXRpb25GaWxlIiwic3RhY2siLCJfc2hvd0NvbnNvbGVXYXJuaW5nIiwibWVzc2FnZSIsImxvZyIsIndyaXRlIiwiX3Nob3dXYXJuaW5nRm9yRXJyb3IiLCJ3YXJuaW5nVGVtcGxhdGUiLCJhcmdzIiwiX2xvYWQiLCJmaWxlUGF0aCIsImNvbmZpZ3VyYXRpb25GaWxlQ29udGVudCIsImNhbm5vdFJlYWRDb25maWdGaWxlIiwib3B0aW9uc09iaiIsIkpTT041IiwicGFyc2UiLCJjYW5ub3RQYXJzZUNvbmZpZ0ZpbGUiLCJfbm9ybWFsaXplT3B0aW9uc0FmdGVyTG9hZCIsIl9wcmVwYXJlU3NsT3B0aW9ucyIsIl9wcmVwYXJlRmlsdGVyRm4iLCJfZW5zdXJlQXJyYXlPcHRpb24iLCJzcmMiLCJicm93c2VycyIsIl9wcmVwYXJlUmVwb3J0ZXJzIiwibmFtZSIsIm9wdGlvbnMiLCJmaWx0ZXJPcHRpb24iLCJfZW5zdXJlT3B0aW9uIiwiZmlsdGVyIiwicmVwb3J0ZXJPcHRpb24iLCJyZXBvcnRlciIsIm9wdGlvblZhbHVlIiwic3NsT3B0aW9ucyIsInNzbCIsInNvdXJjZSIsIl9lbnN1cmVPcHRpb25XaXRoVmFsdWUiLCJkZWZhdWx0VmFsdWUiLCJpbml0IiwibWVyZ2VPcHRpb25zIiwibWFwIiwib3B0aW9uU291cmNlIiwiaW5wdXQiLCJjb25maWd1cmF0aW9uIiwicHVzaCIsIl9wcmVwYXJlRmxhZ3MiLCJfc2V0RGVmYXVsdFZhbHVlcyIsInNlbGVjdG9yVGltZW91dCIsIkRFRkFVTFRfVElNRU9VVCIsInNlbGVjdG9yIiwiYXNzZXJ0aW9uVGltZW91dCIsImFzc2VydGlvbiIsInBhZ2VMb2FkVGltZW91dCIsInBhZ2VMb2FkIiwic3BlZWQiLCJERUZBVUxUX1NQRUVEX1ZBTFVFIiwiYXBwSW5pdERlbGF5IiwiREVGQVVMVF9BUFBfSU5JVF9ERUxBWSIsImNvbmN1cnJlbmN5IiwiREVGQVVMVF9DT05DVVJSRU5DWV9WQUxVRSIsInByZXBhcmUiLCJub3RpZnlBYm91dE92ZXJyaWRlbk9wdGlvbnMiLCJsZW5ndGgiLCJvcHRpb25zU3RyIiwiam9pbiIsIm9wdGlvbnNTdWZmaXgiLCJjb25maWdPcHRpb25zV2VyZU92ZXJyaWRlbiIsImdldE9wdGlvbiIsImdldE9wdGlvbnMiLCJjbG9uZSIsInN0YXJ0T3B0aW9ucyIsImhvc3RuYW1lIiwicG9ydDEiLCJwb3J0MiIsImRldmVsb3BtZW50TW9kZSIsInJldHJ5VGVzdFBhZ2VzIiwic3RhdGljQ29udGVudENhY2hpbmciLCJTVEFUSUNfQ09OVEVOVF9DQUNISU5HX1NFVFRJTkdTIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOzs7O0FBUUEsTUFB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O0FBRU5PLGlDQUFpQixLQUFLUCxTQUFMLENBQWUsaUJBQWYsQ0FGWDtBQUdOUSxnQ0FBaUIsQ0FBQyxDQUFDLEtBQUtSLFNBQUwsQ0FBZSxnQkFBZjtBQUhiO0FBSkMsU0FBZjs7QUFXQSxZQUFJNUUsT0FBT21DLE9BQVAsQ0FBZWlELGNBQW5CLEVBQ0lwRixPQUFPbUMsT0FBUCxDQUFla0Qsb0JBQWYsR0FBc0NDLDhDQUF0Qzs7QUFFSixlQUFPdEYsTUFBUDtBQUNIOztBQUVELFFBQUlvQixRQUFKLEdBQWdCO0FBQ1osZUFBTyxLQUFLeEIsU0FBWjtBQUNIO0FBclA4QjtrQkFBZEgsYSIsImZpbGUiOiJjb25maWd1cmF0aW9uL2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGRlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCB7IHN0YXQsIHJlYWRGaWxlIH0gZnJvbSAnLi4vdXRpbHMvcHJvbWlzaWZpZWQtZnVuY3Rpb25zJztcbmltcG9ydCBPcHRpb24gZnJvbSAnLi9vcHRpb24nO1xuaW1wb3J0IG9wdGlvblNvdXJjZSBmcm9tICcuL29wdGlvbi1zb3VyY2UnO1xuaW1wb3J0IHsgY2xvbmVEZWVwLCBjYXN0QXJyYXkgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZ2V0U1NMT3B0aW9ucyB9IGZyb20gJy4uL3V0aWxzL2dldC1vcHRpb25zJztcbmltcG9ydCBPUFRJT05fTkFNRVMgZnJvbSAnLi9vcHRpb24tbmFtZXMnO1xuaW1wb3J0IGdldEZpbHRlckZuIGZyb20gJy4uL3V0aWxzL2dldC1maWx0ZXItZm4nO1xuaW1wb3J0IHJlc29sdmVQYXRoUmVsYXRpdmVseUN3ZCBmcm9tICcuLi91dGlscy9yZXNvbHZlLXBhdGgtcmVsYXRpdmVseS1jd2QnO1xuaW1wb3J0IEpTT041IGZyb20gJ2pzb241JztcbmltcG9ydCByZW5kZXJUZW1wbGF0ZSBmcm9tICcuLi91dGlscy9yZW5kZXItdGVtcGxhdGUnO1xuaW1wb3J0IHByZXBhcmVSZXBvcnRlcnMgZnJvbSAnLi4vdXRpbHMvcHJlcGFyZS1yZXBvcnRlcnMnO1xuaW1wb3J0IFdBUk5JTkdfTUVTU0FHRVMgZnJvbSAnLi4vbm90aWZpY2F0aW9ucy93YXJuaW5nLW1lc3NhZ2UnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9jbGkvbG9nJztcblxuaW1wb3J0IHtcbiAgICBERUZBVUxUX1RJTUVPVVQsXG4gICAgREVGQVVMVF9TUEVFRF9WQUxVRSxcbiAgICBTVEFUSUNfQ09OVEVOVF9DQUNISU5HX1NFVFRJTkdTLFxuICAgIERFRkFVTFRfQVBQX0lOSVRfREVMQVksXG4gICAgREVGQVVMVF9DT05DVVJSRU5DWV9WQUxVRVxufSBmcm9tICcuL2RlZmF1bHQtdmFsdWVzJztcblxuY29uc3QgREVCVUdfTE9HR0VSID0gZGVidWcoJ3Rlc3RjYWZlOmNvbmZpZ3VyYXRpb24nKTtcblxuY29uc3QgQ09ORklHVVJBVElPTl9GSUxFTkFNRSA9ICcudGVzdGNhZmVyYy5qc29uJztcblxuY29uc3QgT1BUSU9OX0ZMQUdfTkFNRVMgPSBbXG4gICAgT1BUSU9OX05BTUVTLnNraXBKc0Vycm9ycyxcbiAgICBPUFRJT05fTkFNRVMuZGlzYWJsZVBhZ2VSZWxvYWRzLFxuICAgIE9QVElPTl9OQU1FUy5xdWFyYW50aW5lTW9kZSxcbiAgICBPUFRJT05fTkFNRVMuZGVidWdNb2RlLFxuICAgIE9QVElPTl9OQU1FUy5kZWJ1Z09uRmFpbCxcbiAgICBPUFRJT05fTkFNRVMuc2tpcFVuY2F1Z2h0RXJyb3JzLFxuICAgIE9QVElPTl9OQU1FUy5zdG9wT25GaXJzdEZhaWwsXG4gICAgT1BUSU9OX05BTUVTLnRha2VTY3JlZW5zaG90c09uRmFpbHNcbl07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENvbmZpZ3VyYXRpb24ge1xuICAgIGNvbnN0cnVjdG9yICgpIHtcbiAgICAgICAgdGhpcy5fb3B0aW9ucyAgPSB7fTtcbiAgICAgICAgdGhpcy5fZmlsZVBhdGggPSByZXNvbHZlUGF0aFJlbGF0aXZlbHlDd2QoQ09ORklHVVJBVElPTl9GSUxFTkFNRSk7XG4gICAgICAgIHRoaXMuX292ZXJyaWRlbk9wdGlvbnMgPSBbXTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX2Zyb21PYmogKG9iaikge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuXG4gICAgICAgIE9iamVjdC5lbnRyaWVzKG9iaikuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBvcHRpb24gPSBuZXcgT3B0aW9uKGtleSwgdmFsdWUpO1xuXG4gICAgICAgICAgICByZXN1bHRba2V5XSA9IG9wdGlvbjtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBzdGF0aWMgYXN5bmMgX2lzQ29uZmlndXJhdGlvbkZpbGVFeGlzdHMgKHBhdGgpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHN0YXQocGF0aCk7XG5cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgREVCVUdfTE9HR0VSKHJlbmRlclRlbXBsYXRlKFdBUk5JTkdfTUVTU0FHRVMuY2Fubm90RmluZENvbmZpZ3VyYXRpb25GaWxlLCBwYXRoLCBlcnJvci5zdGFjaykpO1xuXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdGF0aWMgX3Nob3dDb25zb2xlV2FybmluZyAobWVzc2FnZSkge1xuICAgICAgICBsb2cud3JpdGUobWVzc2FnZSk7XG4gICAgfVxuXG4gICAgc3RhdGljIF9zaG93V2FybmluZ0ZvckVycm9yIChlcnJvciwgd2FybmluZ1RlbXBsYXRlLCAuLi5hcmdzKSB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSByZW5kZXJUZW1wbGF0ZSh3YXJuaW5nVGVtcGxhdGUsIC4uLmFyZ3MpO1xuXG4gICAgICAgIENvbmZpZ3VyYXRpb24uX3Nob3dDb25zb2xlV2FybmluZyhtZXNzYWdlKTtcblxuICAgICAgICBERUJVR19MT0dHRVIobWVzc2FnZSk7XG4gICAgICAgIERFQlVHX0xPR0dFUihlcnJvcik7XG4gICAgfVxuXG4gICAgYXN5bmMgX2xvYWQgKCkge1xuICAgICAgICBpZiAoIWF3YWl0IENvbmZpZ3VyYXRpb24uX2lzQ29uZmlndXJhdGlvbkZpbGVFeGlzdHModGhpcy5maWxlUGF0aCkpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgbGV0IGNvbmZpZ3VyYXRpb25GaWxlQ29udGVudCA9IG51bGw7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb25GaWxlQ29udGVudCA9IGF3YWl0IHJlYWRGaWxlKHRoaXMuZmlsZVBhdGgpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgQ29uZmlndXJhdGlvbi5fc2hvd1dhcm5pbmdGb3JFcnJvcihlcnJvciwgV0FSTklOR19NRVNTQUdFUy5jYW5ub3RSZWFkQ29uZmlnRmlsZSk7XG5cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBvcHRpb25zT2JqID0gSlNPTjUucGFyc2UoY29uZmlndXJhdGlvbkZpbGVDb250ZW50KTtcblxuICAgICAgICAgICAgdGhpcy5fb3B0aW9ucyA9IENvbmZpZ3VyYXRpb24uX2Zyb21PYmoob3B0aW9uc09iaik7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBDb25maWd1cmF0aW9uLl9zaG93V2FybmluZ0ZvckVycm9yKGVycm9yLCBXQVJOSU5HX01FU1NBR0VTLmNhbm5vdFBhcnNlQ29uZmlnRmlsZSk7XG5cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHRoaXMuX25vcm1hbGl6ZU9wdGlvbnNBZnRlckxvYWQoKTtcbiAgICB9XG5cbiAgICBhc3luYyBfbm9ybWFsaXplT3B0aW9uc0FmdGVyTG9hZCAoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX3ByZXBhcmVTc2xPcHRpb25zKCk7XG4gICAgICAgIHRoaXMuX3ByZXBhcmVGaWx0ZXJGbigpO1xuICAgICAgICB0aGlzLl9lbnN1cmVBcnJheU9wdGlvbihPUFRJT05fTkFNRVMuc3JjKTtcbiAgICAgICAgdGhpcy5fZW5zdXJlQXJyYXlPcHRpb24oT1BUSU9OX05BTUVTLmJyb3dzZXJzKTtcbiAgICAgICAgdGhpcy5fcHJlcGFyZVJlcG9ydGVycygpO1xuICAgIH1cblxuICAgIF9lbnN1cmVBcnJheU9wdGlvbiAobmFtZSkge1xuICAgICAgICBjb25zdCBvcHRpb25zID0gdGhpcy5fb3B0aW9uc1tuYW1lXTtcblxuICAgICAgICBpZiAoIW9wdGlvbnMpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgb3B0aW9ucy52YWx1ZSA9IGNhc3RBcnJheShvcHRpb25zLnZhbHVlKTtcbiAgICB9XG5cbiAgICBfcHJlcGFyZUZpbHRlckZuICgpIHtcbiAgICAgICAgY29uc3QgZmlsdGVyT3B0aW9uID0gdGhpcy5fZW5zdXJlT3B0aW9uKE9QVElPTl9OQU1FUy5maWx0ZXIsIG51bGwpO1xuXG4gICAgICAgIGlmICghZmlsdGVyT3B0aW9uLnZhbHVlKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGZpbHRlck9wdGlvbi52YWx1ZSA9IGdldEZpbHRlckZuKGZpbHRlck9wdGlvbi52YWx1ZSk7XG4gICAgfVxuXG4gICAgX3ByZXBhcmVSZXBvcnRlcnMgKCkge1xuICAgICAgICBjb25zdCByZXBvcnRlck9wdGlvbiA9IHRoaXMuX29wdGlvbnNbT1BUSU9OX05BTUVTLnJlcG9ydGVyXTtcblxuICAgICAgICBpZiAoIXJlcG9ydGVyT3B0aW9uKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IG9wdGlvblZhbHVlID0gY2FzdEFycmF5KHJlcG9ydGVyT3B0aW9uLnZhbHVlKTtcblxuICAgICAgICByZXBvcnRlck9wdGlvbi52YWx1ZSA9IHByZXBhcmVSZXBvcnRlcnMob3B0aW9uVmFsdWUpO1xuICAgIH1cblxuICAgIGFzeW5jIF9wcmVwYXJlU3NsT3B0aW9ucyAoKSB7XG4gICAgICAgIGNvbnN0IHNzbE9wdGlvbnMgPSB0aGlzLl9vcHRpb25zW09QVElPTl9OQU1FUy5zc2xdO1xuXG4gICAgICAgIGlmICghc3NsT3B0aW9ucylcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBzc2xPcHRpb25zLnZhbHVlID0gYXdhaXQgZ2V0U1NMT3B0aW9ucyhzc2xPcHRpb25zLnZhbHVlKTtcbiAgICB9XG5cbiAgICBfZW5zdXJlT3B0aW9uIChuYW1lLCB2YWx1ZSwgc291cmNlKSB7XG4gICAgICAgIGxldCBvcHRpb24gPSBudWxsO1xuXG4gICAgICAgIGlmIChuYW1lIGluIHRoaXMuX29wdGlvbnMpXG4gICAgICAgICAgICBvcHRpb24gPSB0aGlzLl9vcHRpb25zW25hbWVdO1xuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIG9wdGlvbiA9IG5ldyBPcHRpb24obmFtZSwgdmFsdWUsIHNvdXJjZSk7XG5cbiAgICAgICAgICAgIHRoaXMuX29wdGlvbnNbbmFtZV0gPSBvcHRpb247XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb3B0aW9uO1xuICAgIH1cblxuICAgIF9lbnN1cmVPcHRpb25XaXRoVmFsdWUgKG5hbWUsIGRlZmF1bHRWYWx1ZSwgc291cmNlKSB7XG4gICAgICAgIGNvbnN0IG9wdGlvbiA9IHRoaXMuX2Vuc3VyZU9wdGlvbihuYW1lLCBkZWZhdWx0VmFsdWUsIHNvdXJjZSk7XG5cbiAgICAgICAgaWYgKG9wdGlvbi52YWx1ZSAhPT0gdm9pZCAwKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIG9wdGlvbi52YWx1ZSAgPSBkZWZhdWx0VmFsdWU7XG4gICAgICAgIG9wdGlvbi5zb3VyY2UgPSBzb3VyY2U7XG4gICAgfVxuXG4gICAgYXN5bmMgaW5pdCAob3B0aW9ucyA9IHt9KSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX2xvYWQoKTtcbiAgICAgICAgdGhpcy5tZXJnZU9wdGlvbnMob3B0aW9ucyk7XG4gICAgfVxuXG4gICAgbWVyZ2VPcHRpb25zIChvcHRpb25zKSB7XG4gICAgICAgIE9iamVjdC5lbnRyaWVzKG9wdGlvbnMpLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBvcHRpb24gPSB0aGlzLl9lbnN1cmVPcHRpb24oa2V5LCB2YWx1ZSwgb3B0aW9uU291cmNlLmlucHV0KTtcblxuICAgICAgICAgICAgaWYgKHZhbHVlID09PSB2b2lkIDApXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgICAgICBpZiAob3B0aW9uLnZhbHVlICE9PSB2YWx1ZSAmJlxuICAgICAgICAgICAgICAgIG9wdGlvbi5zb3VyY2UgPT09IG9wdGlvblNvdXJjZS5jb25maWd1cmF0aW9uKVxuICAgICAgICAgICAgICAgIHRoaXMuX292ZXJyaWRlbk9wdGlvbnMucHVzaChrZXkpO1xuXG4gICAgICAgICAgICBvcHRpb24udmFsdWUgID0gdmFsdWU7XG4gICAgICAgICAgICBvcHRpb24uc291cmNlID0gb3B0aW9uU291cmNlLmlucHV0O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfcHJlcGFyZUZsYWdzICgpIHtcbiAgICAgICAgT1BUSU9OX0ZMQUdfTkFNRVMuZm9yRWFjaChuYW1lID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbiA9IHRoaXMuX2Vuc3VyZU9wdGlvbihuYW1lLCB2b2lkIDAsIG9wdGlvblNvdXJjZS5jb25maWd1cmF0aW9uKTtcblxuICAgICAgICAgICAgb3B0aW9uLnZhbHVlID0gISFvcHRpb24udmFsdWU7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIF9zZXREZWZhdWx0VmFsdWVzICgpIHtcbiAgICAgICAgdGhpcy5fZW5zdXJlT3B0aW9uV2l0aFZhbHVlKE9QVElPTl9OQU1FUy5zZWxlY3RvclRpbWVvdXQsIERFRkFVTFRfVElNRU9VVC5zZWxlY3Rvciwgb3B0aW9uU291cmNlLmNvbmZpZ3VyYXRpb24pO1xuICAgICAgICB0aGlzLl9lbnN1cmVPcHRpb25XaXRoVmFsdWUoT1BUSU9OX05BTUVTLmFzc2VydGlvblRpbWVvdXQsIERFRkFVTFRfVElNRU9VVC5hc3NlcnRpb24sIG9wdGlvblNvdXJjZS5jb25maWd1cmF0aW9uKTtcbiAgICAgICAgdGhpcy5fZW5zdXJlT3B0aW9uV2l0aFZhbHVlKE9QVElPTl9OQU1FUy5wYWdlTG9hZFRpbWVvdXQsIERFRkFVTFRfVElNRU9VVC5wYWdlTG9hZCwgb3B0aW9uU291cmNlLmNvbmZpZ3VyYXRpb24pO1xuICAgICAgICB0aGlzLl9lbnN1cmVPcHRpb25XaXRoVmFsdWUoT1BUSU9OX05BTUVTLnNwZWVkLCBERUZBVUxUX1NQRUVEX1ZBTFVFLCBvcHRpb25Tb3VyY2UuY29uZmlndXJhdGlvbik7XG4gICAgICAgIHRoaXMuX2Vuc3VyZU9wdGlvbldpdGhWYWx1ZShPUFRJT05fTkFNRVMuYXBwSW5pdERlbGF5LCBERUZBVUxUX0FQUF9JTklUX0RFTEFZLCBvcHRpb25Tb3VyY2UuY29uZmlndXJhdGlvbik7XG4gICAgICAgIHRoaXMuX2Vuc3VyZU9wdGlvbldpdGhWYWx1ZShPUFRJT05fTkFNRVMuY29uY3VycmVuY3ksIERFRkFVTFRfQ09OQ1VSUkVOQ1lfVkFMVUUsIG9wdGlvblNvdXJjZS5jb25maWd1cmF0aW9uKTtcbiAgICB9XG5cbiAgICBwcmVwYXJlICgpIHtcbiAgICAgICAgdGhpcy5fcHJlcGFyZUZsYWdzKCk7XG4gICAgICAgIHRoaXMuX3NldERlZmF1bHRWYWx1ZXMoKTtcbiAgICB9XG5cbiAgICBub3RpZnlBYm91dE92ZXJyaWRlbk9wdGlvbnMgKCkge1xuICAgICAgICBpZiAoIXRoaXMuX292ZXJyaWRlbk9wdGlvbnMubGVuZ3RoKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IG9wdGlvbnNTdHIgICAgPSB0aGlzLl9vdmVycmlkZW5PcHRpb25zLm1hcChvcHRpb24gPT4gYFwiJHtvcHRpb259XCJgKS5qb2luKCcsICcpO1xuICAgICAgICBjb25zdCBvcHRpb25zU3VmZml4ID0gdGhpcy5fb3ZlcnJpZGVuT3B0aW9ucy5sZW5ndGggPiAxID8gJ3MnIDogJyc7XG5cbiAgICAgICAgQ29uZmlndXJhdGlvbi5fc2hvd0NvbnNvbGVXYXJuaW5nKHJlbmRlclRlbXBsYXRlKFdBUk5JTkdfTUVTU0FHRVMuY29uZmlnT3B0aW9uc1dlcmVPdmVycmlkZW4sIG9wdGlvbnNTdHIsIG9wdGlvbnNTdWZmaXgpKTtcblxuICAgICAgICB0aGlzLl9vdmVycmlkZW5PcHRpb25zID0gW107XG4gICAgfVxuXG4gICAgZ2V0T3B0aW9uIChrZXkpIHtcbiAgICAgICAgaWYgKCFrZXkpXG4gICAgICAgICAgICByZXR1cm4gdm9pZCAwO1xuXG4gICAgICAgIGNvbnN0IG9wdGlvbiA9IHRoaXMuX29wdGlvbnNba2V5XTtcblxuICAgICAgICBpZiAoIW9wdGlvbilcbiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7XG5cbiAgICAgICAgcmV0dXJuIG9wdGlvbi52YWx1ZTtcbiAgICB9XG5cbiAgICBnZXRPcHRpb25zICgpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcblxuICAgICAgICBPYmplY3QuZW50cmllcyh0aGlzLl9vcHRpb25zKS5mb3JFYWNoKChbbmFtZSwgb3B0aW9uXSkgPT4ge1xuICAgICAgICAgICAgcmVzdWx0W25hbWVdID0gb3B0aW9uLnZhbHVlO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIGNsb25lICgpIHtcbiAgICAgICAgcmV0dXJuIGNsb25lRGVlcCh0aGlzKTtcbiAgICB9XG5cbiAgICBnZXQgc3RhcnRPcHRpb25zICgpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgICAgICAgaG9zdG5hbWU6IHRoaXMuZ2V0T3B0aW9uKCdob3N0bmFtZScpLFxuICAgICAgICAgICAgcG9ydDE6ICAgIHRoaXMuZ2V0T3B0aW9uKCdwb3J0MScpLFxuICAgICAgICAgICAgcG9ydDI6ICAgIHRoaXMuZ2V0T3B0aW9uKCdwb3J0MicpLFxuICAgICAgICAgICAgb3B0aW9uczogIHtcbiAgICAgICAgICAgICAgICBzc2w6ICAgICAgICAgICAgIHRoaXMuZ2V0T3B0aW9uKCdzc2wnKSxcbiAgICAgICAgICAgICAgICBkZXZlbG9wbWVudE1vZGU6IHRoaXMuZ2V0T3B0aW9uKCdkZXZlbG9wbWVudE1vZGUnKSxcbiAgICAgICAgICAgICAgICByZXRyeVRlc3RQYWdlczogICEhdGhpcy5nZXRPcHRpb24oJ3JldHJ5VGVzdFBhZ2VzJylcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICBpZiAocmVzdWx0Lm9wdGlvbnMucmV0cnlUZXN0UGFnZXMpXG4gICAgICAgICAgICByZXN1bHQub3B0aW9ucy5zdGF0aWNDb250ZW50Q2FjaGluZyA9IFNUQVRJQ19DT05URU5UX0NBQ0hJTkdfU0VUVElOR1M7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBnZXQgZmlsZVBhdGggKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZmlsZVBhdGg7XG4gICAgfVxufVxuIl19
