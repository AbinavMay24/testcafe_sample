'use strict';

exports.__esModule = true;

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _fileWatcher = require('./file-watcher');

var _fileWatcher2 = _interopRequireDefault(_fileWatcher);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _process = require('process');

var _process2 = _interopRequireDefault(_process);

var _readline = require('readline');

var _readline2 = _interopRequireDefault(_readline);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const REQUIRED_MODULE_FOUND_EVENT = 'require-module-found';
const LOCK_KEY_PRESS_TIMEOUT = 1000;

class LiveModeController extends _events2.default {
    constructor(runner) {
        super();

        this.src = null;
        this.running = false;
        this.restarting = false;
        this.watchingPaused = false;
        this.stopping = false;
        this.logger = new _logger2.default();
        this.runner = runner;
        this.lockKeyPress = false;
        this.fileWatcher = null;
        this.rl = null;
    }

    init(files) {
        this._listenKeyPress();
        this._initFileWatching(files);
        this._listenTestRunnerEvents();
        this._setRunning();

        return _pinkie2.default.resolve().then(() => this.logger.writeIntroMessage(files));
    }

    dispose() {
        this.fileWatcher.stop();
        _process2.default.stdin.setRawMode(false);
        this.rl.close();
    }

    _toggleWatching() {
        this.watchingPaused = !this.watchingPaused;

        this.logger.writeToggleWatchingMessage(!this.watchingPaused);
    }

    _stop() {
        if (!this.runner || !this.running) {
            this.logger.writeNothingToStopMessage();

            return _pinkie2.default.resolve();
        }

        this.logger.writeStopRunningMessage();

        return this.runner.suspend().then(() => {
            this.restarting = false;
            this.running = false;
        });
    }

    _restart() {
        if (this.restarting || this.watchingPaused) return _pinkie2.default.resolve();

        this.restarting = true;

        if (this.running) {
            return this._stop().then(() => this.logger.writeTestsFinishedMessage()).then(() => this._runTests());
        }

        return this._runTests();
    }

    _exit() {
        if (this.stopping) return _pinkie2.default.resolve();

        this.logger.writeExitMessage();

        this.stopping = true;

        return this.runner ? this.runner.exit() : _pinkie2.default.resolve();
    }

    _createFileWatcher(src) {
        return new _fileWatcher2.default(src);
    }

    _listenKeyPress() {
        _readline2.default.emitKeypressEvents(_process2.default.stdin);
        if (_process2.default.stdin.isTTY) _process2.default.stdin.setRawMode(true);

        this.rl = _readline2.default.createInterface({
            input: _process2.default.stdin,
            output: _process2.default.stdout
        });

        _process2.default.stdin.on('keypress', (ch, key) => {
            if (this.lockKeyPress) return null;

            this.lockKeyPress = true;

            setTimeout(() => {
                this.lockKeyPress = false;
            }, LOCK_KEY_PRESS_TIMEOUT);

            if (key && key.ctrl) {
                switch (key.name) {
                    case 's':
                        return this._stop();
                    case 'r':
                        return this._restart();
                    case 'c':
                        return this._exit();
                    case 'w':
                        return this._toggleWatching();
                }
            }

            return null;
        });
    }

    _listenTestRunnerEvents() {
        this.runner.on(this.runner.TEST_RUN_DONE_EVENT, e => {
            this.running = false;

            if (!this.restarting) this.logger.writeTestsFinishedMessage();

            if (e.err) this.logger.err(`ERROR: ${e.err}`);
        });

        this.runner.on(this.runner.REQUIRED_MODULE_FOUND_EVENT, e => {
            this.emit(REQUIRED_MODULE_FOUND_EVENT, e);
        });
    }

    _initFileWatching(src) {
        this.fileWatcher = this._createFileWatcher(src);

        this.on(REQUIRED_MODULE_FOUND_EVENT, e => this.fileWatcher.addFile(e.filename));

        this.fileWatcher.on(this.fileWatcher.FILE_CHANGED_EVENT, () => this._runTests(true));
    }

    _setRunning() {
        this.running = true;
        this.restarting = false;
    }

    _runTests(sourceChanged) {
        if (this.watchingPaused || this.running) return _pinkie2.default.resolve();

        this._setRunning();

        this.logger.writeRunTestsMessage(sourceChanged);

        return this.runner.runTests();
    }
}

exports.default = LiveModeController;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saXZlL2NvbnRyb2xsZXIuanMiXSwibmFtZXMiOlsiUkVRVUlSRURfTU9EVUxFX0ZPVU5EX0VWRU5UIiwiTE9DS19LRVlfUFJFU1NfVElNRU9VVCIsIkxpdmVNb2RlQ29udHJvbGxlciIsIkV2ZW50RW1pdHRlciIsImNvbnN0cnVjdG9yIiwicnVubmVyIiwic3JjIiwicnVubmluZyIsInJlc3RhcnRpbmciLCJ3YXRjaGluZ1BhdXNlZCIsInN0b3BwaW5nIiwibG9nZ2VyIiwiTG9nZ2VyIiwibG9ja0tleVByZXNzIiwiZmlsZVdhdGNoZXIiLCJybCIsImluaXQiLCJmaWxlcyIsIl9saXN0ZW5LZXlQcmVzcyIsIl9pbml0RmlsZVdhdGNoaW5nIiwiX2xpc3RlblRlc3RSdW5uZXJFdmVudHMiLCJfc2V0UnVubmluZyIsIlByb21pc2UiLCJyZXNvbHZlIiwidGhlbiIsIndyaXRlSW50cm9NZXNzYWdlIiwiZGlzcG9zZSIsInN0b3AiLCJwcm9jZXNzIiwic3RkaW4iLCJzZXRSYXdNb2RlIiwiY2xvc2UiLCJfdG9nZ2xlV2F0Y2hpbmciLCJ3cml0ZVRvZ2dsZVdhdGNoaW5nTWVzc2FnZSIsIl9zdG9wIiwid3JpdGVOb3RoaW5nVG9TdG9wTWVzc2FnZSIsIndyaXRlU3RvcFJ1bm5pbmdNZXNzYWdlIiwic3VzcGVuZCIsIl9yZXN0YXJ0Iiwid3JpdGVUZXN0c0ZpbmlzaGVkTWVzc2FnZSIsIl9ydW5UZXN0cyIsIl9leGl0Iiwid3JpdGVFeGl0TWVzc2FnZSIsImV4aXQiLCJfY3JlYXRlRmlsZVdhdGNoZXIiLCJGaWxlV2F0Y2hlciIsInJlYWRsaW5lIiwiZW1pdEtleXByZXNzRXZlbnRzIiwiaXNUVFkiLCJjcmVhdGVJbnRlcmZhY2UiLCJpbnB1dCIsIm91dHB1dCIsInN0ZG91dCIsIm9uIiwiY2giLCJrZXkiLCJzZXRUaW1lb3V0IiwiY3RybCIsIm5hbWUiLCJURVNUX1JVTl9ET05FX0VWRU5UIiwiZSIsImVyciIsImVtaXQiLCJhZGRGaWxlIiwiZmlsZW5hbWUiLCJGSUxFX0NIQU5HRURfRVZFTlQiLCJzb3VyY2VDaGFuZ2VkIiwid3JpdGVSdW5UZXN0c01lc3NhZ2UiLCJydW5UZXN0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRUEsTUFBTUEsOEJBQThCLHNCQUFwQztBQUNBLE1BQU1DLHlCQUE4QixJQUFwQzs7QUFFQSxNQUFNQyxrQkFBTixTQUFpQ0MsZ0JBQWpDLENBQThDO0FBQzFDQyxnQkFBYUMsTUFBYixFQUFxQjtBQUNqQjs7QUFFQSxhQUFLQyxHQUFMLEdBQXNCLElBQXRCO0FBQ0EsYUFBS0MsT0FBTCxHQUFzQixLQUF0QjtBQUNBLGFBQUtDLFVBQUwsR0FBc0IsS0FBdEI7QUFDQSxhQUFLQyxjQUFMLEdBQXNCLEtBQXRCO0FBQ0EsYUFBS0MsUUFBTCxHQUFzQixLQUF0QjtBQUNBLGFBQUtDLE1BQUwsR0FBc0IsSUFBSUMsZ0JBQUosRUFBdEI7QUFDQSxhQUFLUCxNQUFMLEdBQXNCQSxNQUF0QjtBQUNBLGFBQUtRLFlBQUwsR0FBc0IsS0FBdEI7QUFDQSxhQUFLQyxXQUFMLEdBQXNCLElBQXRCO0FBQ0EsYUFBS0MsRUFBTCxHQUFzQixJQUF0QjtBQUNIOztBQUVEQyxTQUFNQyxLQUFOLEVBQWE7QUFDVCxhQUFLQyxlQUFMO0FBQ0EsYUFBS0MsaUJBQUwsQ0FBdUJGLEtBQXZCO0FBQ0EsYUFBS0csdUJBQUw7QUFDQSxhQUFLQyxXQUFMOztBQUVBLGVBQU9DLGlCQUFRQyxPQUFSLEdBQ0ZDLElBREUsQ0FDRyxNQUFNLEtBQUtiLE1BQUwsQ0FBWWMsaUJBQVosQ0FBOEJSLEtBQTlCLENBRFQsQ0FBUDtBQUVIOztBQUVEUyxjQUFXO0FBQ1AsYUFBS1osV0FBTCxDQUFpQmEsSUFBakI7QUFDQUMsMEJBQVFDLEtBQVIsQ0FBY0MsVUFBZCxDQUF5QixLQUF6QjtBQUNBLGFBQUtmLEVBQUwsQ0FBUWdCLEtBQVI7QUFDSDs7QUFFREMsc0JBQW1CO0FBQ2YsYUFB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Y29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRzJztcbmltcG9ydCBGaWxlV2F0Y2hlciBmcm9tICcuL2ZpbGUtd2F0Y2hlcic7XG5pbXBvcnQgTG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBwcm9jZXNzIGZyb20gJ3Byb2Nlc3MnO1xuaW1wb3J0IHJlYWRsaW5lIGZyb20gJ3JlYWRsaW5lJztcbmltcG9ydCBQcm9taXNlIGZyb20gJ3BpbmtpZSc7XG5cbmNvbnN0IFJFUVVJUkVEX01PRFVMRV9GT1VORF9FVkVOVCA9ICdyZXF1aXJlLW1vZHVsZS1mb3VuZCc7XG5jb25zdCBMT0NLX0tFWV9QUkVTU19USU1FT1VUICAgICAgPSAxMDAwO1xuXG5jbGFzcyBMaXZlTW9kZUNvbnRyb2xsZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIGNvbnN0cnVjdG9yIChydW5uZXIpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLnNyYyAgICAgICAgICAgID0gbnVsbDtcbiAgICAgICAgdGhpcy5ydW5uaW5nICAgICAgICA9IGZhbHNlO1xuICAgICAgICB0aGlzLnJlc3RhcnRpbmcgICAgID0gZmFsc2U7XG4gICAgICAgIHRoaXMud2F0Y2hpbmdQYXVzZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5zdG9wcGluZyAgICAgICA9IGZhbHNlO1xuICAgICAgICB0aGlzLmxvZ2dlciAgICAgICAgID0gbmV3IExvZ2dlcigpO1xuICAgICAgICB0aGlzLnJ1bm5lciAgICAgICAgID0gcnVubmVyO1xuICAgICAgICB0aGlzLmxvY2tLZXlQcmVzcyAgID0gZmFsc2U7XG4gICAgICAgIHRoaXMuZmlsZVdhdGNoZXIgICAgPSBudWxsO1xuICAgICAgICB0aGlzLnJsICAgICAgICAgICAgID0gbnVsbDtcbiAgICB9XG5cbiAgICBpbml0IChmaWxlcykge1xuICAgICAgICB0aGlzLl9saXN0ZW5LZXlQcmVzcygpO1xuICAgICAgICB0aGlzLl9pbml0RmlsZVdhdGNoaW5nKGZpbGVzKTtcbiAgICAgICAgdGhpcy5fbGlzdGVuVGVzdFJ1bm5lckV2ZW50cygpO1xuICAgICAgICB0aGlzLl9zZXRSdW5uaW5nKCk7XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLmxvZ2dlci53cml0ZUludHJvTWVzc2FnZShmaWxlcykpO1xuICAgIH1cblxuICAgIGRpc3Bvc2UgKCkge1xuICAgICAgICB0aGlzLmZpbGVXYXRjaGVyLnN0b3AoKTtcbiAgICAgICAgcHJvY2Vzcy5zdGRpbi5zZXRSYXdNb2RlKGZhbHNlKTtcbiAgICAgICAgdGhpcy5ybC5jbG9zZSgpO1xuICAgIH1cblxuICAgIF90b2dnbGVXYXRjaGluZyAoKSB7XG4gICAgICAgIHRoaXMud2F0Y2hpbmdQYXVzZWQgPSAhdGhpcy53YXRjaGluZ1BhdXNlZDtcblxuICAgICAgICB0aGlzLmxvZ2dlci53cml0ZVRvZ2dsZVdhdGNoaW5nTWVzc2FnZSghdGhpcy53YXRjaGluZ1BhdXNlZCk7XG4gICAgfVxuXG4gICAgX3N0b3AgKCkge1xuICAgICAgICBpZiAoIXRoaXMucnVubmVyIHx8ICF0aGlzLnJ1bm5pbmcpIHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLndyaXRlTm90aGluZ1RvU3RvcE1lc3NhZ2UoKTtcblxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5sb2dnZXIud3JpdGVTdG9wUnVubmluZ01lc3NhZ2UoKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5ydW5uZXIuc3VzcGVuZCgpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZXN0YXJ0aW5nID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdGhpcy5ydW5uaW5nICAgID0gZmFsc2U7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfcmVzdGFydCAoKSB7XG4gICAgICAgIGlmICh0aGlzLnJlc3RhcnRpbmcgfHwgdGhpcy53YXRjaGluZ1BhdXNlZClcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcblxuICAgICAgICB0aGlzLnJlc3RhcnRpbmcgPSB0cnVlO1xuXG4gICAgICAgIGlmICh0aGlzLnJ1bm5pbmcpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zdG9wKClcbiAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLmxvZ2dlci53cml0ZVRlc3RzRmluaXNoZWRNZXNzYWdlKCkpXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5fcnVuVGVzdHMoKSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5fcnVuVGVzdHMoKTtcbiAgICB9XG5cbiAgICBfZXhpdCAoKSB7XG4gICAgICAgIGlmICh0aGlzLnN0b3BwaW5nKVxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuXG4gICAgICAgIHRoaXMubG9nZ2VyLndyaXRlRXhpdE1lc3NhZ2UoKTtcblxuICAgICAgICB0aGlzLnN0b3BwaW5nID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gdGhpcy5ydW5uZXIgPyB0aGlzLnJ1bm5lci5leGl0KCkgOiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9XG5cbiAgICBfY3JlYXRlRmlsZVdhdGNoZXIgKHNyYykge1xuICAgICAgICByZXR1cm4gbmV3IEZpbGVXYXRjaGVyKHNyYyk7XG4gICAgfVxuXG4gICAgX2xpc3RlbktleVByZXNzICgpIHtcbiAgICAgICAgcmVhZGxpbmUuZW1pdEtleXByZXNzRXZlbnRzKHByb2Nlc3Muc3RkaW4pO1xuICAgICAgICBpZiAocHJvY2Vzcy5zdGRpbi5pc1RUWSlcbiAgICAgICAgICAgIHByb2Nlc3Muc3RkaW4uc2V0UmF3TW9kZSh0cnVlKTtcblxuICAgICAgICB0aGlzLnJsID0gcmVhZGxpbmUuY3JlYXRlSW50ZXJmYWNlKHtcbiAgICAgICAgICAgIGlucHV0OiAgcHJvY2Vzcy5zdGRpbixcbiAgICAgICAgICAgIG91dHB1dDogcHJvY2Vzcy5zdGRvdXRcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcHJvY2Vzcy5zdGRpbi5vbigna2V5cHJlc3MnLCAoY2gsIGtleSkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMubG9ja0tleVByZXNzKVxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuXG4gICAgICAgICAgICB0aGlzLmxvY2tLZXlQcmVzcyA9IHRydWU7XG5cbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubG9ja0tleVByZXNzID0gZmFsc2U7XG4gICAgICAgICAgICB9LCBMT0NLX0tFWV9QUkVTU19USU1FT1VUKTtcblxuICAgICAgICAgICAgaWYgKGtleSAmJiBrZXkuY3RybCkge1xuICAgICAgICAgICAgICAgIHN3aXRjaCAoa2V5Lm5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAncyc6XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fc3RvcCgpO1xuICAgICAgICAgICAgICAgICAgICBjYXNlICdyJzpcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9yZXN0YXJ0KCk7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2MnOlxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2V4aXQoKTtcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAndyc6XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fdG9nZ2xlV2F0Y2hpbmcoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfbGlzdGVuVGVzdFJ1bm5lckV2ZW50cyAoKSB7XG4gICAgICAgIHRoaXMucnVubmVyLm9uKHRoaXMucnVubmVyLlRFU1RfUlVOX0RPTkVfRVZFTlQsIGUgPT4ge1xuICAgICAgICAgICAgdGhpcy5ydW5uaW5nID0gZmFsc2U7XG5cbiAgICAgICAgICAgIGlmICghdGhpcy5yZXN0YXJ0aW5nKVxuICAgICAgICAgICAgICAgIHRoaXMubG9nZ2VyLndyaXRlVGVzdHNGaW5pc2hlZE1lc3NhZ2UoKTtcblxuICAgICAgICAgICAgaWYgKGUuZXJyKVxuICAgICAgICAgICAgICAgIHRoaXMubG9nZ2VyLmVycihgRVJST1I6ICR7ZS5lcnJ9YCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMucnVubmVyLm9uKHRoaXMucnVubmVyLlJFUVVJUkVEX01PRFVMRV9GT1VORF9FVkVOVCwgZSA9PiB7XG4gICAgICAgICAgICB0aGlzLmVtaXQoUkVRVUlSRURfTU9EVUxFX0ZPVU5EX0VWRU5ULCBlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX2luaXRGaWxlV2F0Y2hpbmcgKHNyYykge1xuICAgICAgICB0aGlzLmZpbGVXYXRjaGVyID0gdGhpcy5fY3JlYXRlRmlsZVdhdGNoZXIoc3JjKTtcblxuICAgICAgICB0aGlzLm9uKFJFUVVJUkVEX01PRFVMRV9GT1VORF9FVkVOVCwgZSA9PiB0aGlzLmZpbGVXYXRjaGVyLmFkZEZpbGUoZS5maWxlbmFtZSkpO1xuXG4gICAgICAgIHRoaXMuZmlsZVdhdGNoZXIub24odGhpcy5maWxlV2F0Y2hlci5GSUxFX0NIQU5HRURfRVZFTlQsICgpID0+IHRoaXMuX3J1blRlc3RzKHRydWUpKTtcbiAgICB9XG5cbiAgICBfc2V0UnVubmluZyAoKSB7XG4gICAgICAgIHRoaXMucnVubmluZyAgICA9IHRydWU7XG4gICAgICAgIHRoaXMucmVzdGFydGluZyA9IGZhbHNlO1xuICAgIH1cblxuICAgIF9ydW5UZXN0cyAoc291cmNlQ2hhbmdlZCkge1xuICAgICAgICBpZiAodGhpcy53YXRjaGluZ1BhdXNlZCB8fCB0aGlzLnJ1bm5pbmcpXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG5cbiAgICAgICAgdGhpcy5fc2V0UnVubmluZygpO1xuXG4gICAgICAgIHRoaXMubG9nZ2VyLndyaXRlUnVuVGVzdHNNZXNzYWdlKHNvdXJjZUNoYW5nZWQpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLnJ1bm5lci5ydW5UZXN0cygpO1xuICAgIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgTGl2ZU1vZGVDb250cm9sbGVyO1xuIl19
