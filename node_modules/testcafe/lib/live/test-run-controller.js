'use strict';

exports.__esModule = true;

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _testRun = require('./test-run');

var _testRunState = require('./test-run-state');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class LiveModeTestRunController extends _events2.default {
    constructor() {
        super();

        this.RUN_FINISHED_EVENT = 'run-finished-event';
        this.RUN_STOPPED_EVENT = 'run-stopped-event';

        this.testWrappers = [];
        this.expectedTestCount = 0;
        this._testRunCtor = null;
    }

    get TestRunCtor() {
        if (!this._testRunCtor) {
            this._testRunCtor = (0, _testRun.TestRunCtorFactory)({
                created: testRun => this._onTestRunCreated(testRun),
                started: testRun => this._onTestRunStarted(testRun),
                done: (testRun, forced) => this._onTestRunDone(testRun, forced),
                readyToNext: testRun => this._onTestRunReadyToNext(testRun)
            });
        }

        return this._testRunCtor;
    }

    setExpectedTestCount(testCount) {
        this.expectedTestCount = testCount;
    }

    run() {
        const readyToNextPromises = [];

        this.testWrappers.forEach(testWrapper => {
            testWrapper.testRuns.forEach(testRun => {
                if (testRun.finish) {
                    readyToNextPromises.push(testRun.readyToNextPromise);
                    testRun.finish();
                }
            });
        });

        this.testWrappers = [];

        return _pinkie2.default.all(readyToNextPromises);
    }

    stop() {
        const runningTestWrappers = this.testWrappers.filter(w => w.state === _testRunState.TEST_STATE.running);

        runningTestWrappers.forEach(testWrapper => {
            testWrapper.testRuns.forEach(testRun => testRun.stop());
        });
    }

    _getTestWrapper(test) {
        return this.testWrappers.find(w => w.test === test);
    }

    _onTestRunCreated(testRun) {
        let testWrapper = this._getTestWrapper(testRun.test);

        if (!testWrapper) {
            testWrapper = {
                test: testRun.test,
                state: _testRunState.TEST_STATE.created,
                testRuns: []
            };

            this.testWrappers.push(testWrapper);
        }

        testWrapper.testRuns.push(testRun);

        testRun.testWrapper = testWrapper;
    }

    _onTestRunStarted(testRun) {
        testRun.state = _testRunState.TEST_RUN_STATE.running;
        testRun.testWrapper.state = _testRunState.TEST_STATE.running;
    }

    _onTestRunDone(testRun, forced) {
        const testWrapper = testRun.testWrapper;

        testRun.state = _testRunState.TEST_RUN_STATE.waitingForDone;

        const waitingTestRunCount = testWrapper.testRuns.filter(w => w.state === _testRunState.TEST_RUN_STATE.created).length;
        const runningTestRunCount = testWrapper.testRuns.filter(w => w.state === _testRunState.TEST_RUN_STATE.running).length;

        const waitForOtherTestRuns = runningTestRunCount || waitingTestRunCount && !forced;

        if (!waitForOtherTestRuns) {
            testWrapper.state = _testRunState.TEST_STATE.done;

            //check other active tests
            setTimeout(() => {
                const hasTestsToRun = this.testWrappers.length < this.expectedTestCount || this.testWrappers.some(w => w.state === _testRunState.TEST_STATE.created) || testRun.quarantine && !testRun.quarantine.isThresholdReached();

                if (!forced && hasTestsToRun) testWrapper.testRuns.forEach(w => w.finish());else this.emit(forced ? this.RUN_STOPPED_EVENT : this.RUN_FINISHED_EVENT);
            }, 0);
        }

        testRun.readyToNextPromise = new _pinkie2.default(resolve => {
            testRun.setReadyToNext = resolve;
        });

        return new _pinkie2.default(resolve => {
            testRun.finish = () => {
                testRun.finish = null;
                testRun.state = _testRunState.TEST_RUN_STATE.done;
                resolve();
            };
        });
    }

    _onTestRunReadyToNext(testRun) {
        testRun.setReadyToNext();
    }
}

exports.default = LiveModeTestRunController;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saXZlL3Rlc3QtcnVuLWNvbnRyb2xsZXIuanMiXSwibmFtZXMiOlsiTGl2ZU1vZGVUZXN0UnVuQ29udHJvbGxlciIsIkV2ZW50RW1pdHRlciIsImNvbnN0cnVjdG9yIiwiUlVOX0ZJTklTSEVEX0VWRU5UIiwiUlVOX1NUT1BQRURfRVZFTlQiLCJ0ZXN0V3JhcHBlcnMiLCJleHBlY3RlZFRlc3RDb3VudCIsIl90ZXN0UnVuQ3RvciIsIlRlc3RSdW5DdG9yIiwiY3JlYXRlZCIsInRlc3RSdW4iLCJfb25UZXN0UnVuQ3JlYXRlZCIsInN0YXJ0ZWQiLCJfb25UZXN0UnVuU3RhcnRlZCIsImRvbmUiLCJmb3JjZWQiLCJfb25UZXN0UnVuRG9uZSIsInJlYWR5VG9OZXh0IiwiX29uVGVzdFJ1blJlYWR5VG9OZXh0Iiwic2V0RXhwZWN0ZWRUZXN0Q291bnQiLCJ0ZXN0Q291bnQiLCJydW4iLCJyZWFkeVRvTmV4dFByb21pc2VzIiwiZm9yRWFjaCIsInRlc3RXcmFwcGVyIiwidGVzdFJ1bnMiLCJmaW5pc2giLCJwdXNoIiwicmVhZHlUb05leHRQcm9taXNlIiwiUHJvbWlzZSIsImFsbCIsInN0b3AiLCJydW5uaW5nVGVzdFdyYXBwZXJzIiwiZmlsdGVyIiwidyIsInN0YXRlIiwiVEVTVF9TVEFURSIsInJ1bm5pbmciLCJfZ2V0VGVzdFdyYXBwZXIiLCJ0ZXN0IiwiZmluZCIsIlRFU1RfUlVOX1NUQVRFIiwid2FpdGluZ0ZvckRvbmUiLCJ3YWl0aW5nVGVzdFJ1bkNvdW50IiwibGVuZ3RoIiwicnVubmluZ1Rlc3RSdW5Db3VudCIsIndhaXRGb3JPdGhlclRlc3RSdW5zIiwic2V0VGltZW91dCIsImhhc1Rlc3RzVG9SdW4iLCJzb21lIiwicXVhcmFudGluZSIsImlzVGhyZXNob2xkUmVhY2hlZCIsImVtaXQiLCJyZXNvbHZlIiwic2V0UmVhZHlUb05leHQiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxN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QUosQ0FBWXdCLFdBQVc7QUFDMUIzQyxvQkFBUWdCLE1BQVIsR0FBaUIsTUFBTTtBQUNuQmhCLHdCQUFRZ0IsTUFBUixHQUFpQixJQUFqQjtBQUNBaEIsd0JBQVF5QixLQUFSLEdBQWlCTSw2QkFBZTNCLElBQWhDO0FBQ0F1QztBQUNILGFBSkQ7QUFLSCxTQU5NLENBQVA7QUFPSDs7QUFFRG5DLDBCQUF1QlIsT0FBdkIsRUFBZ0M7QUFDNUJBLGdCQUFRNEMsY0FBUjtBQUNIO0FBMUhnRDs7a0JBNkh0Q3RELHlCIiwiZmlsZSI6ImxpdmUvdGVzdC1ydW4tY29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRzJztcbmltcG9ydCBQcm9taXNlIGZyb20gJ3BpbmtpZSc7XG5pbXBvcnQgeyBUZXN0UnVuQ3RvckZhY3RvcnkgfSBmcm9tICcuL3Rlc3QtcnVuJztcbmltcG9ydCB7IFRFU1RfU1RBVEUsIFRFU1RfUlVOX1NUQVRFIH0gZnJvbSAnLi90ZXN0LXJ1bi1zdGF0ZSc7XG5cbmNsYXNzIExpdmVNb2RlVGVzdFJ1bkNvbnRyb2xsZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIGNvbnN0cnVjdG9yICgpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLlJVTl9GSU5JU0hFRF9FVkVOVCA9ICdydW4tZmluaXNoZWQtZXZlbnQnO1xuICAgICAgICB0aGlzLlJVTl9TVE9QUEVEX0VWRU5UICA9ICdydW4tc3RvcHBlZC1ldmVudCc7XG5cbiAgICAgICAgdGhpcy50ZXN0V3JhcHBlcnMgICAgICA9IFtdO1xuICAgICAgICB0aGlzLmV4cGVjdGVkVGVzdENvdW50ID0gMDtcbiAgICAgICAgdGhpcy5fdGVzdFJ1bkN0b3IgICAgICA9IG51bGw7XG4gICAgfVxuXG4gICAgZ2V0IFRlc3RSdW5DdG9yICgpIHtcbiAgICAgICAgaWYgKCF0aGlzLl90ZXN0UnVuQ3Rvcikge1xuICAgICAgICAgICAgdGhpcy5fdGVzdFJ1bkN0b3IgPSBUZXN0UnVuQ3RvckZhY3Rvcnkoe1xuICAgICAgICAgICAgICAgIGNyZWF0ZWQ6ICAgICB0ZXN0UnVuID0+IHRoaXMuX29uVGVzdFJ1bkNyZWF0ZWQodGVzdFJ1biksXG4gICAgICAgICAgICAgICAgc3RhcnRlZDogICAgIHRlc3RSdW4gPT4gdGhpcy5fb25UZXN0UnVuU3RhcnRlZCh0ZXN0UnVuKSxcbiAgICAgICAgICAgICAgICBkb25lOiAgICAgICAgKHRlc3RSdW4sIGZvcmNlZCkgPT4gdGhpcy5fb25UZXN0UnVuRG9uZSh0ZXN0UnVuLCBmb3JjZWQpLFxuICAgICAgICAgICAgICAgIHJlYWR5VG9OZXh0OiB0ZXN0UnVuID0+IHRoaXMuX29uVGVzdFJ1blJlYWR5VG9OZXh0KHRlc3RSdW4pXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLl90ZXN0UnVuQ3RvcjtcbiAgICB9XG5cbiAgICBzZXRFeHBlY3RlZFRlc3RDb3VudCAodGVzdENvdW50KSB7XG4gICAgICAgIHRoaXMuZXhwZWN0ZWRUZXN0Q291bnQgPSB0ZXN0Q291bnQ7XG4gICAgfVxuXG4gICAgcnVuICgpIHtcbiAgICAgICAgY29uc3QgcmVhZHlUb05leHRQcm9taXNlcyA9IFtdO1xuXG4gICAgICAgIHRoaXMudGVzdFdyYXBwZXJzLmZvckVhY2godGVzdFdyYXBwZXIgPT4ge1xuICAgICAgICAgICAgdGVzdFdyYXBwZXIudGVzdFJ1bnMuZm9yRWFjaCh0ZXN0UnVuID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGVzdFJ1bi5maW5pc2gpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVhZHlUb05leHRQcm9taXNlcy5wdXNoKHRlc3RSdW4ucmVhZHlUb05leHRQcm9taXNlKTtcbiAgICAgICAgICAgICAgICAgICAgdGVzdFJ1bi5maW5pc2goKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy50ZXN0V3JhcHBlcnMgPSBbXTtcblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocmVhZHlUb05leHRQcm9taXNlcyk7XG4gICAgfVxuXG4gICAgc3RvcCAoKSB7XG4gICAgICAgIGNvbnN0IHJ1bm5pbmdUZXN0V3JhcHBlcnMgPSB0aGlzLnRlc3RXcmFwcGVycy5maWx0ZXIodyA9PiB3LnN0YXRlID09PSBURVNUX1NUQVRFLnJ1bm5pbmcpO1xuXG4gICAgICAgIHJ1bm5pbmdUZXN0V3JhcHBlcnMuZm9yRWFjaCh0ZXN0V3JhcHBlciA9PiB7XG4gICAgICAgICAgICB0ZXN0V3JhcHBlci50ZXN0UnVucy5mb3JFYWNoKHRlc3RSdW4gPT4gdGVzdFJ1bi5zdG9wKCkpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfZ2V0VGVzdFdyYXBwZXIgKHRlc3QpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudGVzdFdyYXBwZXJzLmZpbmQodyA9PiB3LnRlc3QgPT09IHRlc3QpO1xuICAgIH1cblxuICAgIF9vblRlc3RSdW5DcmVhdGVkICh0ZXN0UnVuKSB7XG4gICAgICAgIGxldCB0ZXN0V3JhcHBlciA9IHRoaXMuX2dldFRlc3RXcmFwcGVyKHRlc3RSdW4udGVzdCk7XG5cbiAgICAgICAgaWYgKCF0ZXN0V3JhcHBlcikge1xuICAgICAgICAgICAgdGVzdFdyYXBwZXIgPSB7XG4gICAgICAgICAgICAgICAgdGVzdDogICAgIHRlc3RSdW4udGVzdCxcbiAgICAgICAgICAgICAgICBzdGF0ZTogICAgVEVTVF9TVEFURS5jcmVhdGVkLFxuICAgICAgICAgICAgICAgIHRlc3RSdW5zOiBbXVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgdGhpcy50ZXN0V3JhcHBlcnMucHVzaCh0ZXN0V3JhcHBlcik7XG4gICAgICAgIH1cblxuICAgICAgICB0ZXN0V3JhcHBlci50ZXN0UnVucy5wdXNoKHRlc3RSdW4pO1xuXG4gICAgICAgIHRlc3RSdW4udGVzdFdyYXBwZXIgPSB0ZXN0V3JhcHBlcjtcbiAgICB9XG5cbiAgICBfb25UZXN0UnVuU3RhcnRlZCAodGVzdFJ1bikge1xuICAgICAgICB0ZXN0UnVuLnN0YXRlICAgICAgICAgICAgID0gVEVTVF9SVU5fU1RBVEUucnVubmluZztcbiAgICAgICAgdGVzdFJ1bi50ZXN0V3JhcHBlci5zdGF0ZSA9IFRFU1RfU1RBVEUucnVubmluZztcbiAgICB9XG5cbiAgICBfb25UZXN0UnVuRG9uZSAodGVzdFJ1biwgZm9yY2VkKSB7XG4gICAgICAgIGNvbnN0IHRlc3RXcmFwcGVyID0gdGVzdFJ1bi50ZXN0V3JhcHBlcjtcblxuICAgICAgICB0ZXN0UnVuLnN0YXRlID0gVEVTVF9SVU5fU1RBVEUud2FpdGluZ0ZvckRvbmU7XG5cbiAgICAgICAgY29uc3Qgd2FpdGluZ1Rlc3RSdW5Db3VudCA9IHRlc3RXcmFwcGVyLnRlc3RSdW5zLmZpbHRlcih3ID0+IHcuc3RhdGUgPT09IFRFU1RfUlVOX1NUQVRFLmNyZWF0ZWQpLmxlbmd0aDtcbiAgICAgICAgY29uc3QgcnVubmluZ1Rlc3RSdW5Db3VudCA9IHRlc3RXcmFwcGVyLnRlc3RSdW5zLmZpbHRlcih3ID0+IHcuc3RhdGUgPT09IFRFU1RfUlVOX1NUQVRFLnJ1bm5pbmcpLmxlbmd0aDtcblxuICAgICAgICBjb25zdCB3YWl0Rm9yT3RoZXJUZXN0UnVucyA9IHJ1bm5pbmdUZXN0UnVuQ291bnQgfHwgd2FpdGluZ1Rlc3RSdW5Db3VudCAmJiAhZm9yY2VkO1xuXG4gICAgICAgIGlmICghd2FpdEZvck90aGVyVGVzdFJ1bnMpIHtcbiAgICAgICAgICAgIHRlc3RXcmFwcGVyLnN0YXRlID0gVEVTVF9TVEFURS5kb25lO1xuXG4gICAgICAgICAgICAvL2NoZWNrIG90aGVyIGFjdGl2ZSB0ZXN0c1xuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgaGFzVGVzdHNUb1J1biA9IHRoaXMudGVzdFdyYXBwZXJzLmxlbmd0aCA8IHRoaXMuZXhwZWN0ZWRUZXN0Q291bnQgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50ZXN0V3JhcHBlcnMuc29tZSh3ID0+IHcuc3RhdGUgPT09IFRFU1RfU1RBVEUuY3JlYXRlZCkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVzdFJ1bi5xdWFyYW50aW5lICYmICF0ZXN0UnVuLnF1YXJhbnRpbmUuaXNUaHJlc2hvbGRSZWFjaGVkKCk7XG5cbiAgICAgICAgICAgICAgICBpZiAoIWZvcmNlZCAmJiBoYXNUZXN0c1RvUnVuKVxuICAgICAgICAgICAgICAgICAgICB0ZXN0V3JhcHBlci50ZXN0UnVucy5mb3JFYWNoKHcgPT4gdy5maW5pc2goKSk7XG4gICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmVtaXQoZm9yY2VkID8gdGhpcy5SVU5fU1RPUFBFRF9FVkVOVCA6IHRoaXMuUlVOX0ZJTklTSEVEX0VWRU5UKTtcbiAgICAgICAgICAgIH0sIDApO1xuICAgICAgICB9XG5cbiAgICAgICAgdGVzdFJ1bi5yZWFkeVRvTmV4dFByb21pc2UgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgICAgIHRlc3RSdW4uc2V0UmVhZHlUb05leHQgPSByZXNvbHZlO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICAgICAgICB0ZXN0UnVuLmZpbmlzaCA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0ZXN0UnVuLmZpbmlzaCA9IG51bGw7XG4gICAgICAgICAgICAgICAgdGVzdFJ1bi5zdGF0ZSAgPSBURVNUX1JVTl9TVEFURS5kb25lO1xuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIF9vblRlc3RSdW5SZWFkeVRvTmV4dCAodGVzdFJ1bikge1xuICAgICAgICB0ZXN0UnVuLnNldFJlYWR5VG9OZXh0KCk7XG4gICAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBMaXZlTW9kZVRlc3RSdW5Db250cm9sbGVyO1xuIl19
