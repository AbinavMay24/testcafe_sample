'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _lodash = require('lodash');

var _testRunController = require('./test-run-controller');

var _testRunController2 = _interopRequireDefault(_testRunController);

var _controller = require('./controller');

var _controller2 = _interopRequireDefault(_controller);

var _runner = require('../runner');

var _runner2 = _interopRequireDefault(_runner);

var _bootstrapper = require('./bootstrapper');

var _bootstrapper2 = _interopRequireDefault(_bootstrapper);

var _parseFileList = require('../utils/parse-file-list');

var _parseFileList2 = _interopRequireDefault(_parseFileList);

var _runtime = require('../errors/runtime');

var _message = require('../errors/runtime/message');

var _message2 = _interopRequireDefault(_message);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class LiveModeRunner extends _runner2.default {
    constructor(proxy, browserConnectionGateway, options) {
        super(proxy, browserConnectionGateway, options);

        /* EVENTS */
        this.TEST_RUN_DONE_EVENT = 'test-run-done';
        this.REQUIRED_MODULE_FOUND_EVENT = 'require-module-found';

        this.stopping = false;
        this.tcRunnerTaskPromise = null;
        this.stopInfiniteWaiting = _lodash.noop;
        this.preventRunCall = false;

        this.testRunController = new _testRunController2.default();

        this.embeddingOptions({
            TestRunCtor: this.testRunController.TestRunCtor,
            assets: []
        });

        this.controller = this._createController();
    }

    runTests(isFirstRun = false) {
        let runError = null;

        return this._finishPreviousTestRuns().then(() => {
            return this._validateRunnableConfiguration(isFirstRun);
        }).then(() => {
            this.testRunController.setExpectedTestCount(this.liveConfigurationCache.tests.filter(t => !t.skip).length);
        }).then(() => {
            this.tcRunnerTaskPromise = super.run(this.opts);

            return this.tcRunnerTaskPromise;
        }).catch(err => {
            this.setBootstrappingError(null);

            runError = err;
        }).then(() => {
            this.tcRunnerTaskPromise = null;

            this.emit(this.TEST_RUN_DONE_EVENT, { err: runError });
        });
    }

    _createRunnableConfiguration() {
        if (this.liveConfigurationCache) return _pinkie2.default.resolve(this.liveConfigurationCache);

        return super._createRunnableConfiguration().then(configuration => {
            this.liveConfigurationCache = configuration;

            return configuration;
        });
    }

    setBootstrappingError(err) {
        this.bootstrappingError = err;
    }

    run(options) {
        if (this.preventRunCall) throw new _runtime.GeneralError(_message2.default.cannotRunLiveModeRunnerMultipleTimes);

        this.preventRunCall = true;

        this.opts = (0, _assign2.default)({}, this.opts, options);

        this._setBootstrapperOptions();

        const fileListPromise = (0, _parseFileList2.default)(this.bootstrapper.sources, process.cwd());

        fileListPromise.then(files => this.controller.init(files)).then(() => this._createRunnableConfiguration()).then(() => this.runTests(true));

        return this._waitUntilExit().then(() => {
            if (this.liveConfigurationCache) {
                const browserSet = this.liveConfigurationCache.browserSet;


                if (browserSet) browserSet.browserConnections.forEach(bc => bc.forceIdle());
            }

            this.controller.dispose();
        }).then(() => {
            this.preventRunCall = false;
        });
    }

    suspend() {
        if (!this.tcRunnerTaskPromise) return _pinkie2.default.resolve();

        return new _pinkie2.default(resolve => {
            this.testRunController.once(this.testRunController.RUN_STOPPED_EVENT, () => {
                this.stopping = false;
                resolve();

                this.emit(this.TEST_RUN_DONE_EVENT, {});
            });

            this.stopping = true;
            this.testRunController.stop();
            this.tcRunnerTaskPromise.cancel();
        });
    }

    exit() {
        if (this.tcRunnerTaskPromise) this.tcRunnerTaskPromise.cancel();

        return _pinkie2.default.resolve().then(() => this.stopInfiniteWaiting());
    }

    _finishPreviousTestRuns() {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this.liveConfigurationCache.tests) return;

            _this.testRunController.run();
        })();
    }

    _validateRunnableConfiguration(isFirstRun) {
        if (isFirstRun) {
            if (this.bootstrappingError) return _pinkie2.default.reject(this.bootstrappingError);

            return _pinkie2.default.resolve();
        }

        return this.bootstrapper._getTests().then(tests => {
            this.liveConfigurationCache.tests = tests;

            return this.bootstrappingError ? _pinkie2.default.reject(this.bootstrappingError) : _pinkie2.default.resolve();
        });
    }

    _createTask(tests, browserConnectionGroups, proxy, opts) {
        opts.live = true;

        return super._createTask(tests, browserConnectionGroups, proxy, opts);
    }

    _createBootstrapper(browserConnectionGateway) {
        return new _bootstrapper2.default(this, browserConnectionGateway);
    }

    _createController() {
        return new _controller2.default(this);
    }

    _waitUntilExit() {
        return new _pinkie2.default(resolve => {
            this.stopInfiniteWaiting = resolve;
        });
    }

    _disposeBrowserSet() {
        return _pinkie2.default.resolve();
    }
}

exports.default = LiveModeRunner;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saXZlL3Rlc3QtcnVubmVyLmpzIl0sIm5hbWVzIjpbIkxpdmVNb2RlUnVubmVyIiwiUnVubmVyIiwiY29uc3RydWN0b3IiLCJwcm94eSIsImJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSIsIm9wdGlvbnMiLCJURVNUX1JVTl9ET05FX0VWRU5UIiwiUkVRVUlSRURfTU9EVUxFX0ZPVU5EX0VWRU5UIiwic3RvcHBpbmciLCJ0Y1J1bm5lclRhc2tQcm9taXNlIiwic3RvcEluZmluaXRlV2FpdGluZyIsIm5vb3AiLCJwcmV2ZW50UnVuQ2FsbCIsInRlc3RSdW5Db250cm9sbGVyIiwiTGl2ZU1vZGVUZXN0UnVuQ29udHJvbGxlciIsImVtYmVkZGluZ09wdGlvbnMiLCJUZXN0UnVuQ3RvciIsImFzc2V0cyIsImNvbnRyb2xsZXIiLCJfY3JlYXRlQ29udHJvbGxlciIsInJ1blRlc3RzIiwiaXNGaXJzdFJ1biIsInJ1bkVycm9yIiwiX2ZpbmlzaFByZXZpb3VzVGVzdFJ1bnMiLCJ0aGVuIiwiX3ZhbGlkYXRlUnVubmFibGVDb25maWd1cmF0aW9uIiwic2V0RXhwZWN0ZWRUZXN0Q291bnQiLCJsaXZlQ29uZmlndXJhdGlvbkNhY2hlIiwidGVzdHMiLCJmaWx0ZXIiLCJ0Iiwic2tpcCIsImxlbmd0aCIsInJ1biIsIm9wdHMiLCJjYXRjaCIsImVyciIsInNldEJvb3RzdHJhcHBpbmdFcnJvciIsImVtaXQiLCJfY3JlYXRlUnVubmFibGVDb25maWd1cmF0aW9uIiwiUHJvbWlzZSIsInJlc29sdmUiLCJjb25maWd1cmF0aW9uIiwiYm9vdHN0cmFwcGluZ0Vycm9yIiwiR2VuZXJhbEVycm9yIiwiTUVTU0FHRSIsImNhbm5vdFJ1bkxpdmVNb2RlUnVubmVyTXVsdGlwbGVUaW1lcyIsIl9zZXRCb290c3RyYXBwZXJPcHRpb25zIiwiZmlsZUxpc3RQcm9taXNlIiwiYm9vdHN0cmFwcGVyIiwic291cmNlcyIsInByb2Nlc3MiLCJjd2QiLCJmaWxlcyIsImluaXQiLCJfd2FpdFVudGlsRXhpdCIsImJyb3dzZXJTZXQiLCJicm93c2VyQ29ubmVjdGlvbnMiLCJmb3JFYWNoIiwiYmMiLCJmb3JjZUlkbGUiLCJkaXNwb3NlIiwic3VzcGVuZCIsIm9uY2UiLCJSVU5fU1RPUFBFRF9FVkVOVCIsInN0b3AiLCJjYW5jZWwiLCJleGl0IiwicmVqZWN0IiwiX2dldFRlc3RzIiwiX2NyZWF0ZVRhc2siLCJicm93c2VyQ29ubmVjdGlvbkdyb3VwcyIsImxpdmUiLCJfY3JlYXRlQm9vdHN0cmFwcGVyIiwiTGl2ZU1vZGVCb290c3RyYXBwZXIiLCJMaXZlTW9kZUNvbnRyb2xsZXIiLCJfZGlzcG9zZUJyb3dzZXJTZXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOzs7Ozs7QUFFQSxNQUFNQSxjQUFOLFNBQTZCQyxnQkFBN0IsQ0FBb0M7QUFDaENDLGdCQUFhQyxLQUFiLEVBQW9CQyx3QkFBcEIsRUFBOENDLE9BQTlDLEVBQXVEO0FBQ25ELGNBQU1GLEtBQU4sRUFBYUMsd0JBQWIsRUFBdUNDLE9BQXZDOztBQUVBO0FBQ0EsYUFBS0MsbUJBQUwsR0FBbUMsZUFBbkM7QUFDQSxhQUFLQywyQkFBTCxHQUFtQyxzQkFBbkM7O0FBRUEsYUFBS0MsUUFBTCxHQUEyQixLQUEzQjtBQUNBLGFBQUtDLG1CQUFMLEdBQTJCLElBQTNCO0FBQ0EsYUFBS0MsbUJBQUwsR0FBMkJDLFlBQTNCO0FBQ0EsYUFBS0MsY0FBTCxHQUEyQixLQUEzQjs7QUFFQSxhQUFLQyxpQkFBTCxHQUF5QixJQUFJQywyQkFBSixFQUF6Qjs7QUFFQSxhQUFLQyxnQkFBTCxDQUFzQjtBQUNsQkMseUJBQWEsS0FBS0gsaUJBQUwsQ0FBdUJHLFdBRGxCO0FBRWxCQyxvQkFBYTtBQUZLLFNBQXRCOztBQUtBLGFBQUtDLFVBQUwsR0FBa0IsS0FBS0MsaUJBQUwsRUFBbEI7QUFDSDs7QUFFREMsYUFBVUMsYUFBYSxLQUF2QixFQUE4QjtBQUMxQixZQUFJQyxXQUFXLElBQWY7O0FBRUEsZUFBTyxLQUFLQyx1QkFBTCxHQUNGQyxJQURFLENBQ0csTUFBTTtBQUNSLG1CQUFPLEtBQUtDLDhCQUFMLENBQW9DSixVQUFwQyxDQUFQO0FBQ0gsU0FIRSxFQUlGRyxJQUpFLENBSUcsTUFBTTtBQUNSLGlCQUFLWCxpQkFBTCxDQUF1QmEsb0JBQXZCLENBQTRDLEtBQUtDLHNCQUFMLENBQTRCQyxLQUE1QixDQUFrQ0MsTUFBbEMsQ0FBeUNDLEtBQUssQ0FBQ0EsRUFBRUMsSUFBakQsRUFBdURDLE1BQW5HO0FBQ0gsU0FORSxFQU9GUixJQVBFLENBT0csTUFBTTtBQUNSLGlCQUFLZixtQkFBTCxHQUEyQixNQUFNd0IsR0FBTixDQUFVLEtBQUtDLElBQWYsQ0FBM0I7O0FBRUEsbUJBQU8sS0FBS3pCLG1CQUFaO0FBQ0gsU0FYRSxFQVlGMEIsS0FaRSxDQVlJQyxPQUFPO0FBQ1YsaUJBQUtDLHFCQUFMLENBQTJCLElBQTNCOztBQUVBZix1QkFBV2MsR0FBWDtBQUNILFNBaEJFLEVBaUJGWixJQWpCRSxDQWlCRyxNQUFNO0FBQ1IsaUJBQUtmLG1CQUFMLEdBQTJCLElBQTNCOztBQUVBLGlCQUFLNkIsSUFBTCxDQUFVLEtBQUtoQyxtQkFBZixFQUFvQyxFQUFFOEIsS0FBS2QsUUFBUCxFQUFwQztBQUNILFNBckJFLENBQVA7QUFzQkg7O0FBRURpQixtQ0FBZ0M7QUFDNUIsWUFBSSxLQUFLWixzQkFBVCxFQUNJLE9BQU9hLGlCQUFRQyxPQUFSLENBQWdCLEtBQUtkLHNCQUFyQixDQUFQOztBQUVKLGVBQU8sTUFBTVksNEJBQU4sR0FDRmYsSUFERSxDQUNHa0IsaUJBQWlCO0FBQ25CLGlCQUFLZixzQkFBTCxHQUE4QmUsYUFBOUI7O0FBRUEsbUJBQU9BLGFBQVA7QUFDSCxTQUxFLENBQVA7QUFNSDs7QUFFREwsMEJBQXVCRCxHQUF2QixFQUE0QjtBQUN4QixhQUFLTyxrQkFBTCxHQUEwQlAsR0FBMUI7QUFDSDs7QUFFREgsUUFBSzVCLE9BQUwsRUFBYztBQUNWLFlBQUksS0FBS08sY0FBVCxFQUNJLE1BQU0sSUFBSWdDLHFCQUFKLENBQWlCQyxrQkFBUUMsb0NBQXpCLENBQU47O0FBRUosYUFBS2xDLGNBQUwsR0FBc0IsSUFBdEI7O0FBRUEsYUFBS3NCLElBQUwsR0FBWSxzQkFBYyxFQUFkLEVBQWtCLEtBQUtBLElBQXZCLEVBQTZCN0IsT0FBN0IsQ0FBWjs7QUFFQSxhQUFLMEMsdUJBQUw7O0FBRUEsY0FBTUMsa0JBQWtCLDZCQUFjLEtBQUtDLFlBQUwsQ0FBa0JDLE9BQWhDLEVBQXlDQyxRQUFRQyxHQUFSLEVBQXpDLENBQXhCOztBQUVBSix3QkFDS3hCLElBREwsQ0FDVTZCLFNBQVMsS0FBS25DLFVBQUwsQ0FBZ0JvQyxJQUFoQixDQUFxQkQsS0FBckIsQ0FEbkIsRUFFSzdCLElBRkwsQ0FFVSxNQUFNLEtBQUtlLDRCQUFMLEVBRmhCLEVBR0tmLElBSEwsQ0FHVSxNQUFNLEtBQUtKLFFBQUwsQ0FBYyxJQUFkLENBSGhCOztBQU1BLGVBQU8sS0FBS21DLGNBQUwsR0FDRi9CLElBREUsQ0FDRyxNQUFNO0FBQ1IsZ0JBQUksS0FBS0csc0JBQVQsRUFBaUM7QUFBQSxzQkFDckI2QixVQURxQixHQUNOLEtBQUs3QixzQkFEQyxDQUNyQjZCLFVBRHFCOzs7QUFHN0Isb0JBQUlBLFVBQUosRUFDSUEsV0FBV0Msa0JBQVgsQ0FBOEJDLE9BQTlCLENBQXNDQyxNQUFNQSxHQUFHQyxTQUFILEVBQTVDO0FBQ1A7O0FBRUQsaUJBQUsxQyxVQUFMLENBQWdCMkMsT0FBaEI7QUFDSCxTQVZFLEVBV0ZyQyxJQVhFLENBV0csTUFBTTtBQUNSLGlCQUFLWixjQUFMLEdBQXNCLEtBQXRCO0FBQ0gsU0FiRSxDQUFQO0FBY0g7O0FBRURrRCxjQUFXO0FBQ1AsWUFBSSxDQUFDLEtBQUtyRCxtQkFBVixFQUNJLE9BQU8rQixpQkFBUUMsT0FBUixFQUFQOztBQUVKLGVBQU8sSUFBSUQsZ0JBQUosQ0FBWUMsV0FBVztBQUMxQixpQkFBSzVCLGlCQUFMLENBQXVCa0QsSUFBdkIsQ0FBNEIsS0FBS2xELGlCQUFMLENBQXVCbUQsaUJBQW5ELEVBQXNFLE1BQU07QUFDeEUscUJBQUt4RCxRQUFMLEdBQWdCLEtBQWhCO0FBQ0FpQzs7QUFFQSxxQkFBS0gsSUFBTCxDQUFVLEtBQUtoQyxtQkFBZixFQUFvQyxFQUFwQztBQUNILGFBTEQ7O0FBT0EsaUJBQUtFLFFBQUwsR0FBZ0IsSUFBaEI7QUFDQSxpQkFBS0ssaUJBQUwsQ0FBdUJvRCxJQUF2QjtBQUNBLGlCQUFLeEQsbUJBQUwsQ0FBeUJ5RCxNQUF6QjtBQUNILFNBWE0sQ0FBUDtBQVlIOztBQUVEQyxXQUFRO0FBQ0osWUFBSSxLQUFLMUQsbUJBQVQsRUFDSSxLQUFLQSxtQkFBTCxDQUF5QnlELE1BQXpCOztBQUVKLGVBQU8xQixpQkFBUUMsT0FBUixHQUNGakIsSUFERSxDQUNHLE1BQU0sS0FBS2QsbUJBQUwsRUFEVCxDQUFQO0FBRUg7O0FBRUthLDJCQUFOLEdBQWlDO0FBQUE7O0FBQUE7QUFDN0IsZ0JBQUksQ0FBQyxNQUFLSSxzQkFBTCxDQUE0QkMsS0FBakMsRUFBd0M7O0FBRXhDLGtCQUFLZixpQkFBTCxDQUF1Qm9CLEdBQXZCO0FBSDZCO0FBSWhDOztBQUVEUixtQ0FBZ0NKLFVBQWhDLEVBQTRDO0FBQ3hDLFlBQUlBLFVBQUosRUFBZ0I7QUFDWixnQkFBSSxLQUFLc0Isa0JBQVQsRUFDSSxPQUFPSCxpQkFBUTRCLE1BQVIsQ0FBZSxLQUFLekIsa0JBQXBCLENBQVA7O0FBRUosbUJBQU9ILGlCQUFRQyxPQUFSLEVBQVA7QUFDSDs7QUFFRCxlQUFPLEtBQUtRLFlBQUwsQ0FBa0JvQixTQUFsQixHQUNGN0MsSUFERSxDQUNHSSxTQUFTO0FBQ1gsaUJBQUtELHNCQUFMLENBQTRCQyxLQUE1QixHQUFvQ0EsS0FBcEM7O0FBRUEsbUJBQU8sS0FBS2Usa0JBQUwsR0FBMEJILGlCQUFRNEIsTUFBUixDQUFlLEtBQUt6QixrQkFBcEIsQ0FBMUIsR0FBb0VILGlCQUFRQyxPQUFSLEVBQTNFO0FBQ0gsU0FMRSxDQUFQO0FBTUg7O0FBRUQ2QixnQkFBYTFDLEtBQWIsRUFBb0IyQyx1QkFBcEIsRUFBNkNwRSxLQUE3QyxFQUFvRCtCLElBQXBELEVBQTBEO0FBQ3REQSxhQUFLc0MsSUFBTCxHQUFZLElBQVo7O0FBRUEsZUFBTyxNQUFNRixXQUFOLENBQWtCMUMsS0FBbEIsRUFBeUIyQyx1QkFBekIsRUFBa0RwRSxLQUFsRCxFQUF5RCtCLElBQXpELENBQVA7QUFDSDs7QUFFRHVDLHdCQUFxQnJFLHdCQUFyQixFQUErQztBQUMzQyxlQUFPLElBQUlzRSxzQkFBSixDQUF5QixJQUF6QixFQUErQnRFLHdCQUEvQixDQUFQO0FBQ0g7O0FBRURlLHdCQUFxQjtBQUNqQixlQUFPLElBQUl3RCxvQkFBSixDQUF1QixJQUF2QixDQUFQO0FBQ0g7O0FBRURwQixxQkFBa0I7QUFDZCxlQUFPLElBQUlmLGdCQUFKLENBQVlDLFdBQVc7QUFDMUIsaUJBQUsvQixtQkFBTCxHQUEyQitCLE9BQTNCO0FBQ0gsU0FGTSxDQUFQO0FBR0g7O0FBRURtQyx5QkFBc0I7QUFDbEIsZUFBT3BDLGlCQUFRQyxPQUFSLEVBQVA7QUFDSDtBQTFLK0I7O2tCQTZLckJ6QyxjIiwiZmlsZSI6ImxpdmUvdGVzdC1ydW5uZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUHJvbWlzZSBmcm9tICdwaW5raWUnO1xuaW1wb3J0IHsgbm9vcCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgTGl2ZU1vZGVUZXN0UnVuQ29udHJvbGxlciBmcm9tICcuL3Rlc3QtcnVuLWNvbnRyb2xsZXInO1xuaW1wb3J0IExpdmVNb2RlQ29udHJvbGxlciBmcm9tICcuL2NvbnRyb2xsZXInO1xuaW1wb3J0IFJ1bm5lciBmcm9tICcuLi9ydW5uZXInO1xuaW1wb3J0IExpdmVNb2RlQm9vdHN0cmFwcGVyIGZyb20gJy4vYm9vdHN0cmFwcGVyJztcbmltcG9ydCBwYXJzZUZpbGVMaXN0IGZyb20gJy4uL3V0aWxzL3BhcnNlLWZpbGUtbGlzdCc7XG5pbXBvcnQgeyBHZW5lcmFsRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMvcnVudGltZSc7XG5pbXBvcnQgTUVTU0FHRSBmcm9tICcuLi9lcnJvcnMvcnVudGltZS9tZXNzYWdlJztcblxuY2xhc3MgTGl2ZU1vZGVSdW5uZXIgZXh0ZW5kcyBSdW5uZXIge1xuICAgIGNvbnN0cnVjdG9yIChwcm94eSwgYnJvd3NlckNvbm5lY3Rpb25HYXRld2F5LCBvcHRpb25zKSB7XG4gICAgICAgIHN1cGVyKHByb3h5LCBicm93c2VyQ29ubmVjdGlvbkdhdGV3YXksIG9wdGlvbnMpO1xuXG4gICAgICAgIC8qIEVWRU5UUyAqL1xuICAgICAgICB0aGlzLlRFU1RfUlVOX0RPTkVfRVZFTlQgICAgICAgICA9ICd0ZXN0LXJ1bi1kb25lJztcbiAgICAgICAgdGhpcy5SRVFVSVJFRF9NT0RVTEVfRk9VTkRfRVZFTlQgPSAncmVxdWlyZS1tb2R1bGUtZm91bmQnO1xuXG4gICAgICAgIHRoaXMuc3RvcHBpbmcgICAgICAgICAgICA9IGZhbHNlO1xuICAgICAgICB0aGlzLnRjUnVubmVyVGFza1Byb21pc2UgPSBudWxsO1xuICAgICAgICB0aGlzLnN0b3BJbmZpbml0ZVdhaXRpbmcgPSBub29wO1xuICAgICAgICB0aGlzLnByZXZlbnRSdW5DYWxsICAgICAgPSBmYWxzZTtcblxuICAgICAgICB0aGlzLnRlc3RSdW5Db250cm9sbGVyID0gbmV3IExpdmVNb2RlVGVzdFJ1bkNvbnRyb2xsZXIoKTtcblxuICAgICAgICB0aGlzLmVtYmVkZGluZ09wdGlvbnMoe1xuICAgICAgICAgICAgVGVzdFJ1bkN0b3I6IHRoaXMudGVzdFJ1bkNvbnRyb2xsZXIuVGVzdFJ1bkN0b3IsXG4gICAgICAgICAgICBhc3NldHM6ICAgICAgW11cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5jb250cm9sbGVyID0gdGhpcy5fY3JlYXRlQ29udHJvbGxlcigpO1xuICAgIH1cblxuICAgIHJ1blRlc3RzIChpc0ZpcnN0UnVuID0gZmFsc2UpIHtcbiAgICAgICAgbGV0IHJ1bkVycm9yID0gbnVsbDtcblxuICAgICAgICByZXR1cm4gdGhpcy5fZmluaXNoUHJldmlvdXNUZXN0UnVucygpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3ZhbGlkYXRlUnVubmFibGVDb25maWd1cmF0aW9uKGlzRmlyc3RSdW4pO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnRlc3RSdW5Db250cm9sbGVyLnNldEV4cGVjdGVkVGVzdENvdW50KHRoaXMubGl2ZUNvbmZpZ3VyYXRpb25DYWNoZS50ZXN0cy5maWx0ZXIodCA9PiAhdC5za2lwKS5sZW5ndGgpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnRjUnVubmVyVGFza1Byb21pc2UgPSBzdXBlci5ydW4odGhpcy5vcHRzKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnRjUnVubmVyVGFza1Byb21pc2U7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRCb290c3RyYXBwaW5nRXJyb3IobnVsbCk7XG5cbiAgICAgICAgICAgICAgICBydW5FcnJvciA9IGVycjtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy50Y1J1bm5lclRhc2tQcm9taXNlID0gbnVsbDtcblxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdCh0aGlzLlRFU1RfUlVOX0RPTkVfRVZFTlQsIHsgZXJyOiBydW5FcnJvciB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIF9jcmVhdGVSdW5uYWJsZUNvbmZpZ3VyYXRpb24gKCkge1xuICAgICAgICBpZiAodGhpcy5saXZlQ29uZmlndXJhdGlvbkNhY2hlKVxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0aGlzLmxpdmVDb25maWd1cmF0aW9uQ2FjaGUpO1xuXG4gICAgICAgIHJldHVybiBzdXBlci5fY3JlYXRlUnVubmFibGVDb25maWd1cmF0aW9uKClcbiAgICAgICAgICAgIC50aGVuKGNvbmZpZ3VyYXRpb24gPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubGl2ZUNvbmZpZ3VyYXRpb25DYWNoZSA9IGNvbmZpZ3VyYXRpb247XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gY29uZmlndXJhdGlvbjtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHNldEJvb3RzdHJhcHBpbmdFcnJvciAoZXJyKSB7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGluZ0Vycm9yID0gZXJyO1xuICAgIH1cblxuICAgIHJ1biAob3B0aW9ucykge1xuICAgICAgICBpZiAodGhpcy5wcmV2ZW50UnVuQ2FsbClcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoTUVTU0FHRS5jYW5ub3RSdW5MaXZlTW9kZVJ1bm5lck11bHRpcGxlVGltZXMpO1xuXG4gICAgICAgIHRoaXMucHJldmVudFJ1bkNhbGwgPSB0cnVlO1xuXG4gICAgICAgIHRoaXMub3B0cyA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMub3B0cywgb3B0aW9ucyk7XG5cbiAgICAgICAgdGhpcy5fc2V0Qm9vdHN0cmFwcGVyT3B0aW9ucygpO1xuXG4gICAgICAgIGNvbnN0IGZpbGVMaXN0UHJvbWlzZSA9IHBhcnNlRmlsZUxpc3QodGhpcy5ib290c3RyYXBwZXIuc291cmNlcywgcHJvY2Vzcy5jd2QoKSk7XG5cbiAgICAgICAgZmlsZUxpc3RQcm9taXNlXG4gICAgICAgICAgICAudGhlbihmaWxlcyA9PiB0aGlzLmNvbnRyb2xsZXIuaW5pdChmaWxlcykpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLl9jcmVhdGVSdW5uYWJsZUNvbmZpZ3VyYXRpb24oKSlcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHRoaXMucnVuVGVzdHModHJ1ZSkpO1xuXG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX3dhaXRVbnRpbEV4aXQoKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmxpdmVDb25maWd1cmF0aW9uQ2FjaGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBicm93c2VyU2V0IH0gPSB0aGlzLmxpdmVDb25maWd1cmF0aW9uQ2FjaGU7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGJyb3dzZXJTZXQpXG4gICAgICAgICAgICAgICAgICAgICAgICBicm93c2VyU2V0LmJyb3dzZXJDb25uZWN0aW9ucy5mb3JFYWNoKGJjID0+IGJjLmZvcmNlSWRsZSgpKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZGlzcG9zZSgpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnByZXZlbnRSdW5DYWxsID0gZmFsc2U7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBzdXNwZW5kICgpIHtcbiAgICAgICAgaWYgKCF0aGlzLnRjUnVubmVyVGFza1Byb21pc2UpXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgICAgdGhpcy50ZXN0UnVuQ29udHJvbGxlci5vbmNlKHRoaXMudGVzdFJ1bkNvbnRyb2xsZXIuUlVOX1NUT1BQRURfRVZFTlQsICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0b3BwaW5nID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KHRoaXMuVEVTVF9SVU5fRE9ORV9FVkVOVCwge30pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuc3RvcHBpbmcgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy50ZXN0UnVuQ29udHJvbGxlci5zdG9wKCk7XG4gICAgICAgICAgICB0aGlzLnRjUnVubmVyVGFza1Byb21pc2UuY2FuY2VsKCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGV4aXQgKCkge1xuICAgICAgICBpZiAodGhpcy50Y1J1bm5lclRhc2tQcm9taXNlKVxuICAgICAgICAgICAgdGhpcy50Y1J1bm5lclRhc2tQcm9taXNlLmNhbmNlbCgpO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5zdG9wSW5maW5pdGVXYWl0aW5nKCkpO1xuICAgIH1cblxuICAgIGFzeW5jIF9maW5pc2hQcmV2aW91c1Rlc3RSdW5zICgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmxpdmVDb25maWd1cmF0aW9uQ2FjaGUudGVzdHMpIHJldHVybjtcblxuICAgICAgICB0aGlzLnRlc3RSdW5Db250cm9sbGVyLnJ1bigpO1xuICAgIH1cblxuICAgIF92YWxpZGF0ZVJ1bm5hYmxlQ29uZmlndXJhdGlvbiAoaXNGaXJzdFJ1bikge1xuICAgICAgICBpZiAoaXNGaXJzdFJ1bikge1xuICAgICAgICAgICAgaWYgKHRoaXMuYm9vdHN0cmFwcGluZ0Vycm9yKVxuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCh0aGlzLmJvb3RzdHJhcHBpbmdFcnJvcik7XG5cbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmJvb3RzdHJhcHBlci5fZ2V0VGVzdHMoKVxuICAgICAgICAgICAgLnRoZW4odGVzdHMgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubGl2ZUNvbmZpZ3VyYXRpb25DYWNoZS50ZXN0cyA9IHRlc3RzO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYm9vdHN0cmFwcGluZ0Vycm9yID8gUHJvbWlzZS5yZWplY3QodGhpcy5ib290c3RyYXBwaW5nRXJyb3IpIDogUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfY3JlYXRlVGFzayAodGVzdHMsIGJyb3dzZXJDb25uZWN0aW9uR3JvdXBzLCBwcm94eSwgb3B0cykge1xuICAgICAgICBvcHRzLmxpdmUgPSB0cnVlO1xuXG4gICAgICAgIHJldHVybiBzdXBlci5fY3JlYXRlVGFzayh0ZXN0cywgYnJvd3NlckNvbm5lY3Rpb25Hcm91cHMsIHByb3h5LCBvcHRzKTtcbiAgICB9XG5cbiAgICBfY3JlYXRlQm9vdHN0cmFwcGVyIChicm93c2VyQ29ubmVjdGlvbkdhdGV3YXkpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBMaXZlTW9kZUJvb3RzdHJhcHBlcih0aGlzLCBicm93c2VyQ29ubmVjdGlvbkdhdGV3YXkpO1xuICAgIH1cblxuICAgIF9jcmVhdGVDb250cm9sbGVyICgpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBMaXZlTW9kZUNvbnRyb2xsZXIodGhpcyk7XG4gICAgfVxuXG4gICAgX3dhaXRVbnRpbEV4aXQgKCkge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICAgICAgICB0aGlzLnN0b3BJbmZpbml0ZVdhaXRpbmcgPSByZXNvbHZlO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfZGlzcG9zZUJyb3dzZXJTZXQgKCkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBMaXZlTW9kZVJ1bm5lcjtcbiJdfQ==
