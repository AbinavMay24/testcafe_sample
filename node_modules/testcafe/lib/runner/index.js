'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _path = require('path');

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _promisifyEvent = require('promisify-event');

var _promisifyEvent2 = _interopRequireDefault(_promisifyEvent);

var _mapReverse = require('map-reverse');

var _mapReverse2 = _interopRequireDefault(_mapReverse);

var _events = require('events');

var _lodash = require('lodash');

var _bootstrapper = require('./bootstrapper');

var _bootstrapper2 = _interopRequireDefault(_bootstrapper);

var _reporter = require('../reporter');

var _reporter2 = _interopRequireDefault(_reporter);

var _task = require('./task');

var _task2 = _interopRequireDefault(_task);

var _runtime = require('../errors/runtime');

var _message = require('../errors/runtime/message');

var _message2 = _interopRequireDefault(_message);

var _typeAssertions = require('../errors/runtime/type-assertions');

var _renderForbiddenCharsList = require('../errors/render-forbidden-chars-list');

var _renderForbiddenCharsList2 = _interopRequireDefault(_renderForbiddenCharsList);

var _detectFfmpeg = require('../utils/detect-ffmpeg');

var _detectFfmpeg2 = _interopRequireDefault(_detectFfmpeg);

var _checkFilePath = require('../utils/check-file-path');

var _checkFilePath2 = _interopRequireDefault(_checkFilePath);

var _handleErrors = require('../utils/handle-errors');

var _optionNames = require('../configuration/option-names');

var _optionNames2 = _interopRequireDefault(_optionNames);

var _flagList = require('../utils/flag-list');

var _flagList2 = _interopRequireDefault(_flagList);

var _prepareReporters = require('../utils/prepare-reporters');

var _prepareReporters2 = _interopRequireDefault(_prepareReporters);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEBUG_LOGGER = (0, _debug2.default)('testcafe:runner');

class Runner extends _events.EventEmitter {
    constructor(proxy, browserConnectionGateway, configuration) {
        super();

        this.proxy = proxy;
        this.bootstrapper = this._createBootstrapper(browserConnectionGateway);
        this.pendingTaskPromises = [];
        this.configuration = configuration;
        this.isCli = false;

        this.apiMethodWasCalled = new _flagList2.default({
            initialFlagValue: false,
            flags: [_optionNames2.default.src, _optionNames2.default.browsers, _optionNames2.default.reporter]
        });
    }

    _createBootstrapper(browserConnectionGateway) {
        return new _bootstrapper2.default(browserConnectionGateway);
    }

    _disposeBrowserSet(browserSet) {
        return browserSet.dispose().catch(e => DEBUG_LOGGER(e));
    }

    _disposeReporters(reporters) {
        return _pinkie2.default.all(reporters.map(reporter => reporter.dispose().catch(e => DEBUG_LOGGER(e))));
    }

    _disposeTestedApp(testedApp) {
        return testedApp ? testedApp.kill().catch(e => DEBUG_LOGGER(e)) : _pinkie2.default.resolve();
    }

    _disposeTaskAndRelatedAssets(task, browserSet, reporters, testedApp) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            task.abort();
            task.clearListeners();

            yield _this._disposeAssets(browserSet, reporters, testedApp);
        })();
    }

    _disposeAssets(browserSet, reporters, testedApp) {
        return _pinkie2.default.all([this._disposeBrowserSet(browserSet), this._disposeReporters(reporters), this._disposeTestedApp(testedApp)]);
    }

    _prepareArrayParameter(array) {
        array = (0, _lodash.flattenDeep)(array);

        if (this.isCli) return array.length === 0 ? void 0 : array;

        return array;
    }

    _createCancelablePromise(taskPromise) {
        const promise = taskPromise.then(({ completionPromise }) => completionPromise);
        const removeFromPending = () => (0, _lodash.pull)(this.pendingTaskPromises, promise);

        promise.then(removeFromPending).catch(removeFromPending);

        promise.cancel = () => taskPromise.then(({ cancelTask }) => cancelTask()).then(removeFromPending);

        this.pendingTaskPromises.push(promise);
        return promise;
    }

    // Run task
    _getFailedTestCount(task, reporter) {
        let failedTestCount = reporter.testCount - reporter.passed;

        if (task.opts.stopOnFirstFail && !!failedTestCount) failedTestCount = 1;

        return failedTestCount;
    }

    _getTaskResult(task, browserSet, reporters, testedApp) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            task.on('browser-job-done', function (job) {
                return browserSet.releaseConnection(job.browserConnection);
            });

            const browserSetErrorPromise = (0, _promisifyEvent2.default)(browserSet, 'error');

            const taskDonePromise = task.once('done').then(function () {
                return browserSetErrorPromise.cancel();
            });

            const promises = [taskDonePromise, browserSetErrorPromise];

            if (testedApp) promises.push(testedApp.errorPromise);

            try {
                yield _pinkie2.default.race(promises);
            } catch (err) {
                yield _this2._disposeTaskAndRelatedAssets(task, browserSet, reporters, testedApp);

                throw err;
            }

            yield _this2._disposeAssets(browserSet, reporters, testedApp);

            return _this2._getFailedTestCount(task, reporters[0]);
        })();
    }

    _createTask(tests, browserConnectionGroups, proxy, opts) {
        return new _task2.default(tests, browserConnectionGroups, proxy, opts);
    }

    _runTask(reporterPlugins, browserSet, tests, testedApp) {
        var _this3 = this;

        let completed = false;
        const task = this._createTask(tests, browserSet.browserConnectionGroups, this.proxy, this.configuration.getOptions());
        const reporters = reporterPlugins.map(reporter => new _reporter2.default(reporter.plugin, task, reporter.outStream));
        const completionPromise = this._getTaskResult(task, browserSet, reporters, testedApp);

        task.on('start', _handleErrors.startHandlingTestErrors);

        if (!this.configuration.getOption(_optionNames2.default.skipUncaughtErrors)) {
            task.once('test-run-start', _handleErrors.addRunningTest);
            task.once('test-run-done', _handleErrors.removeRunningTest);
        }

        task.on('done', _handleErrors.stopHandlingTestErrors);

        const setCompleted = () => {
            completed = true;
        };

        completionPromise.then(setCompleted).catch(setCompleted);

        const cancelTask = (() => {
            var _ref = (0, _asyncToGenerator3.default)(function* () {
                if (!completed) yield _this3._disposeTaskAndRelatedAssets(task, browserSet, reporters, testedApp);
            });

            return function cancelTask() {
                return _ref.apply(this, arguments);
            };
        })();

        return { completionPromise, cancelTask };
    }

    _registerAssets(assets) {
        assets.forEach(asset => this.proxy.GET(asset.path, asset.info));
    }

    _validateSpeedOption() {
        const speed = this.configuration.getOption(_optionNames2.default.speed);

        if (speed === void 0) return;

        if (typeof speed !== 'number' || isNaN(speed) || speed < 0.01 || speed > 1) throw new _runtime.GeneralError(_message2.default.invalidSpeedValue);
    }

    _validateConcurrencyOption() {
        const concurrency = this.configuration.getOption(_optionNames2.default.concurrency);

        if (concurrency === void 0) return;

        if (typeof concurrency !== 'number' || isNaN(concurrency) || concurrency < 1) throw new _runtime.GeneralError(_message2.default.invalidConcurrencyFactor);
    }

    _validateProxyBypassOption() {
        let proxyBypass = this.configuration.getOption(_optionNames2.default.proxyBypass);

        if (proxyBypass === void 0) return;

        (0, _typeAssertions.assertType)([_typeAssertions.is.string, _typeAssertions.is.array], null, '"proxyBypass" argument', proxyBypass);

        if (typeof proxyBypass === 'string') proxyBypass = [proxyBypass];

        proxyBypass = proxyBypass.reduce((arr, rules) => {
            (0, _typeAssertions.assertType)(_typeAssertions.is.string, null, '"proxyBypass" argument', rules);

            return arr.concat(rules.split(','));
        }, []);

        this.configuration.mergeOptions({ proxyBypass });
    }

    _validateScreenshotOptions() {
        const screenshotPath = this.configuration.getOption(_optionNames2.default.screenshotPath);
        const screenshotPathPattern = this.configuration.getOption(_optionNames2.default.screenshotPathPattern);

        if (screenshotPath) {
            this._validateScreenshotPath(screenshotPath, 'screenshots base directory path');

            this.configuration.mergeOptions({ [_optionNames2.default.screenshotPath]: (0, _path.resolve)(screenshotPath) });
        }

        if (screenshotPathPattern) this._validateScreenshotPath(screenshotPathPattern, 'screenshots path pattern');

        if (!screenshotPath && screenshotPathPattern) throw new _runtime.GeneralError(_message2.default.cantUseScreenshotPathPatternWithoutBaseScreenshotPathSpecified);
    }

    _validateVideoOptions() {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const videoPath = _this4.configuration.getOption(_optionNames2.default.videoPath);
            const videoEncodingOptions = _this4.configuration.getOption(_optionNames2.default.videoEncodingOptions);

            let videoOptions = _this4.configuration.getOption(_optionNames2.default.videoOptions);

            if (!videoPath) {
                if (videoOptions || videoEncodingOptions) throw new _runtime.GeneralError(_message2.default.cannotSetVideoOptionsWithoutBaseVideoPathSpecified);

                return;
            }

            _this4.configuration.mergeOptions({ [_optionNames2.default.videoPath]: (0, _path.resolve)(videoPath) });

            if (!videoOptions) {
                videoOptions = {};

                _this4.configuration.mergeOptions({ [_optionNames2.default.videoOptions]: videoOptions });
            }

            if (videoOptions.ffmpegPath) videoOptions.ffmpegPath = (0, _path.resolve)(videoOptions.ffmpegPath);else videoOptions.ffmpegPath = yield (0, _detectFfmpeg2.default)();

            if (!videoOptions.ffmpegPath) throw new _runtime.GeneralError(_message2.default.cannotFindFFMPEG);
        })();
    }

    _validateRunOptions() {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            _this5._validateScreenshotOptions();
            yield _this5._validateVideoOptions();
            _this5._validateSpeedOption();
            _this5._validateConcurrencyOption();
            _this5._validateProxyBypassOption();
        })();
    }

    _createRunnableConfiguration() {
        return this.bootstrapper.createRunnableConfiguration();
    }

    _validateScreenshotPath(screenshotPath, pathType) {
        const forbiddenCharsList = (0, _checkFilePath2.default)(screenshotPath);

        if (forbiddenCharsList.length) throw new _runtime.GeneralError(_message2.default.forbiddenCharatersInScreenshotPath, screenshotPath, pathType, (0, _renderForbiddenCharsList2.default)(forbiddenCharsList));
    }

    _setBootstrapperOptions() {
        this.configuration.prepare();
        this.configuration.notifyAboutOverridenOptions();

        this.bootstrapper.sources = this.configuration.getOption(_optionNames2.default.src) || this.bootstrapper.sources;
        this.bootstrapper.browsers = this.configuration.getOption(_optionNames2.default.browsers) || this.bootstrapper.browsers;
        this.bootstrapper.concurrency = this.configuration.getOption(_optionNames2.default.concurrency);
        this.bootstrapper.appCommand = this.configuration.getOption(_optionNames2.default.appCommand) || this.bootstrapper.appCommand;
        this.bootstrapper.appInitDelay = this.configuration.getOption(_optionNames2.default.appInitDelay);
        this.bootstrapper.filter = this.configuration.getOption(_optionNames2.default.filter) || this.bootstrapper.filter;
        this.bootstrapper.reporters = this.configuration.getOption(_optionNames2.default.reporter) || this.bootstrapper.reporters;
    }

    // API
    embeddingOptions(opts) {
        const assets = opts.assets,
              TestRunCtor = opts.TestRunCtor;


        this._registerAssets(assets);
        this.configuration.mergeOptions({ TestRunCtor });

        return this;
    }

    src(...sources) {
        if (this.apiMethodWasCalled.src) throw new _runtime.GeneralError(_message2.default.multipleAPIMethodCallForbidden, _optionNames2.default.src);

        sources = this._prepareArrayParameter(sources);
        this.configuration.mergeOptions({ [_optionNames2.default.src]: sources });

        this.apiMethodWasCalled.src = true;

        return this;
    }

    browsers(...browsers) {
        if (this.apiMethodWasCalled.browsers) throw new _runtime.GeneralError(_message2.default.multipleAPIMethodCallForbidden, _optionNames2.default.browsers);

        browsers = this._prepareArrayParameter(browsers);
        this.configuration.mergeOptions({ browsers });

        this.apiMethodWasCalled.browsers = true;

        return this;
    }

    concurrency(concurrency) {
        this.configuration.mergeOptions({ concurrency });

        return this;
    }

    reporter(name, output) {
        if (this.apiMethodWasCalled.reporter) throw new _runtime.GeneralError(_message2.default.multipleAPIMethodCallForbidden, _optionNames2.default.reporter);

        let reporters = (0, _prepareReporters2.default)(name, output);

        reporters = this._prepareArrayParameter(reporters);

        this.configuration.mergeOptions({ [_optionNames2.default.reporter]: reporters });

        this.apiMethodWasCalled.reporter = true;

        return this;
    }

    filter(filter) {
        this.configuration.mergeOptions({ filter });

        return this;
    }

    useProxy(proxy, proxyBypass) {
        this.configuration.mergeOptions({ proxy, proxyBypass });

        return this;
    }

    screenshots(path, takeOnFails, pattern) {
        this.configuration.mergeOptions({
            [_optionNames2.default.screenshotPath]: path,
            [_optionNames2.default.takeScreenshotsOnFails]: takeOnFails,
            [_optionNames2.default.screenshotPathPattern]: pattern
        });

        return this;
    }

    video(path, options, encodingOptions) {
        this.configuration.mergeOptions({
            [_optionNames2.default.videoPath]: path,
            [_optionNames2.default.videoOptions]: options,
            [_optionNames2.default.videoEncodingOptions]: encodingOptions
        });

        return this;
    }

    startApp(command, initDelay) {
        this.configuration.mergeOptions({
            [_optionNames2.default.appCommand]: command,
            [_optionNames2.default.appInitDelay]: initDelay
        });

        return this;
    }

    run(options = {}) {
        this.apiMethodWasCalled.reset();

        const skipJsErrors = options.skipJsErrors,
              disablePageReloads = options.disablePageReloads,
              quarantineMode = options.quarantineMode,
              debugMode = options.debugMode,
              selectorTimeout = options.selectorTimeout,
              assertionTimeout = options.assertionTimeout,
              pageLoadTimeout = options.pageLoadTimeout,
              speed = options.speed,
              debugOnFail = options.debugOnFail,
              skipUncaughtErrors = options.skipUncaughtErrors,
              stopOnFirstFail = options.stopOnFirstFail;


        this.configuration.mergeOptions({
            skipJsErrors: skipJsErrors,
            disablePageReloads: disablePageReloads,
            quarantineMode: quarantineMode,
            debugMode: debugMode,
            debugOnFail: debugOnFail,
            selectorTimeout: selectorTimeout,
            assertionTimeout: assertionTimeout,
            pageLoadTimeout: pageLoadTimeout,
            speed: speed,
            skipUncaughtErrors: skipUncaughtErrors,
            stopOnFirstFail: stopOnFirstFail
        });

        this._setBootstrapperOptions();

        const runTaskPromise = _pinkie2.default.resolve().then(() => this._validateRunOptions()).then(() => this._createRunnableConfiguration()).then(({ reporterPlugins, browserSet, tests, testedApp }) => {
            this.emit('done-bootstrapping');

            return this._runTask(reporterPlugins, browserSet, tests, testedApp);
        });

        return this._createCancelablePromise(runTaskPromise);
    }

    stop() {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            // NOTE: When taskPromise is cancelled, it is removed from
            // the pendingTaskPromises array, which leads to shifting indexes
            // towards the beginning. So, we must copy the array in order to iterate it,
            // or we can perform iteration from the end to the beginning.
            const cancellationPromises = (0, _mapReverse2.default)(_this6.pendingTaskPromises, function (taskPromise) {
                return taskPromise.cancel();
            });

            yield _pinkie2.default.all(cancellationPromises);
        })();
    }
}
exports.default = Runner;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW5uZXIvaW5kZXguanMiXSwibmFtZXMiOlsiREVCVUdfTE9HR0VSIiwiUnVubmVyIiwiRXZlbnRFbWl0dGVyIiwiY29uc3RydWN0b3IiLCJwcm94eSIsImJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSIsImNvbmZpZ3VyYXRpb24iLCJib290c3RyYXBwZXIiLCJfY3JlYXRlQm9vdHN0cmFwcGVyIiwicGVuZGluZ1Rhc2tQcm9taXNlcyIsImlzQ2xpIiwiYXBpTWV0aG9kV2FzQ2FsbGVkIiwiRmxhZ0xpc3QiLCJpbml0aWFsRmxhZ1ZhbHVlIiwiZmxhZ3MiLCJPUFRJT05fTkFNRVMiLCJzcmMiLCJicm93c2VycyIsInJlcG9ydGVyIiwiQm9vdHN0cmFwcGVyIiwiX2Rpc3Bvc2VCcm93c2VyU2V0IiwiYnJvd3NlclNldCIsImRpc3Bvc2UiLCJjYXRjaCIsImUiLCJfZGlzcG9zZVJlcG9ydGVycyIsInJlcG9ydGVycyIsIlByb21pc2UiLCJhbGwiLCJtYXAiLCJfZGlzcG9zZVRlc3RlZEFwcCIsInRlc3RlZEFwcCIsImtpbGwiLCJyZXNvbHZlIiwiX2Rpc3Bvc2VUYXNrQW5kUmVsYXRlZEFzc2V0cyIsInRhc2siLCJhYm9ydCIsImNsZWFyTGlzdGVuZXJzIiwiX2Rpc3Bvc2VBc3NldHMiLCJfcHJlcGFyZUFycmF5UGFyYW1ldGVyIiwiYXJyYXkiLCJsZW5ndGgiLCJfY3JlYXRlQ2FuY2VsYWJsZVByb21pc2UiLCJ0YXNrUHJvbWlzZSIsInByb21pc2UiLCJ0aGVuIiwiY29tcGxldGlvblByb21pc2UiLCJyZW1vdmVGcm9tUGVuZGluZyIsImNhbmNlbCIsImNhbmNlbFRhc2siLCJwdXNoIiwiX2dldEZhaWxlZFRlc3RDb3VudCIsImZhaWxlZFRlc3RDb3VudCIsInRlc3RDb3VudCIsInBhc3NlZCIsIm9wdHMiLCJzdG9wT25GaXJzdEZhaWwiLCJfZ2V0VGFza1Jlc3VsdCIsIm9uIiwicmVsZWFzZUNvbm5lY3Rpb24iLCJqb2IiLCJicm93c2VyQ29ubmVjdGlvbiIsImJyb3dzZXJTZXRFcnJvclByb21pc2UiLCJ0YXNrRG9uZVByb21pc2UiLCJvbmNlIiwicHJvbWlzZXMiLCJlcnJvclByb21pc2UiLCJyYWNlIiwiZXJyIiwiX2NyZWF0ZVRhc2siLCJ0ZXN0cyIsImJyb3dzZXJDb25uZWN0aW9uR3JvdXBzIiwiVGFzayIsIl9ydW5UYXNrIiwicmVwb3J0ZXJQbHVnaW5zIiwiY29tcGxldGVkIiwiZ2V0T3B0aW9ucyIsIlJlcG9ydGVyIiwicGx1Z2luIiwib3V0U3RyZWFtIiwic3RhcnRIYW5kbGluZ1Rlc3RFcnJvcnMiLCJnZXRPcHRpb24iLCJza2lwVW5jYXVnaHRFcnJvcnMiLCJhZGRSdW5uaW5nVGVzdCIsInJlbW92ZVJ1bm5pbmdUZXN0Iiwic3RvcEhhbmRsaW5nVGVzdEVycm9ycyIsInNldENvbXBsZXRlZCIsIl9yZWdpc3RlckFzc2V0cyIsImFzc2V0cyIsImZvckVhY2giLCJhc3NldCIsIkdFVCIsInBhdGgiLCJpbmZvIiwiX3ZhbGlkYXRlU3BlZWRPcHRpb24iLCJzcGVlZCIsImlzTmFOIiwiR2VuZXJhbEVycm9yIiwiTUVTU0FHRSIsImludmFsaWRTcGVlZFZhbHVlIiwiX3ZhbGlkYXRlQ29uY3VycmVuY3lPcHRpb24iLCJjb25jdXJyZW5jeSIsImludmFsaWRDb25jdXJyZW5jeUZhY3RvciIsIl92YWxpZGF0ZVByb3h5QnlwYXNzT3B0aW9uIiwicHJveHlCeXBhc3MiLCJpcyIsInN0cmluZyIsInJlZHVjZSIsImFyciIsInJ1bGVzIiwiY29uY2F0Iiwic3BsaXQiLCJtZXJnZU9wdGlvbnMiLCJfdmFsaWRhdGVTY3JlZW5zaG90T3B0aW9ucyIsInNjcmVlbnNob3RQYXRoIiwic2NyZWVuc2hvdFBhdGhQYXR0ZXJuIiwiX3ZhbGlkYXRlU2NyZWVuc2hvdFBhdGgiLCJjYW50VXNlU2NyZWVuc2hvdFBhdGhQYXR0ZXJuV2l0aG91dEJhc2VTY3JlZW5zaG90UGF0aFNwZWNpZmllZCIsIl92YWxpZGF0ZVZpZGVvT3B0aW9ucyIsInZpZGVvUGF0aCIsInZpZGVvRW5jb2RpbmdPcHRpb25zIiwidmlkZW9PcHRpb25zIiwiY2Fubm90U2V0VmlkZW9PcHRpb25zV2l0aG91dEJhc2VWaWRlb1BhdGhTcGVjaWZpZWQiLCJmZm1wZWdQYXRoIiwiY2Fubm90RmluZEZGTVBFRyIsIl92YWxpZGF0ZVJ1bk9wdGlvbnMiLCJfY3JlYXRlUnVubmFibGVDb25maWd1cmF0aW9uIiwiY3JlYXRlUnVubmFibGVDb25maWd1cmF0aW9uIiwicGF0aFR5cGUiLCJmb3JiaWRkZW5DaGFyc0xpc3QiLCJmb3JiaWRkZW5DaGFyYXRlcnNJblNjcmVlbnNob3RQYXRoIiwiX3NldEJvb3RzdHJhcHBlck9wdGlvbnMiLCJwcmVwYXJlIiwibm90aWZ5QWJvdXRPdmVycmlkZW5PcHRpb25zIiwic291cmNlcyIsImFwcENvbW1hbmQiLCJhcHBJbml0RGVsYXkiLCJmaWx0ZXIiLCJlbWJlZGRpbmdPcHRpb25zIiwiVGVzdFJ1bkN0b3IiLCJtdWx0aXBsZUFQSU1ldGhvZENhbGxGb3JiaWRkZW4iLCJuYW1lIiwib3V0cHV0IiwidXNlUHJveHkiLCJzY3JlZW5zaG90cyIsInRha2VPbkZhaWxzIiwicGF0dGVybiIsInRha2VTY3JlZW5zaG90c09uRmFpbHMiLCJ2aWRlbyIsIm9wdGlvbnMiLCJlbmNvZGluZ09wdGlvbnMiLCJzdGFydEFwcCIsImNvbW1hbmQiLCJpbml0RGVsYXkiLCJydW4iLCJyZXNldCIsInNraXBKc0Vycm9ycyIsImRpc2FibGVQYWdlUmVsb2FkcyIsInF1YXJhbnRpbmVNb2RlIiwiZGVidWdNb2RlIiwic2VsZWN0b3JUaW1lb3V0IiwiYXNzZXJ0aW9uVGltZW91dCIsInBhZ2VMb2FkVGltZW91dCIsImRlYnVnT25GYWlsIiwicnVuVGFza1Byb21pc2UiLCJlbWl0Iiwic3RvcCIsImNhbmNlbGxhdGlvblByb21pc2VzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7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b0JBLGVBUlE7QUFTNUJuRSxtQkFBb0JBLEtBVFE7QUFVNUJiLGdDQUFvQkEsa0JBVlE7QUFXNUIxQiw2QkFBb0JBO0FBWFEsU0FBaEM7O0FBY0EsYUFBSzJFLHVCQUFMOztBQUVBLGNBQU1pQyxpQkFBaUJ6SSxpQkFBUU0sT0FBUixHQUNsQlksSUFEa0IsQ0FDYixNQUFNLEtBQUtnRixtQkFBTCxFQURPLEVBRWxCaEYsSUFGa0IsQ0FFYixNQUFNLEtBQUtpRiw0QkFBTCxFQUZPLEVBR2xCakYsSUFIa0IsQ0FHYixDQUFDLEVBQUU2QixlQUFGLEVBQW1CckQsVUFBbkIsRUFBK0JpRCxLQUEvQixFQUFzQ3ZDLFNBQXRDLEVBQUQsS0FBdUQ7QUFDekQsaUJBQUtzSSxJQUFMLENBQVUsb0JBQVY7O0FBRUEsbUJBQU8sS0FBSzVGLFFBQUwsQ0FBY0MsZUFBZCxFQUErQnJELFVBQS9CLEVBQTJDaUQsS0FBM0MsRUFBa0R2QyxTQUFsRCxDQUFQO0FBQ0gsU0FQa0IsQ0FBdkI7O0FBU0EsZUFBTyxLQUFLVyx3QkFBTCxDQUE4QjBILGNBQTlCLENBQVA7QUFDSDs7QUFFS0UsUUFBTixHQUFjO0FBQUE7O0FBQUE7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtCQUFNQyx1QkFBdUIsMEJBQVcsT0FBSzlKLG1CQUFoQixFQUFxQztBQUFBLHVCQUFla0MsWUFBWUssTUFBWixFQUFmO0FBQUEsYUFBckMsQ0FBN0I7O0FBRUEsa0JBQU1yQixpQkFBUUMsR0FBUixDQUFZMkksb0JBQVosQ0FBTjtBQVBVO0FBUWI7QUFwYTRDO2tCQUE1QnRLLE0iLCJmaWxlIjoicnVubmVyL2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmVzb2x2ZSBhcyByZXNvbHZlUGF0aCB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IGRlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCBQcm9taXNlIGZyb20gJ3BpbmtpZSc7XG5pbXBvcnQgcHJvbWlzaWZ5RXZlbnQgZnJvbSAncHJvbWlzaWZ5LWV2ZW50JztcbmltcG9ydCBtYXBSZXZlcnNlIGZyb20gJ21hcC1yZXZlcnNlJztcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgeyBmbGF0dGVuRGVlcCBhcyBmbGF0dGVuLCBwdWxsIGFzIHJlbW92ZSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgQm9vdHN0cmFwcGVyIGZyb20gJy4vYm9vdHN0cmFwcGVyJztcbmltcG9ydCBSZXBvcnRlciBmcm9tICcuLi9yZXBvcnRlcic7XG5pbXBvcnQgVGFzayBmcm9tICcuL3Rhc2snO1xuaW1wb3J0IHsgR2VuZXJhbEVycm9yIH0gZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUnO1xuaW1wb3J0IE1FU1NBR0UgZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUvbWVzc2FnZSc7XG5pbXBvcnQgeyBhc3NlcnRUeXBlLCBpcyB9IGZyb20gJy4uL2Vycm9ycy9ydW50aW1lL3R5cGUtYXNzZXJ0aW9ucyc7XG5pbXBvcnQgcmVuZGVyRm9yYmlkZGVuQ2hhcnNMaXN0IGZyb20gJy4uL2Vycm9ycy9yZW5kZXItZm9yYmlkZGVuLWNoYXJzLWxpc3QnO1xuaW1wb3J0IGRldGVjdEZGTVBFRyBmcm9tICcuLi91dGlscy9kZXRlY3QtZmZtcGVnJztcbmltcG9ydCBjaGVja0ZpbGVQYXRoIGZyb20gJy4uL3V0aWxzL2NoZWNrLWZpbGUtcGF0aCc7XG5pbXBvcnQgeyBhZGRSdW5uaW5nVGVzdCwgcmVtb3ZlUnVubmluZ1Rlc3QsIHN0YXJ0SGFuZGxpbmdUZXN0RXJyb3JzLCBzdG9wSGFuZGxpbmdUZXN0RXJyb3JzIH0gZnJvbSAnLi4vdXRpbHMvaGFuZGxlLWVycm9ycyc7XG5pbXBvcnQgT1BUSU9OX05BTUVTIGZyb20gJy4uL2NvbmZpZ3VyYXRpb24vb3B0aW9uLW5hbWVzJztcbmltcG9ydCBGbGFnTGlzdCBmcm9tICcuLi91dGlscy9mbGFnLWxpc3QnO1xuaW1wb3J0IHByZXBhcmVSZXBvcnRlcnMgZnJvbSAnLi4vdXRpbHMvcHJlcGFyZS1yZXBvcnRlcnMnO1xuXG5jb25zdCBERUJVR19MT0dHRVIgPSBkZWJ1ZygndGVzdGNhZmU6cnVubmVyJyk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJ1bm5lciBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gICAgY29uc3RydWN0b3IgKHByb3h5LCBicm93c2VyQ29ubmVjdGlvbkdhdGV3YXksIGNvbmZpZ3VyYXRpb24pIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLnByb3h5ICAgICAgICAgICAgICAgPSBwcm94eTtcbiAgICAgICAgdGhpcy5ib290c3RyYXBwZXIgICAgICAgID0gdGhpcy5fY3JlYXRlQm9vdHN0cmFwcGVyKGJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSk7XG4gICAgICAgIHRoaXMucGVuZGluZ1Rhc2tQcm9taXNlcyA9IFtdO1xuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24gICAgICAgPSBjb25maWd1cmF0aW9uO1xuICAgICAgICB0aGlzLmlzQ2xpICAgICAgICAgICAgICAgPSBmYWxzZTtcblxuICAgICAgICB0aGlzLmFwaU1ldGhvZFdhc0NhbGxlZCA9IG5ldyBGbGFnTGlzdCh7XG4gICAgICAgICAgICBpbml0aWFsRmxhZ1ZhbHVlOiBmYWxzZSxcbiAgICAgICAgICAgIGZsYWdzOiAgICAgICAgICAgIFtPUFRJT05fTkFNRVMuc3JjLCBPUFRJT05fTkFNRVMuYnJvd3NlcnMsIE9QVElPTl9OQU1FUy5yZXBvcnRlcl1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX2NyZWF0ZUJvb3RzdHJhcHBlciAoYnJvd3NlckNvbm5lY3Rpb25HYXRld2F5KSB7XG4gICAgICAgIHJldHVybiBuZXcgQm9vdHN0cmFwcGVyKGJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSk7XG4gICAgfVxuXG4gICAgX2Rpc3Bvc2VCcm93c2VyU2V0IChicm93c2VyU2V0KSB7XG4gICAgICAgIHJldHVybiBicm93c2VyU2V0LmRpc3Bvc2UoKS5jYXRjaChlID0+IERFQlVHX0xPR0dFUihlKSk7XG4gICAgfVxuXG4gICAgX2Rpc3Bvc2VSZXBvcnRlcnMgKHJlcG9ydGVycykge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocmVwb3J0ZXJzLm1hcChyZXBvcnRlciA9PiByZXBvcnRlci5kaXNwb3NlKCkuY2F0Y2goZSA9PiBERUJVR19MT0dHRVIoZSkpKSk7XG4gICAgfVxuXG4gICAgX2Rpc3Bvc2VUZXN0ZWRBcHAgKHRlc3RlZEFwcCkge1xuICAgICAgICByZXR1cm4gdGVzdGVkQXBwID8gdGVzdGVkQXBwLmtpbGwoKS5jYXRjaChlID0+IERFQlVHX0xPR0dFUihlKSkgOiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9XG5cbiAgICBhc3luYyBfZGlzcG9zZVRhc2tBbmRSZWxhdGVkQXNzZXRzICh0YXNrLCBicm93c2VyU2V0LCByZXBvcnRlcnMsIHRlc3RlZEFwcCkge1xuICAgICAgICB0YXNrLmFib3J0KCk7XG4gICAgICAgIHRhc2suY2xlYXJMaXN0ZW5lcnMoKTtcblxuICAgICAgICBhd2FpdCB0aGlzLl9kaXNwb3NlQXNzZXRzKGJyb3dzZXJTZXQsIHJlcG9ydGVycywgdGVzdGVkQXBwKTtcbiAgICB9XG5cbiAgICBfZGlzcG9zZUFzc2V0cyAoYnJvd3NlclNldCwgcmVwb3J0ZXJzLCB0ZXN0ZWRBcHApIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgIHRoaXMuX2Rpc3Bvc2VCcm93c2VyU2V0KGJyb3dzZXJTZXQpLFxuICAgICAgICAgICAgdGhpcy5fZGlzcG9zZVJlcG9ydGVycyhyZXBvcnRlcnMpLFxuICAgICAgICAgICAgdGhpcy5fZGlzcG9zZVRlc3RlZEFwcCh0ZXN0ZWRBcHApXG4gICAgICAgIF0pO1xuICAgIH1cblxuICAgIF9wcmVwYXJlQXJyYXlQYXJhbWV0ZXIgKGFycmF5KSB7XG4gICAgICAgIGFycmF5ID0gZmxhdHRlbihhcnJheSk7XG5cbiAgICAgICAgaWYgKHRoaXMuaXNDbGkpXG4gICAgICAgICAgICByZXR1cm4gYXJyYXkubGVuZ3RoID09PSAwID8gdm9pZCAwIDogYXJyYXk7XG5cbiAgICAgICAgcmV0dXJuIGFycmF5O1xuICAgIH1cblxuICAgIF9jcmVhdGVDYW5jZWxhYmxlUHJvbWlzZSAodGFza1Byb21pc2UpIHtcbiAgICAgICAgY29uc3QgcHJvbWlzZSAgICAgICAgICAgPSB0YXNrUHJvbWlzZS50aGVuKCh7IGNvbXBsZXRpb25Qcm9taXNlIH0pID0+IGNvbXBsZXRpb25Qcm9taXNlKTtcbiAgICAgICAgY29uc3QgcmVtb3ZlRnJvbVBlbmRpbmcgPSAoKSA9PiByZW1vdmUodGhpcy5wZW5kaW5nVGFza1Byb21pc2VzLCBwcm9taXNlKTtcblxuICAgICAgICBwcm9taXNlXG4gICAgICAgICAgICAudGhlbihyZW1vdmVGcm9tUGVuZGluZylcbiAgICAgICAgICAgIC5jYXRjaChyZW1vdmVGcm9tUGVuZGluZyk7XG5cbiAgICAgICAgcHJvbWlzZS5jYW5jZWwgPSAoKSA9PiB0YXNrUHJvbWlzZVxuICAgICAgICAgICAgLnRoZW4oKHsgY2FuY2VsVGFzayB9KSA9PiBjYW5jZWxUYXNrKCkpXG4gICAgICAgICAgICAudGhlbihyZW1vdmVGcm9tUGVuZGluZyk7XG5cbiAgICAgICAgdGhpcy5wZW5kaW5nVGFza1Byb21pc2VzLnB1c2gocHJvbWlzZSk7XG4gICAgICAgIHJldHVybiBwcm9taXNlO1xuICAgIH1cblxuICAgIC8vIFJ1biB0YXNrXG4gICAgX2dldEZhaWxlZFRlc3RDb3VudCAodGFzaywgcmVwb3J0ZXIpIHtcbiAgICAgICAgbGV0IGZhaWxlZFRlc3RDb3VudCA9IHJlcG9ydGVyLnRlc3RDb3VudCAtIHJlcG9ydGVyLnBhc3NlZDtcblxuICAgICAgICBpZiAodGFzay5vcHRzLnN0b3BPbkZpcnN0RmFpbCAmJiAhIWZhaWxlZFRlc3RDb3VudClcbiAgICAgICAgICAgIGZhaWxlZFRlc3RDb3VudCA9IDE7XG5cbiAgICAgICAgcmV0dXJuIGZhaWxlZFRlc3RDb3VudDtcbiAgICB9XG5cbiAgICBhc3luYyBfZ2V0VGFza1Jlc3VsdCAodGFzaywgYnJvd3NlclNldCwgcmVwb3J0ZXJzLCB0ZXN0ZWRBcHApIHtcbiAgICAgICAgdGFzay5vbignYnJvd3Nlci1qb2ItZG9uZScsIGpvYiA9PiBicm93c2VyU2V0LnJlbGVhc2VDb25uZWN0aW9uKGpvYi5icm93c2VyQ29ubmVjdGlvbikpO1xuXG4gICAgICAgIGNvbnN0IGJyb3dzZXJTZXRFcnJvclByb21pc2UgPSBwcm9taXNpZnlFdmVudChicm93c2VyU2V0LCAnZXJyb3InKTtcblxuICAgICAgICBjb25zdCB0YXNrRG9uZVByb21pc2UgPSB0YXNrLm9uY2UoJ2RvbmUnKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gYnJvd3NlclNldEVycm9yUHJvbWlzZS5jYW5jZWwoKSk7XG5cblxuICAgICAgICBjb25zdCBwcm9taXNlcyA9IFtcbiAgICAgICAgICAgIHRhc2tEb25lUHJvbWlzZSxcbiAgICAgICAgICAgIGJyb3dzZXJTZXRFcnJvclByb21pc2VcbiAgICAgICAgXTtcblxuICAgICAgICBpZiAodGVzdGVkQXBwKVxuICAgICAgICAgICAgcHJvbWlzZXMucHVzaCh0ZXN0ZWRBcHAuZXJyb3JQcm9taXNlKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgUHJvbWlzZS5yYWNlKHByb21pc2VzKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9kaXNwb3NlVGFza0FuZFJlbGF0ZWRBc3NldHModGFzaywgYnJvd3NlclNldCwgcmVwb3J0ZXJzLCB0ZXN0ZWRBcHApO1xuXG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCB0aGlzLl9kaXNwb3NlQXNzZXRzKGJyb3dzZXJTZXQsIHJlcG9ydGVycywgdGVzdGVkQXBwKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0RmFpbGVkVGVzdENvdW50KHRhc2ssIHJlcG9ydGVyc1swXSk7XG4gICAgfVxuXG4gICAgX2NyZWF0ZVRhc2sgKHRlc3RzLCBicm93c2VyQ29ubmVjdGlvbkdyb3VwcywgcHJveHksIG9wdHMpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBUYXNrKHRlc3RzLCBicm93c2VyQ29ubmVjdGlvbkdyb3VwcywgcHJveHksIG9wdHMpO1xuICAgIH1cblxuICAgIF9ydW5UYXNrIChyZXBvcnRlclBsdWdpbnMsIGJyb3dzZXJTZXQsIHRlc3RzLCB0ZXN0ZWRBcHApIHtcbiAgICAgICAgbGV0IGNvbXBsZXRlZCAgICAgICAgICAgPSBmYWxzZTtcbiAgICAgICAgY29uc3QgdGFzayAgICAgICAgICAgICAgPSB0aGlzLl9jcmVhdGVUYXNrKHRlc3RzLCBicm93c2VyU2V0LmJyb3dzZXJDb25uZWN0aW9uR3JvdXBzLCB0aGlzLnByb3h5LCB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9ucygpKTtcbiAgICAgICAgY29uc3QgcmVwb3J0ZXJzICAgICAgICAgPSByZXBvcnRlclBsdWdpbnMubWFwKHJlcG9ydGVyID0+IG5ldyBSZXBvcnRlcihyZXBvcnRlci5wbHVnaW4sIHRhc2ssIHJlcG9ydGVyLm91dFN0cmVhbSkpO1xuICAgICAgICBjb25zdCBjb21wbGV0aW9uUHJvbWlzZSA9IHRoaXMuX2dldFRhc2tSZXN1bHQodGFzaywgYnJvd3NlclNldCwgcmVwb3J0ZXJzLCB0ZXN0ZWRBcHApO1xuXG4gICAgICAgIHRhc2sub24oJ3N0YXJ0Jywgc3RhcnRIYW5kbGluZ1Rlc3RFcnJvcnMpO1xuXG4gICAgICAgIGlmICghdGhpcy5jb25maWd1cmF0aW9uLmdldE9wdGlvbihPUFRJT05fTkFNRVMuc2tpcFVuY2F1Z2h0RXJyb3JzKSkge1xuICAgICAgICAgICAgdGFzay5vbmNlKCd0ZXN0LXJ1bi1zdGFydCcsIGFkZFJ1bm5pbmdUZXN0KTtcbiAgICAgICAgICAgIHRhc2sub25jZSgndGVzdC1ydW4tZG9uZScsIHJlbW92ZVJ1bm5pbmdUZXN0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRhc2sub24oJ2RvbmUnLCBzdG9wSGFuZGxpbmdUZXN0RXJyb3JzKTtcblxuICAgICAgICBjb25zdCBzZXRDb21wbGV0ZWQgPSAoKSA9PiB7XG4gICAgICAgICAgICBjb21wbGV0ZWQgPSB0cnVlO1xuICAgICAgICB9O1xuXG4gICAgICAgIGNvbXBsZXRpb25Qcm9taXNlXG4gICAgICAgICAgICAudGhlbihzZXRDb21wbGV0ZWQpXG4gICAgICAgICAgICAuY2F0Y2goc2V0Q29tcGxldGVkKTtcblxuICAgICAgICBjb25zdCBjYW5jZWxUYXNrID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKCFjb21wbGV0ZWQpXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fZGlzcG9zZVRhc2tBbmRSZWxhdGVkQXNzZXRzKHRhc2ssIGJyb3dzZXJTZXQsIHJlcG9ydGVycywgdGVzdGVkQXBwKTtcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4geyBjb21wbGV0aW9uUHJvbWlzZSwgY2FuY2VsVGFzayB9O1xuICAgIH1cblxuICAgIF9yZWdpc3RlckFzc2V0cyAoYXNzZXRzKSB7XG4gICAgICAgIGFzc2V0cy5mb3JFYWNoKGFzc2V0ID0+IHRoaXMucHJveHkuR0VUKGFzc2V0LnBhdGgsIGFzc2V0LmluZm8pKTtcbiAgICB9XG5cbiAgICBfdmFsaWRhdGVTcGVlZE9wdGlvbiAoKSB7XG4gICAgICAgIGNvbnN0IHNwZWVkID0gdGhpcy5jb25maWd1cmF0aW9uLmdldE9wdGlvbihPUFRJT05fTkFNRVMuc3BlZWQpO1xuXG4gICAgICAgIGlmIChzcGVlZCA9PT0gdm9pZCAwKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgIT09ICdudW1iZXInIHx8IGlzTmFOKHNwZWVkKSB8fCBzcGVlZCA8IDAuMDEgfHwgc3BlZWQgPiAxKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihNRVNTQUdFLmludmFsaWRTcGVlZFZhbHVlKTtcbiAgICB9XG5cbiAgICBfdmFsaWRhdGVDb25jdXJyZW5jeU9wdGlvbiAoKSB7XG4gICAgICAgIGNvbnN0IGNvbmN1cnJlbmN5ID0gdGhpcy5jb25maWd1cmF0aW9uLmdldE9wdGlvbihPUFRJT05fTkFNRVMuY29uY3VycmVuY3kpO1xuXG4gICAgICAgIGlmIChjb25jdXJyZW5jeSA9PT0gdm9pZCAwKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGlmICh0eXBlb2YgY29uY3VycmVuY3kgIT09ICdudW1iZXInIHx8IGlzTmFOKGNvbmN1cnJlbmN5KSB8fCBjb25jdXJyZW5jeSA8IDEpXG4gICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKE1FU1NBR0UuaW52YWxpZENvbmN1cnJlbmN5RmFjdG9yKTtcbiAgICB9XG5cbiAgICBfdmFsaWRhdGVQcm94eUJ5cGFzc09wdGlvbiAoKSB7XG4gICAgICAgIGxldCBwcm94eUJ5cGFzcyA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRPcHRpb24oT1BUSU9OX05BTUVTLnByb3h5QnlwYXNzKTtcblxuICAgICAgICBpZiAocHJveHlCeXBhc3MgPT09IHZvaWQgMClcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBhc3NlcnRUeXBlKFsgaXMuc3RyaW5nLCBpcy5hcnJheSBdLCBudWxsLCAnXCJwcm94eUJ5cGFzc1wiIGFyZ3VtZW50JywgcHJveHlCeXBhc3MpO1xuXG4gICAgICAgIGlmICh0eXBlb2YgcHJveHlCeXBhc3MgPT09ICdzdHJpbmcnKVxuICAgICAgICAgICAgcHJveHlCeXBhc3MgPSBbcHJveHlCeXBhc3NdO1xuXG4gICAgICAgIHByb3h5QnlwYXNzID0gcHJveHlCeXBhc3MucmVkdWNlKChhcnIsIHJ1bGVzKSA9PiB7XG4gICAgICAgICAgICBhc3NlcnRUeXBlKGlzLnN0cmluZywgbnVsbCwgJ1wicHJveHlCeXBhc3NcIiBhcmd1bWVudCcsIHJ1bGVzKTtcblxuICAgICAgICAgICAgcmV0dXJuIGFyci5jb25jYXQocnVsZXMuc3BsaXQoJywnKSk7XG4gICAgICAgIH0sIFtdKTtcblxuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ubWVyZ2VPcHRpb25zKHsgcHJveHlCeXBhc3MgfSk7XG4gICAgfVxuXG4gICAgX3ZhbGlkYXRlU2NyZWVuc2hvdE9wdGlvbnMgKCkge1xuICAgICAgICBjb25zdCBzY3JlZW5zaG90UGF0aCAgICAgICAgPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9uKE9QVElPTl9OQU1FUy5zY3JlZW5zaG90UGF0aCk7XG4gICAgICAgIGNvbnN0IHNjcmVlbnNob3RQYXRoUGF0dGVybiA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRPcHRpb24oT1BUSU9OX05BTUVTLnNjcmVlbnNob3RQYXRoUGF0dGVybik7XG5cbiAgICAgICAgaWYgKHNjcmVlbnNob3RQYXRoKSB7XG4gICAgICAgICAgICB0aGlzLl92YWxpZGF0ZVNjcmVlbnNob3RQYXRoKHNjcmVlbnNob3RQYXRoLCAnc2NyZWVuc2hvdHMgYmFzZSBkaXJlY3RvcnkgcGF0aCcpO1xuXG4gICAgICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ubWVyZ2VPcHRpb25zKHsgW09QVElPTl9OQU1FUy5zY3JlZW5zaG90UGF0aF06IHJlc29sdmVQYXRoKHNjcmVlbnNob3RQYXRoKSB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzY3JlZW5zaG90UGF0aFBhdHRlcm4pXG4gICAgICAgICAgICB0aGlzLl92YWxpZGF0ZVNjcmVlbnNob3RQYXRoKHNjcmVlbnNob3RQYXRoUGF0dGVybiwgJ3NjcmVlbnNob3RzIHBhdGggcGF0dGVybicpO1xuXG4gICAgICAgIGlmICghc2NyZWVuc2hvdFBhdGggJiYgc2NyZWVuc2hvdFBhdGhQYXR0ZXJuKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihNRVNTQUdFLmNhbnRVc2VTY3JlZW5zaG90UGF0aFBhdHRlcm5XaXRob3V0QmFzZVNjcmVlbnNob3RQYXRoU3BlY2lmaWVkKTtcbiAgICB9XG5cbiAgICBhc3luYyBfdmFsaWRhdGVWaWRlb09wdGlvbnMgKCkge1xuICAgICAgICBjb25zdCB2aWRlb1BhdGggICAgICAgICAgICA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRPcHRpb24oT1BUSU9OX05BTUVTLnZpZGVvUGF0aCk7XG4gICAgICAgIGNvbnN0IHZpZGVvRW5jb2RpbmdPcHRpb25zID0gdGhpcy5jb25maWd1cmF0aW9uLmdldE9wdGlvbihPUFRJT05fTkFNRVMudmlkZW9FbmNvZGluZ09wdGlvbnMpO1xuXG4gICAgICAgIGxldCB2aWRlb09wdGlvbnMgPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9uKE9QVElPTl9OQU1FUy52aWRlb09wdGlvbnMpO1xuXG4gICAgICAgIGlmICghdmlkZW9QYXRoKSB7XG4gICAgICAgICAgICBpZiAodmlkZW9PcHRpb25zIHx8IHZpZGVvRW5jb2RpbmdPcHRpb25zKVxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoTUVTU0FHRS5jYW5ub3RTZXRWaWRlb09wdGlvbnNXaXRob3V0QmFzZVZpZGVvUGF0aFNwZWNpZmllZCk7XG5cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5tZXJnZU9wdGlvbnMoeyBbT1BUSU9OX05BTUVTLnZpZGVvUGF0aF06IHJlc29sdmVQYXRoKHZpZGVvUGF0aCkgfSk7XG5cbiAgICAgICAgaWYgKCF2aWRlb09wdGlvbnMpIHtcbiAgICAgICAgICAgIHZpZGVvT3B0aW9ucyA9IHt9O1xuXG4gICAgICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ubWVyZ2VPcHRpb25zKHsgW09QVElPTl9OQU1FUy52aWRlb09wdGlvbnNdOiB2aWRlb09wdGlvbnMgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodmlkZW9PcHRpb25zLmZmbXBlZ1BhdGgpXG4gICAgICAgICAgICB2aWRlb09wdGlvbnMuZmZtcGVnUGF0aCA9IHJlc29sdmVQYXRoKHZpZGVvT3B0aW9ucy5mZm1wZWdQYXRoKTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgdmlkZW9PcHRpb25zLmZmbXBlZ1BhdGggPSBhd2FpdCBkZXRlY3RGRk1QRUcoKTtcblxuICAgICAgICBpZiAoIXZpZGVvT3B0aW9ucy5mZm1wZWdQYXRoKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihNRVNTQUdFLmNhbm5vdEZpbmRGRk1QRUcpO1xuICAgIH1cblxuICAgIGFzeW5jIF92YWxpZGF0ZVJ1bk9wdGlvbnMgKCkge1xuICAgICAgICB0aGlzLl92YWxpZGF0ZVNjcmVlbnNob3RPcHRpb25zKCk7XG4gICAgICAgIGF3YWl0IHRoaXMuX3ZhbGlkYXRlVmlkZW9PcHRpb25zKCk7XG4gICAgICAgIHRoaXMuX3ZhbGlkYXRlU3BlZWRPcHRpb24oKTtcbiAgICAgICAgdGhpcy5fdmFsaWRhdGVDb25jdXJyZW5jeU9wdGlvbigpO1xuICAgICAgICB0aGlzLl92YWxpZGF0ZVByb3h5QnlwYXNzT3B0aW9uKCk7XG4gICAgfVxuXG4gICAgX2NyZWF0ZVJ1bm5hYmxlQ29uZmlndXJhdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmJvb3RzdHJhcHBlci5jcmVhdGVSdW5uYWJsZUNvbmZpZ3VyYXRpb24oKTtcbiAgICB9XG5cbiAgICBfdmFsaWRhdGVTY3JlZW5zaG90UGF0aCAoc2NyZWVuc2hvdFBhdGgsIHBhdGhUeXBlKSB7XG4gICAgICAgIGNvbnN0IGZvcmJpZGRlbkNoYXJzTGlzdCA9IGNoZWNrRmlsZVBhdGgoc2NyZWVuc2hvdFBhdGgpO1xuXG4gICAgICAgIGlmIChmb3JiaWRkZW5DaGFyc0xpc3QubGVuZ3RoKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihNRVNTQUdFLmZvcmJpZGRlbkNoYXJhdGVyc0luU2NyZWVuc2hvdFBhdGgsIHNjcmVlbnNob3RQYXRoLCBwYXRoVHlwZSwgcmVuZGVyRm9yYmlkZGVuQ2hhcnNMaXN0KGZvcmJpZGRlbkNoYXJzTGlzdCkpO1xuICAgIH1cblxuICAgIF9zZXRCb290c3RyYXBwZXJPcHRpb25zICgpIHtcbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLnByZXBhcmUoKTtcbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLm5vdGlmeUFib3V0T3ZlcnJpZGVuT3B0aW9ucygpO1xuXG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLnNvdXJjZXMgICAgICA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRPcHRpb24oT1BUSU9OX05BTUVTLnNyYykgfHwgdGhpcy5ib290c3RyYXBwZXIuc291cmNlcztcbiAgICAgICAgdGhpcy5ib290c3RyYXBwZXIuYnJvd3NlcnMgICAgID0gdGhpcy5jb25maWd1cmF0aW9uLmdldE9wdGlvbihPUFRJT05fTkFNRVMuYnJvd3NlcnMpIHx8IHRoaXMuYm9vdHN0cmFwcGVyLmJyb3dzZXJzO1xuICAgICAgICB0aGlzLmJvb3RzdHJhcHBlci5jb25jdXJyZW5jeSAgPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9uKE9QVElPTl9OQU1FUy5jb25jdXJyZW5jeSk7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLmFwcENvbW1hbmQgICA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRPcHRpb24oT1BUSU9OX05BTUVTLmFwcENvbW1hbmQpIHx8IHRoaXMuYm9vdHN0cmFwcGVyLmFwcENvbW1hbmQ7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLmFwcEluaXREZWxheSA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRPcHRpb24oT1BUSU9OX05BTUVTLmFwcEluaXREZWxheSk7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLmZpbHRlciAgICAgICA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRPcHRpb24oT1BUSU9OX05BTUVTLmZpbHRlcikgfHwgdGhpcy5ib290c3RyYXBwZXIuZmlsdGVyO1xuICAgICAgICB0aGlzLmJvb3RzdHJhcHBlci5yZXBvcnRlcnMgICAgPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9uKE9QVElPTl9OQU1FUy5yZXBvcnRlcikgfHwgdGhpcy5ib290c3RyYXBwZXIucmVwb3J0ZXJzO1xuICAgIH1cblxuICAgIC8vIEFQSVxuICAgIGVtYmVkZGluZ09wdGlvbnMgKG9wdHMpIHtcbiAgICAgICAgY29uc3QgeyBhc3NldHMsIFRlc3RSdW5DdG9yIH0gPSBvcHRzO1xuXG4gICAgICAgIHRoaXMuX3JlZ2lzdGVyQXNzZXRzKGFzc2V0cyk7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5tZXJnZU9wdGlvbnMoeyBUZXN0UnVuQ3RvciB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBzcmMgKC4uLnNvdXJjZXMpIHtcbiAgICAgICAgaWYgKHRoaXMuYXBpTWV0aG9kV2FzQ2FsbGVkLnNyYylcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoTUVTU0FHRS5tdWx0aXBsZUFQSU1ldGhvZENhbGxGb3JiaWRkZW4sIE9QVElPTl9OQU1FUy5zcmMpO1xuXG4gICAgICAgIHNvdXJjZXMgPSB0aGlzLl9wcmVwYXJlQXJyYXlQYXJhbWV0ZXIoc291cmNlcyk7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5tZXJnZU9wdGlvbnMoeyBbT1BUSU9OX05BTUVTLnNyY106IHNvdXJjZXMgfSk7XG5cbiAgICAgICAgdGhpcy5hcGlNZXRob2RXYXNDYWxsZWQuc3JjID0gdHJ1ZTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBicm93c2VycyAoLi4uYnJvd3NlcnMpIHtcbiAgICAgICAgaWYgKHRoaXMuYXBpTWV0aG9kV2FzQ2FsbGVkLmJyb3dzZXJzKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihNRVNTQUdFLm11bHRpcGxlQVBJTWV0aG9kQ2FsbEZvcmJpZGRlbiwgT1BUSU9OX05BTUVTLmJyb3dzZXJzKTtcblxuICAgICAgICBicm93c2VycyA9IHRoaXMuX3ByZXBhcmVBcnJheVBhcmFtZXRlcihicm93c2Vycyk7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5tZXJnZU9wdGlvbnMoeyBicm93c2VycyB9KTtcblxuICAgICAgICB0aGlzLmFwaU1ldGhvZFdhc0NhbGxlZC5icm93c2VycyA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgY29uY3VycmVuY3kgKGNvbmN1cnJlbmN5KSB7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5tZXJnZU9wdGlvbnMoeyBjb25jdXJyZW5jeSB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICByZXBvcnRlciAobmFtZSwgb3V0cHV0KSB7XG4gICAgICAgIGlmICh0aGlzLmFwaU1ldGhvZFdhc0NhbGxlZC5yZXBvcnRlcilcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoTUVTU0FHRS5tdWx0aXBsZUFQSU1ldGhvZENhbGxGb3JiaWRkZW4sIE9QVElPTl9OQU1FUy5yZXBvcnRlcik7XG5cbiAgICAgICAgbGV0IHJlcG9ydGVycyA9IHByZXBhcmVSZXBvcnRlcnMobmFtZSwgb3V0cHV0KTtcblxuICAgICAgICByZXBvcnRlcnMgPSB0aGlzLl9wcmVwYXJlQXJyYXlQYXJhbWV0ZXIocmVwb3J0ZXJzKTtcblxuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ubWVyZ2VPcHRpb25zKHsgW09QVElPTl9OQU1FUy5yZXBvcnRlcl06IHJlcG9ydGVycyB9KTtcblxuICAgICAgICB0aGlzLmFwaU1ldGhvZFdhc0NhbGxlZC5yZXBvcnRlciA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgZmlsdGVyIChmaWx0ZXIpIHtcbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLm1lcmdlT3B0aW9ucyh7IGZpbHRlciB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICB1c2VQcm94eSAocHJveHksIHByb3h5QnlwYXNzKSB7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5tZXJnZU9wdGlvbnMoeyBwcm94eSwgcHJveHlCeXBhc3MgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgc2NyZWVuc2hvdHMgKHBhdGgsIHRha2VPbkZhaWxzLCBwYXR0ZXJuKSB7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5tZXJnZU9wdGlvbnMoe1xuICAgICAgICAgICAgW09QVElPTl9OQU1FUy5zY3JlZW5zaG90UGF0aF06ICAgICAgICAgcGF0aCxcbiAgICAgICAgICAgIFtPUFRJT05fTkFNRVMudGFrZVNjcmVlbnNob3RzT25GYWlsc106IHRha2VPbkZhaWxzLFxuICAgICAgICAgICAgW09QVElPTl9OQU1FUy5zY3JlZW5zaG90UGF0aFBhdHRlcm5dOiAgcGF0dGVyblxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICB2aWRlbyAocGF0aCwgb3B0aW9ucywgZW5jb2RpbmdPcHRpb25zKSB7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5tZXJnZU9wdGlvbnMoe1xuICAgICAgICAgICAgW09QVElPTl9OQU1FUy52aWRlb1BhdGhdOiAgICAgICAgICAgIHBhdGgsXG4gICAgICAgICAgICBbT1BUSU9OX05BTUVTLnZpZGVvT3B0aW9uc106ICAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgICAgIFtPUFRJT05fTkFNRVMudmlkZW9FbmNvZGluZ09wdGlvbnNdOiBlbmNvZGluZ09wdGlvbnNcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgc3RhcnRBcHAgKGNvbW1hbmQsIGluaXREZWxheSkge1xuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ubWVyZ2VPcHRpb25zKHtcbiAgICAgICAgICAgIFtPUFRJT05fTkFNRVMuYXBwQ29tbWFuZF06ICAgY29tbWFuZCxcbiAgICAgICAgICAgIFtPUFRJT05fTkFNRVMuYXBwSW5pdERlbGF5XTogaW5pdERlbGF5XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHJ1biAob3B0aW9ucyA9IHt9KSB7XG4gICAgICAgIHRoaXMuYXBpTWV0aG9kV2FzQ2FsbGVkLnJlc2V0KCk7XG5cbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgICAgc2tpcEpzRXJyb3JzLFxuICAgICAgICAgICAgZGlzYWJsZVBhZ2VSZWxvYWRzLFxuICAgICAgICAgICAgcXVhcmFudGluZU1vZGUsXG4gICAgICAgICAgICBkZWJ1Z01vZGUsXG4gICAgICAgICAgICBzZWxlY3RvclRpbWVvdXQsXG4gICAgICAgICAgICBhc3NlcnRpb25UaW1lb3V0LFxuICAgICAgICAgICAgcGFnZUxvYWRUaW1lb3V0LFxuICAgICAgICAgICAgc3BlZWQsXG4gICAgICAgICAgICBkZWJ1Z09uRmFpbCxcbiAgICAgICAgICAgIHNraXBVbmNhdWdodEVycm9ycyxcbiAgICAgICAgICAgIHN0b3BPbkZpcnN0RmFpbFxuICAgICAgICB9ID0gb3B0aW9ucztcblxuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ubWVyZ2VPcHRpb25zKHtcbiAgICAgICAgICAgIHNraXBKc0Vycm9yczogICAgICAgc2tpcEpzRXJyb3JzLFxuICAgICAgICAgICAgZGlzYWJsZVBhZ2VSZWxvYWRzOiBkaXNhYmxlUGFnZVJlbG9hZHMsXG4gICAgICAgICAgICBxdWFyYW50aW5lTW9kZTogICAgIHF1YXJhbnRpbmVNb2RlLFxuICAgICAgICAgICAgZGVidWdNb2RlOiAgICAgICAgICBkZWJ1Z01vZGUsXG4gICAgICAgICAgICBkZWJ1Z09uRmFpbDogICAgICAgIGRlYnVnT25GYWlsLFxuICAgICAgICAgICAgc2VsZWN0b3JUaW1lb3V0OiAgICBzZWxlY3RvclRpbWVvdXQsXG4gICAgICAgICAgICBhc3NlcnRpb25UaW1lb3V0OiAgIGFzc2VydGlvblRpbWVvdXQsXG4gICAgICAgICAgICBwYWdlTG9hZFRpbWVvdXQ6ICAgIHBhZ2VMb2FkVGltZW91dCxcbiAgICAgICAgICAgIHNwZWVkOiAgICAgICAgICAgICAgc3BlZWQsXG4gICAgICAgICAgICBza2lwVW5jYXVnaHRFcnJvcnM6IHNraXBVbmNhdWdodEVycm9ycyxcbiAgICAgICAgICAgIHN0b3BPbkZpcnN0RmFpbDogICAgc3RvcE9uRmlyc3RGYWlsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuX3NldEJvb3RzdHJhcHBlck9wdGlvbnMoKTtcblxuICAgICAgICBjb25zdCBydW5UYXNrUHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZSgpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLl92YWxpZGF0ZVJ1bk9wdGlvbnMoKSlcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHRoaXMuX2NyZWF0ZVJ1bm5hYmxlQ29uZmlndXJhdGlvbigpKVxuICAgICAgICAgICAgLnRoZW4oKHsgcmVwb3J0ZXJQbHVnaW5zLCBicm93c2VyU2V0LCB0ZXN0cywgdGVzdGVkQXBwIH0pID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ2RvbmUtYm9vdHN0cmFwcGluZycpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3J1blRhc2socmVwb3J0ZXJQbHVnaW5zLCBicm93c2VyU2V0LCB0ZXN0cywgdGVzdGVkQXBwKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB0aGlzLl9jcmVhdGVDYW5jZWxhYmxlUHJvbWlzZShydW5UYXNrUHJvbWlzZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgc3RvcCAoKSB7XG4gICAgICAgIC8vIE5PVEU6IFdoZW4gdGFza1Byb21pc2UgaXMgY2FuY2VsbGVkLCBpdCBpcyByZW1vdmVkIGZyb21cbiAgICAgICAgLy8gdGhlIHBlbmRpbmdUYXNrUHJvbWlzZXMgYXJyYXksIHdoaWNoIGxlYWRzIHRvIHNoaWZ0aW5nIGluZGV4ZXNcbiAgICAgICAgLy8gdG93YXJkcyB0aGUgYmVnaW5uaW5nLiBTbywgd2UgbXVzdCBjb3B5IHRoZSBhcnJheSBpbiBvcmRlciB0byBpdGVyYXRlIGl0LFxuICAgICAgICAvLyBvciB3ZSBjYW4gcGVyZm9ybSBpdGVyYXRpb24gZnJvbSB0aGUgZW5kIHRvIHRoZSBiZWdpbm5pbmcuXG4gICAgICAgIGNvbnN0IGNhbmNlbGxhdGlvblByb21pc2VzID0gbWFwUmV2ZXJzZSh0aGlzLnBlbmRpbmdUYXNrUHJvbWlzZXMsIHRhc2tQcm9taXNlID0+IHRhc2tQcm9taXNlLmNhbmNlbCgpKTtcblxuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChjYW5jZWxsYXRpb25Qcm9taXNlcyk7XG4gICAgfVxufVxuIl19
