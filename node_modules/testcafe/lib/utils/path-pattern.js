'use strict';

exports.__esModule = true;

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _lodash = require('lodash');

var _correctFilePath = require('../utils/correct-file-path');

var _correctFilePath2 = _interopRequireDefault(_correctFilePath);

var _escapeUserAgent = require('../utils/escape-user-agent');

var _escapeUserAgent2 = _interopRequireDefault(_escapeUserAgent);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DATE_FORMAT = 'YYYY-MM-DD';
const TIME_FORMAT = 'HH-mm-ss';

const ERRORS_FOLDER = 'errors';

const PLACEHOLDERS = {
    DATE: '${DATE}',
    TIME: '${TIME}',
    TEST_INDEX: '${TEST_INDEX}',
    FILE_INDEX: '${FILE_INDEX}',
    QUARANTINE_ATTEMPT: '${QUARANTINE_ATTEMPT}',
    FIXTURE: '${FIXTURE}',
    TEST: '${TEST}',
    USERAGENT: '${USERAGENT}',
    BROWSER: '${BROWSER}',
    BROWSER_VERSION: '${BROWSER_VERSION}',
    OS: '${OS}',
    OS_VERSION: '${OS_VERSION}',
    TEST_ID: '${TEST_ID}',
    RUN_ID: '${RUN_ID}'
};

const DEFAULT_PATH_PATTERN_FOR_REPORT = `${PLACEHOLDERS.DATE}_${PLACEHOLDERS.TIME}\\${PLACEHOLDERS.TEST_ID}\\` + `${PLACEHOLDERS.RUN_ID}\\${PLACEHOLDERS.USERAGENT}\\${PLACEHOLDERS.FILE_INDEX}`;

const TEST_ID_TEMPLATE = data => data.testIndex ? `test-${data.testIndex}` : '';
const RUN_ID_TEMPLATE = data => data.quarantineAttempt ? `run-${data.quarantineAttempt}` : '';

class PathPattern {
    constructor(pattern, fileExtension, data) {
        this.pattern = this._ensurePattern(pattern);
        this.data = this._addDefaultFields(data);
        this.placeholderToDataMap = this._createPlaceholderToDataMap();
        this.fileExtension = fileExtension;
    }

    _ensurePattern(pattern) {
        if (pattern) return pattern;

        return DEFAULT_PATH_PATTERN_FOR_REPORT;
    }

    _addDefaultFields(data) {
        const defaultFields = {
            testId: TEST_ID_TEMPLATE(data),
            runId: RUN_ID_TEMPLATE(data),
            formattedDate: data.now.format(DATE_FORMAT),
            formattedTime: data.now.format(TIME_FORMAT),
            fileIndex: 1,
            errorFileIndex: 1
        };

        return (0, _assign2.default)({}, defaultFields, data);
    }

    _createPlaceholderToDataMap() {
        return {
            [PLACEHOLDERS.TEST_ID]: this.data.testId,
            [PLACEHOLDERS.RUN_ID]: this.data.runId,
            [PLACEHOLDERS.DATE]: this.data.formattedDate,
            [PLACEHOLDERS.TIME]: this.data.formattedTime,
            [PLACEHOLDERS.TEST_INDEX]: this.data.testIndex,
            [PLACEHOLDERS.QUARANTINE_ATTEMPT]: this.data.quarantineAttempt || 1,
            [PLACEHOLDERS.FIXTURE]: this.data.fixture,
            [PLACEHOLDERS.TEST]: this.data.test,
            [PLACEHOLDERS.FILE_INDEX]: forError => forError ? this.data.errorFileIndex : this.data.fileIndex,
            [PLACEHOLDERS.USERAGENT]: this.data.parsedUserAgent.toString(),
            [PLACEHOLDERS.BROWSER]: this.data.parsedUserAgent.family,
            [PLACEHOLDERS.BROWSER_VERSION]: this.data.parsedUserAgent.toVersion(),
            [PLACEHOLDERS.OS]: this.data.parsedUserAgent.os.family,
            [PLACEHOLDERS.OS_VERSION]: this.data.parsedUserAgent.os.toVersion()
        };
    }

    static _buildPath(pattern, placeholderToDataMap, forError) {
        let resultFilePath = pattern;

        for (const placeholder in placeholderToDataMap) {
            const findPlaceholderRegExp = new RegExp((0, _lodash.escapeRegExp)(placeholder), 'g');

            resultFilePath = resultFilePath.replace(findPlaceholderRegExp, () => {
                if (placeholder === PLACEHOLDERS.FILE_INDEX) {
                    const getFileIndexFn = placeholderToDataMap[placeholder];
                    let result = getFileIndexFn(forError);

                    if (forError) result = `${ERRORS_FOLDER}\\${result}`;

                    return result;
                } else if (placeholder === PLACEHOLDERS.USERAGENT) {
                    const userAgent = placeholderToDataMap[placeholder];

                    return (0, _escapeUserAgent2.default)(userAgent);
                }

                return placeholderToDataMap[placeholder];
            });
        }

        return resultFilePath;
    }

    getPath(forError) {
        const path = PathPattern._buildPath(this.pattern, this.placeholderToDataMap, forError);

        return (0, _correctFilePath2.default)(path, this.fileExtension);
    }

    // For testing purposes
    static get PLACEHOLDERS() {
        return PLACEHOLDERS;
    }
}
exports.default = PathPattern;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9wYXRoLXBhdHRlcm4uanMiXSwibmFtZXMiOlsiREFURV9GT1JNQVQiLCJUSU1FX0ZPUk1BVCIsIkVSUk9SU19GT0xERVIiLCJQTEFDRUhPTERFUlMiLCJEQVRFIiwiVElNRSIsIlRFU1RfSU5ERVgiLCJGSUxFX0lOREVYIiwiUVVBUkFOVElORV9BVFRFTVBUIiwiRklYVFVSRSIsIlRFU1QiLCJVU0VSQUdFTlQiLCJCUk9XU0VSIiwiQlJPV1NFUl9WRVJTSU9OIiwiT1MiLCJPU19WRVJTSU9OIiwiVEVTVF9JRCIsIlJVTl9JRCIsIkRFRkFVTFRfUEFUSF9QQVRURVJOX0ZPUl9SRVBPUlQiLCJURVNUX0lEX1RFTVBMQVRFIiwiZGF0YSIsInRlc3RJbmRleCIsIlJVTl9JRF9URU1QTEFURSIsInF1YXJhbnRpbmVBdHRlbXB0IiwiUGF0aFBhdHRlcm4iLCJjb25zdHJ1Y3RvciIsInBhdHRlcm4iLCJmaWxlRXh0ZW5zaW9uIiwiX2Vuc3VyZVBhdHRlcm4iLCJfYWRkRGVmYXVsdEZpZWxkcyIsInBsYWNlaG9sZGVyVG9EYXRhTWFwIiwiX2NyZWF0ZVBsYWNlaG9sZGVyVG9EYXRhTWFwIiwiZGVmYXVsdEZpZWxkcyIsInRlc3RJZCIsInJ1bklkIiwiZm9ybWF0dGVkRGF0ZSIsIm5vdyIsImZvcm1hdCIsImZvcm1hdHRlZFRpbWUiLCJmaWxlSW5kZXgiLCJlcnJvckZpbGVJbmRleCIsImZpeHR1cmUiLCJ0ZXN0IiwiZm9yRXJyb3IiLCJwYXJzZWRVc2VyQWdlbnQiLCJ0b1N0cmluZyIsImZhbWlseSIsInRvVmVyc2lvbiIsIm9zIiwiX2J1aWxkUGF0aCIsInJlc3VsdEZpbGVQYXRoIiwicGxhY2Vob2xkZXIiLCJmaW5kUGxhY2Vob2xkZXJSZWdFeHAiLCJSZWdFeHAiLCJyZXBsYWNlIiwiZ2V0RmlsZUluZGV4Rm4iLCJyZXN1bHQiLCJ1c2VyQWdlbnQiLCJnZXRQYXRoIiwicGF0aCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7QUFD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LEVBQXJDOztBQUVKLDJCQUFPQSxNQUFQO0FBQ0gsaUJBUkQsTUFVSyxJQUFJTCxnQkFBZ0JoRCxhQUFhUSxTQUFqQyxFQUE0QztBQUM3QywwQkFBTThDLFlBQVkzQixxQkFBcUJxQixXQUFyQixDQUFsQjs7QUFFQSwyQkFBTywrQkFBZ0JNLFNBQWhCLENBQVA7QUFDSDs7QUFFRCx1QkFBTzNCLHFCQUFxQnFCLFdBQXJCLENBQVA7QUFDSCxhQWxCZ0IsQ0FBakI7QUFtQkg7O0FBRUQsZUFBT0QsY0FBUDtBQUNIOztBQUVEUSxZQUFTZixRQUFULEVBQW1CO0FBQ2YsY0FBTWdCLE9BQU9uQyxZQUFZeUIsVUFBWixDQUF1QixLQUFLdkIsT0FBNUIsRUFBcUMsS0FBS0ksb0JBQTFDLEVBQWdFYSxRQUFoRSxDQUFiOztBQUVBLGVBQU8sK0JBQWdCZ0IsSUFBaEIsRUFBc0IsS0FBS2hDLGFBQTNCLENBQVA7QUFDSDs7QUFFRDtBQUNBLGVBQVd4QixZQUFYLEdBQTJCO0FBQ3ZCLGVBQU9BLFlBQVA7QUFDSDtBQXRGNEI7a0JBQVpxQixXIiwiZmlsZSI6InV0aWxzL3BhdGgtcGF0dGVybi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGVzY2FwZVJlZ0V4cCBhcyBlc2NhcGVSZSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgY29ycmVjdEZpbGVQYXRoIGZyb20gJy4uL3V0aWxzL2NvcnJlY3QtZmlsZS1wYXRoJztcbmltcG9ydCBlc2NhcGVVc2VyQWdlbnQgZnJvbSAnLi4vdXRpbHMvZXNjYXBlLXVzZXItYWdlbnQnO1xuXG5jb25zdCBEQVRFX0ZPUk1BVCA9ICdZWVlZLU1NLUREJztcbmNvbnN0IFRJTUVfRk9STUFUID0gJ0hILW1tLXNzJztcblxuY29uc3QgRVJST1JTX0ZPTERFUiA9ICdlcnJvcnMnO1xuXG5jb25zdCBQTEFDRUhPTERFUlMgPSB7XG4gICAgREFURTogICAgICAgICAgICAgICAnJHtEQVRFfScsXG4gICAgVElNRTogICAgICAgICAgICAgICAnJHtUSU1FfScsXG4gICAgVEVTVF9JTkRFWDogICAgICAgICAnJHtURVNUX0lOREVYfScsXG4gICAgRklMRV9JTkRFWDogICAgICAgICAnJHtGSUxFX0lOREVYfScsXG4gICAgUVVBUkFOVElORV9BVFRFTVBUOiAnJHtRVUFSQU5USU5FX0FUVEVNUFR9JyxcbiAgICBGSVhUVVJFOiAgICAgICAgICAgICcke0ZJWFRVUkV9JyxcbiAgICBURVNUOiAgICAgICAgICAgICAgICcke1RFU1R9JyxcbiAgICBVU0VSQUdFTlQ6ICAgICAgICAgICcke1VTRVJBR0VOVH0nLFxuICAgIEJST1dTRVI6ICAgICAgICAgICAgJyR7QlJPV1NFUn0nLFxuICAgIEJST1dTRVJfVkVSU0lPTjogICAgJyR7QlJPV1NFUl9WRVJTSU9OfScsXG4gICAgT1M6ICAgICAgICAgICAgICAgICAnJHtPU30nLFxuICAgIE9TX1ZFUlNJT046ICAgICAgICAgJyR7T1NfVkVSU0lPTn0nLFxuICAgIFRFU1RfSUQ6ICAgICAgICAgICAgJyR7VEVTVF9JRH0nLFxuICAgIFJVTl9JRDogICAgICAgICAgICAgJyR7UlVOX0lEfSdcbn07XG5cbmNvbnN0IERFRkFVTFRfUEFUSF9QQVRURVJOX0ZPUl9SRVBPUlQgPSBgJHtQTEFDRUhPTERFUlMuREFURX1fJHtQTEFDRUhPTERFUlMuVElNRX1cXFxcJHtQTEFDRUhPTERFUlMuVEVTVF9JRH1cXFxcYCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYCR7UExBQ0VIT0xERVJTLlJVTl9JRH1cXFxcJHtQTEFDRUhPTERFUlMuVVNFUkFHRU5UfVxcXFwke1BMQUNFSE9MREVSUy5GSUxFX0lOREVYfWA7XG5cbmNvbnN0IFRFU1RfSURfVEVNUExBVEUgPSBkYXRhID0+IGRhdGEudGVzdEluZGV4ID8gYHRlc3QtJHtkYXRhLnRlc3RJbmRleH1gIDogJyc7XG5jb25zdCBSVU5fSURfVEVNUExBVEUgID0gZGF0YSA9PiBkYXRhLnF1YXJhbnRpbmVBdHRlbXB0ID8gYHJ1bi0ke2RhdGEucXVhcmFudGluZUF0dGVtcHR9YCA6ICcnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQYXRoUGF0dGVybiB7XG4gICAgY29uc3RydWN0b3IgKHBhdHRlcm4sIGZpbGVFeHRlbnNpb24sIGRhdGEpIHtcbiAgICAgICAgdGhpcy5wYXR0ZXJuICAgICAgICAgICAgICA9IHRoaXMuX2Vuc3VyZVBhdHRlcm4ocGF0dGVybik7XG4gICAgICAgIHRoaXMuZGF0YSAgICAgICAgICAgICAgICAgPSB0aGlzLl9hZGREZWZhdWx0RmllbGRzKGRhdGEpO1xuICAgICAgICB0aGlzLnBsYWNlaG9sZGVyVG9EYXRhTWFwID0gdGhpcy5fY3JlYXRlUGxhY2Vob2xkZXJUb0RhdGFNYXAoKTtcbiAgICAgICAgdGhpcy5maWxlRXh0ZW5zaW9uICAgICAgICA9IGZpbGVFeHRlbnNpb247XG4gICAgfVxuXG4gICAgX2Vuc3VyZVBhdHRlcm4gKHBhdHRlcm4pIHtcbiAgICAgICAgaWYgKHBhdHRlcm4pXG4gICAgICAgICAgICByZXR1cm4gcGF0dGVybjtcblxuICAgICAgICByZXR1cm4gREVGQVVMVF9QQVRIX1BBVFRFUk5fRk9SX1JFUE9SVDtcbiAgICB9XG5cbiAgICBfYWRkRGVmYXVsdEZpZWxkcyAoZGF0YSkge1xuICAgICAgICBjb25zdCBkZWZhdWx0RmllbGRzID0ge1xuICAgICAgICAgICAgdGVzdElkOiAgICAgICAgIFRFU1RfSURfVEVNUExBVEUoZGF0YSksXG4gICAgICAgICAgICBydW5JZDogICAgICAgICAgUlVOX0lEX1RFTVBMQVRFKGRhdGEpLFxuICAgICAgICAgICAgZm9ybWF0dGVkRGF0ZTogIGRhdGEubm93LmZvcm1hdChEQVRFX0ZPUk1BVCksXG4gICAgICAgICAgICBmb3JtYXR0ZWRUaW1lOiAgZGF0YS5ub3cuZm9ybWF0KFRJTUVfRk9STUFUKSxcbiAgICAgICAgICAgIGZpbGVJbmRleDogICAgICAxLFxuICAgICAgICAgICAgZXJyb3JGaWxlSW5kZXg6IDFcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgZGVmYXVsdEZpZWxkcywgZGF0YSk7XG4gICAgfVxuXG4gICAgX2NyZWF0ZVBsYWNlaG9sZGVyVG9EYXRhTWFwICgpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuVEVTVF9JRF06ICAgICAgICAgICAgdGhpcy5kYXRhLnRlc3RJZCxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuUlVOX0lEXTogICAgICAgICAgICAgdGhpcy5kYXRhLnJ1bklkLFxuICAgICAgICAgICAgW1BMQUNFSE9MREVSUy5EQVRFXTogICAgICAgICAgICAgICB0aGlzLmRhdGEuZm9ybWF0dGVkRGF0ZSxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuVElNRV06ICAgICAgICAgICAgICAgdGhpcy5kYXRhLmZvcm1hdHRlZFRpbWUsXG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLlRFU1RfSU5ERVhdOiAgICAgICAgIHRoaXMuZGF0YS50ZXN0SW5kZXgsXG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLlFVQVJBTlRJTkVfQVRURU1QVF06IHRoaXMuZGF0YS5xdWFyYW50aW5lQXR0ZW1wdCB8fCAxLFxuICAgICAgICAgICAgW1BMQUNFSE9MREVSUy5GSVhUVVJFXTogICAgICAgICAgICB0aGlzLmRhdGEuZml4dHVyZSxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuVEVTVF06ICAgICAgICAgICAgICAgdGhpcy5kYXRhLnRlc3QsXG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLkZJTEVfSU5ERVhdOiAgICAgICAgIGZvckVycm9yID0+IGZvckVycm9yID8gdGhpcy5kYXRhLmVycm9yRmlsZUluZGV4IDogdGhpcy5kYXRhLmZpbGVJbmRleCxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuVVNFUkFHRU5UXTogICAgICAgICAgdGhpcy5kYXRhLnBhcnNlZFVzZXJBZ2VudC50b1N0cmluZygpLFxuICAgICAgICAgICAgW1BMQUNFSE9MREVSUy5CUk9XU0VSXTogICAgICAgICAgICB0aGlzLmRhdGEucGFyc2VkVXNlckFnZW50LmZhbWlseSxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuQlJPV1NFUl9WRVJTSU9OXTogICAgdGhpcy5kYXRhLnBhcnNlZFVzZXJBZ2VudC50b1ZlcnNpb24oKSxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuT1NdOiAgICAgICAgICAgICAgICAgdGhpcy5kYXRhLnBhcnNlZFVzZXJBZ2VudC5vcy5mYW1pbHksXG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLk9TX1ZFUlNJT05dOiAgICAgICAgIHRoaXMuZGF0YS5wYXJzZWRVc2VyQWdlbnQub3MudG9WZXJzaW9uKClcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX2J1aWxkUGF0aCAocGF0dGVybiwgcGxhY2Vob2xkZXJUb0RhdGFNYXAsIGZvckVycm9yKSB7XG4gICAgICAgIGxldCByZXN1bHRGaWxlUGF0aCA9IHBhdHRlcm47XG5cbiAgICAgICAgZm9yIChjb25zdCBwbGFjZWhvbGRlciBpbiBwbGFjZWhvbGRlclRvRGF0YU1hcCkge1xuICAgICAgICAgICAgY29uc3QgZmluZFBsYWNlaG9sZGVyUmVnRXhwID0gbmV3IFJlZ0V4cChlc2NhcGVSZShwbGFjZWhvbGRlciksICdnJyk7XG5cbiAgICAgICAgICAgIHJlc3VsdEZpbGVQYXRoID0gcmVzdWx0RmlsZVBhdGgucmVwbGFjZShmaW5kUGxhY2Vob2xkZXJSZWdFeHAsICgpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocGxhY2Vob2xkZXIgPT09IFBMQUNFSE9MREVSUy5GSUxFX0lOREVYKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGdldEZpbGVJbmRleEZuID0gcGxhY2Vob2xkZXJUb0RhdGFNYXBbcGxhY2Vob2xkZXJdO1xuICAgICAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ICAgICAgICAgICA9IGdldEZpbGVJbmRleEZuKGZvckVycm9yKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoZm9yRXJyb3IpXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBgJHtFUlJPUlNfRk9MREVSfVxcXFwke3Jlc3VsdH1gO1xuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgZWxzZSBpZiAocGxhY2Vob2xkZXIgPT09IFBMQUNFSE9MREVSUy5VU0VSQUdFTlQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXNlckFnZW50ID0gcGxhY2Vob2xkZXJUb0RhdGFNYXBbcGxhY2Vob2xkZXJdO1xuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBlc2NhcGVVc2VyQWdlbnQodXNlckFnZW50KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcGxhY2Vob2xkZXJUb0RhdGFNYXBbcGxhY2Vob2xkZXJdO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0RmlsZVBhdGg7XG4gICAgfVxuXG4gICAgZ2V0UGF0aCAoZm9yRXJyb3IpIHtcbiAgICAgICAgY29uc3QgcGF0aCA9IFBhdGhQYXR0ZXJuLl9idWlsZFBhdGgodGhpcy5wYXR0ZXJuLCB0aGlzLnBsYWNlaG9sZGVyVG9EYXRhTWFwLCBmb3JFcnJvcik7XG5cbiAgICAgICAgcmV0dXJuIGNvcnJlY3RGaWxlUGF0aChwYXRoLCB0aGlzLmZpbGVFeHRlbnNpb24pO1xuICAgIH1cblxuICAgIC8vIEZvciB0ZXN0aW5nIHB1cnBvc2VzXG4gICAgc3RhdGljIGdldCBQTEFDRUhPTERFUlMgKCkge1xuICAgICAgICByZXR1cm4gUExBQ0VIT0xERVJTO1xuICAgIH1cbn1cbiJdfQ==
