'use strict';

exports.__esModule = true;

var _getIterator2 = require('babel-runtime/core-js/get-iterator');

var _getIterator3 = _interopRequireDefault(_getIterator2);

var _entries = require('babel-runtime/core-js/object/entries');

var _entries2 = _interopRequireDefault(_entries);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _path = require('path');

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _child_process = require('child_process');

var _makeDir = require('make-dir');

var _makeDir2 = _interopRequireDefault(_makeDir);

var _process = require('./process');

var _process2 = _interopRequireDefault(_process);

var _tempDirectory = require('../utils/temp-directory');

var _tempDirectory2 = _interopRequireDefault(_tempDirectory);

var _pathPattern = require('../utils/path-pattern');

var _pathPattern2 = _interopRequireDefault(_pathPattern);

var _warningMessage = require('../notifications/warning-message');

var _warningMessage2 = _interopRequireDefault(_warningMessage);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEBUG_LOGGER = (0, _debug2.default)('testcafe:video-recorder');

const VIDEO_EXTENSION = 'mp4';

const TEMP_DIR_PREFIX = 'video';
const TEMP_VIDEO_FILE_PREFIX = 'tmp-video';
const TEMP_MERGE_FILE_PREFIX = TEMP_VIDEO_FILE_PREFIX + '-merge';

const TEMP_MERGE_CONFIG_FILE_PREFIX = 'config';
const TEMP_MERGE_CONFIG_FILE_EXTENSION = 'txt';

class VideoRecorder {
    constructor(browserJob, basePath, opts, encodingOpts) {
        this.browserJob = browserJob;
        this.basePath = basePath;
        this.failedOnly = opts.failedOnly;
        this.singleFile = opts.singleFile;
        this.ffmpegPath = opts.ffmpegPath;
        this.customPathPattern = opts.pathPattern;
        this.timeStamp = opts.timeStamp;
        this.encodingOptions = encodingOpts;

        this.tempDirectory = new _tempDirectory2.default(TEMP_DIR_PREFIX);
        this.tempVideoPath = '';
        this.tempMergeConfigPath = '';

        this.firstFile = true;

        this.testRunInfo = {};

        this._assignEventHandlers(browserJob);
    }

    _createSafeListener(listener) {
        var _this = this;

        return (() => {
            var _ref = (0, _asyncToGenerator3.default)(function* (...args) {
                try {
                    return yield listener.apply(_this, args);
                } catch (error) {
                    DEBUG_LOGGER(listener && listener.name, error);

                    return void 0;
                }
            });

            return function () {
                return _ref.apply(this, arguments);
            };
        })();
    }

    _assignEventHandlers(browserJob) {
        browserJob.once('start', this._createSafeListener(this._onBrowserJobStart));
        browserJob.once('done', this._createSafeListener(this._onBrowserJobDone));
        browserJob.on('test-run-create', this._createSafeListener(this._onTestRunCreate));
        browserJob.on('test-run-ready', this._createSafeListener(this._onTestRunReady));
        browserJob.on('test-run-before-done', this._createSafeListener(this._onTestRunBeforeDone));
    }

    _getTargetVideoPath(testRunInfo) {
        const test = testRunInfo.test,
              index = testRunInfo.index,
              testRun = testRunInfo.testRun;


        const connection = testRun.browserConnection;

        const pathPattern = new _pathPattern2.default(this.customPathPattern, VIDEO_EXTENSION, {
            testIndex: this.singleFile ? null : index,
            quarantineAttempt: null,
            now: this.timeStamp,
            fixture: this.singleFile ? '' : test.fixture.name,
            test: this.singleFile ? '' : test.name,
            parsedUserAgent: connection.browserInfo.parsedUserAgent
        });

        return (0, _path.join)(this.basePath, pathPattern.getPath());
    }

    _generateTempNames(id) {
        const tempFileNames = {
            tempVideoPath: `${TEMP_VIDEO_FILE_PREFIX}-${id}.${VIDEO_EXTENSION}`,
            tempMergeConfigPath: `${TEMP_MERGE_CONFIG_FILE_PREFIX}-${id}.${TEMP_MERGE_CONFIG_FILE_EXTENSION}`,
            tmpMergeName: `${TEMP_MERGE_FILE_PREFIX}-${id}.${VIDEO_EXTENSION}`
        };

        for (var _iterator = (0, _entries2.default)(tempFileNames), _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : (0, _getIterator3.default)(_iterator);;) {
            var _ref3;

            if (_isArray) {
                if (_i >= _iterator.length) break;
                _ref3 = _iterator[_i++];
            } else {
                _i = _iterator.next();
                if (_i.done) break;
                _ref3 = _i.value;
            }

            const _ref2 = _ref3;
            const tempFile = _ref2[0];
            const tempName = _ref2[1];

            tempFileNames[tempFile] = (0, _path.join)(this.tempDirectory.path, tempName);
        }return tempFileNames;
    }

    _concatVideo(targetVideoPath, { tempVideoPath, tempMergeConfigPath, tmpMergeName }) {
        if (this.firstFile) {
            this.firstFile = false;
            return;
        }

        _fs2.default.writeFileSync(tempMergeConfigPath, `
            file '${targetVideoPath}'
            file '${tempVideoPath}'
        `);

        (0, _child_process.spawnSync)(this.ffmpegPath, ['-y', '-f', 'concat', '-safe', '0', '-i', tempMergeConfigPath, '-c', 'copy', tmpMergeName], { stdio: 'ignore' });
        _fs2.default.copyFileSync(tmpMergeName, tempVideoPath);
    }

    _onBrowserJobStart() {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this2.tempDirectory.init();
        })();
    }

    _onBrowserJobDone() {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this3.tempDirectory.dispose();
        })();
    }

    _onTestRunCreate({ testRun, legacy, quarantine, test, index }) {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (legacy) return;

            const testRunInfo = { testRun, quarantine, test, index };

            const connection = testRun.browserConnection;

            const connectionCapabilities = yield testRun.browserConnection.provider.hasCustomActionForBrowser(connection.id);

            if (!connectionCapabilities || !connectionCapabilities.hasGetVideoFrameData) {
                _this4.browserJob.warningLog.addWarning(_warningMessage2.default.videoNotSupportedByBrowser, connection.browserInfo.alias);

                return;
            }

            _this4.testRunInfo[index] = testRunInfo;

            testRunInfo.tempFiles = _this4._generateTempNames(connection.id);

            testRunInfo.videoRecorder = new _process2.default(testRunInfo.tempFiles.tempVideoPath, _this4.ffmpegPath, connection, _this4.encodingOptions);

            yield testRunInfo.videoRecorder.init();
        })();
    }

    _onTestRunReady(testRunController) {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const testRunInfo = _this5.testRunInfo[testRunController.index];

            if (!testRunInfo) return;

            yield testRunInfo.videoRecorder.startCapturing();
        })();
    }

    _onTestRunBeforeDone(testRunController) {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const testRunInfo = _this6.testRunInfo[testRunController.index];

            if (!testRunInfo) return;

            delete _this6.testRunInfo[testRunController.index];

            yield testRunInfo.videoRecorder.finishCapturing();

            const videoPath = _this6._getTargetVideoPath(testRunInfo);

            if (_this6.failedOnly && !testRunController.testRun.errs.length) return;

            yield (0, _makeDir2.default)((0, _path.dirname)(videoPath));

            if (_this6.singleFile) _this6._concatVideo(videoPath, testRunInfo.tempFiles);

            _fs2.default.copyFileSync(testRunInfo.tempFiles.tempVideoPath, videoPath);
        })();
    }
}
exports.default = VideoRecorder;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy92aWRlby1yZWNvcmRlci9pbmRleC5qcyJdLCJuYW1lcyI6WyJERUJVR19MT0dHRVIiLCJWSURFT19FWFRFTlNJT04iLCJURU1QX0RJUl9QUkVGSVgiLCJURU1QX1ZJREVPX0ZJTEVfUFJFRklYIiwiVEVNUF9NRVJHRV9GSUxFX1BSRUZJWCIsIlRFTVBfTUVSR0VfQ09ORklHX0ZJTEVfUFJFRklYIiwiVEVNUF9NRVJHRV9DT05GSUdfRklMRV9FWFRFTlNJT04iLCJWaWRlb1JlY29yZGVyIiwiY29uc3RydWN0b3IiLCJicm93c2VySm9iIiwiYmFzZVBhdGgiLCJvcHRzIiwiZW5jb2RpbmdPcHRzIiwiZmFpbGVkT25seSIsInNpbmdsZUZpbGUiLCJmZm1wZWdQYXRoIiwiY3VzdG9tUGF0aFBhdHRlcm4iLCJwYXRoUGF0dGVybiIsInRpbWVTdGFtcCIsImVuY29kaW5nT3B0aW9ucyIsInRlbXBEaXJlY3RvcnkiLCJUZW1wRGlyZWN0b3J5IiwidGVtcFZpZGVvUGF0aCIsInRlbXBNZXJnZUNvbmZpZ1BhdGgiLCJmaXJzdEZpbGUiLCJ0ZXN0UnVuSW5mbyIsIl9hc3NpZ25FdmVudEhhbmRsZXJzIiwiX2NyZWF0ZVNhZmVMaXN0ZW5lciIsImxpc3RlbmVyIiwiYXJncyIsImFwcGx5IiwiZXJyb3IiLCJuYW1lIiwib25jZSIsIl9vbkJyb3dzZXJKb2JTdGFydCIsIl9vbkJyb3dzZXJKb2JEb25lIiwib24iLCJfb25UZXN0UnVuQ3JlYXRlIiwiX29uVGVzdFJ1blJlYWR5IiwiX29uVGVzdFJ1bkJlZm9yZURvbmUiLCJfZ2V0VGFyZ2V0VmlkZW9QYXRoIiwidGVzdCIsImluZGV4IiwidGVzdFJ1biIsImNvbm5lY3Rpb24iLCJicm93c2VyQ29ubmVjdGlvbiIsIlBhdGhQYXR0ZXJuIiwidGVzdEluZGV4IiwicXVhcmFudGluZUF0dGVtcHQiLCJub3ciLCJmaXh0dXJlIiwicGFyc2VkVXNlckFnZW50IiwiYnJvd3NlckluZm8iLCJnZXRQYXRoIiwiX2dlbmVyYXRlVGVtcE5hbWVzIiwiaWQiLCJ0ZW1wRmlsZU5hbWVzIiwidG1wTWVyZ2VOYW1lIiwidGVtcEZpbGUiLCJ0ZW1wTmFtZSIsInBhdGgiLCJfY29uY2F0VmlkZW8iLCJ0YXJnZXRWaWRlb1BhdGgiLCJmcyIsIndyaXRlRmlsZVN5bmMiLCJzdGRpbyIsImNvcHlGaWxlU3luYyIsImluaXQiLCJkaXNwb3NlIiwibGVnYWN5IiwicXVhcmFudGluZSIsImNvbm5lY3Rpb25DYXBhYmlsaXRpZXMiLCJwcm92aWRlciIsImhhc0N1c3RvbUFjdGlvbkZvckJyb3dzZXIiLCJoYXNHZXRWaWRlb0ZyYW1lRGF0YSIsIndhcm5pbmdMb2ciLCJhZGRXYXJuaW5nIiwiV0FSTklOR19NRVNTQUdFUyIsInZpZGVvTm90U3VwcG9ydGVkQnlCcm93c2VyIiwiYWxpYXMiLCJ0ZW1wRmlsZXMiLCJ2aWRlb1JlY29yZGVyIiwiVmlkZW9SZWNvcmRlclByb2Nlc3MiLCJ0ZXN0UnVuQ29udHJvbGxlciIsInN0YXJ0Q2FwdHVyaW5nIiwiZmluaXNoQ2FwdHVyaW5nIiwidmlkZW9QYXRoIiwiZXJycyIsImxlbmd0aCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7QUFHQSxNQUFNQSxlQUFlLHFCQUFNLHlCQUFOLENBQXJCOztBQUVBLE1BQU1DLGtCQUFrQixLQUF4Qjs7QUFFQSxNQUFNQyxrQkFBeUIsT0FBL0I7QUFDQSxNQUFNQyx5QkFBeUIsV0FBL0I7QUFDQSxNQUFNQyx5QkFBeUJELHlCQUF5QixRQUF4RDs7QUFFQSxNQUFNRSxnQ0FBbUMsUUFBekM7QUFDQSxNQUFNQyxtQ0FBbUMsS0FBekM7O0FBRWUsTUFBTUMsYUFBTixDQUFvQjtBQUMvQkMsZ0JBQWFDLFVBQWIsRUFBeUJDLFFBQXpCLEVBQW1DQyxJQUFuQyxFQUF5Q0MsWUFBekMsRUFBdUQ7QUFDbkQsYUFBS0gsVUFBTCxHQUF5QkEs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O0FBdkJrRTtBQXdCckU7O0FBRUs3QixtQkFBTixDQUF1QjZDLGlCQUF2QixFQUEwQztBQUFBOztBQUFBO0FBQ3RDLGtCQUFNMUQsY0FBYyxPQUFLQSxXQUFMLENBQWlCMEQsa0JBQWtCekMsS0FBbkMsQ0FBcEI7O0FBRUEsZ0JBQUksQ0FBQ2pCLFdBQUwsRUFDSTs7QUFFSixrQkFBTUEsWUFBWXdELGFBQVosQ0FBMEJHLGNBQTFCLEVBQU47QUFOc0M7QUFPekM7O0FBRUs3Qyx3QkFBTixDQUE0QjRDLGlCQUE1QixFQUErQztBQUFBOztBQUFBO0FBQzNDLGtCQUFNMUQsY0FBYyxPQUFLQSxXQUFMLENBQWlCMEQsa0JBQWtCekMsS0FBbkMsQ0FBcEI7O0FBRUEsZ0JBQUksQ0FBQ2pCLFdBQUwsRUFDSTs7QUFFSixtQkFBTyxPQUFLQSxXQUFMLENBQWlCMEQsa0JBQWtCekMsS0FBbkMsQ0FBUDs7QUFFQSxrQkFBTWpCLFlBQVl3RCxhQUFaLENBQTBCSSxlQUExQixFQUFOOztBQUVBLGtCQUFNQyxZQUFZLE9BQUs5QyxtQkFBTCxDQUF5QmYsV0FBekIsQ0FBbEI7O0FBRUEsZ0JBQUksT0FBS1osVUFBTCxJQUFtQixDQUFDc0Usa0JBQWtCeEMsT0FBbEIsQ0FBMEI0QyxJQUExQixDQUErQkMsTUFBdkQsRUFDSTs7QUFFSixrQkFBTSx1QkFBUSxtQkFBUUYsU0FBUixDQUFSLENBQU47O0FBRUEsZ0JBQUksT0FBS3hFLFVBQVQsRUFDSSxPQUFLK0MsWUFBTCxDQUFrQnlCLFNBQWxCLEVBQTZCN0QsWUFBWXVELFNBQXpDOztBQUVKakIseUJBQUdHLFlBQUgsQ0FBZ0J6QyxZQUFZdUQsU0FBWixDQUFzQjFELGFBQXRDLEVBQXFEZ0UsU0FBckQ7QUFwQjJDO0FBcUI5QztBQXhKOEI7a0JBQWQvRSxhIiwiZmlsZSI6InZpZGVvLXJlY29yZGVyL2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGRlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCB7IGpvaW4sIGRpcm5hbWUgfSBmcm9tICdwYXRoJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgeyBzcGF3blN5bmMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCBtYWtlRGlyIGZyb20gJ21ha2UtZGlyJztcbmltcG9ydCBWaWRlb1JlY29yZGVyUHJvY2VzcyBmcm9tICcuL3Byb2Nlc3MnO1xuaW1wb3J0IFRlbXBEaXJlY3RvcnkgZnJvbSAnLi4vdXRpbHMvdGVtcC1kaXJlY3RvcnknO1xuaW1wb3J0IFBhdGhQYXR0ZXJuIGZyb20gJy4uL3V0aWxzL3BhdGgtcGF0dGVybic7XG5pbXBvcnQgV0FSTklOR19NRVNTQUdFUyBmcm9tICcuLi9ub3RpZmljYXRpb25zL3dhcm5pbmctbWVzc2FnZSc7XG5cblxuY29uc3QgREVCVUdfTE9HR0VSID0gZGVidWcoJ3Rlc3RjYWZlOnZpZGVvLXJlY29yZGVyJyk7XG5cbmNvbnN0IFZJREVPX0VYVEVOU0lPTiA9ICdtcDQnO1xuXG5jb25zdCBURU1QX0RJUl9QUkVGSVggICAgICAgID0gJ3ZpZGVvJztcbmNvbnN0IFRFTVBfVklERU9fRklMRV9QUkVGSVggPSAndG1wLXZpZGVvJztcbmNvbnN0IFRFTVBfTUVSR0VfRklMRV9QUkVGSVggPSBURU1QX1ZJREVPX0ZJTEVfUFJFRklYICsgJy1tZXJnZSc7XG5cbmNvbnN0IFRFTVBfTUVSR0VfQ09ORklHX0ZJTEVfUFJFRklYICAgID0gJ2NvbmZpZyc7XG5jb25zdCBURU1QX01FUkdFX0NPTkZJR19GSUxFX0VYVEVOU0lPTiA9ICd0eHQnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBWaWRlb1JlY29yZGVyIHtcbiAgICBjb25zdHJ1Y3RvciAoYnJvd3NlckpvYiwgYmFzZVBhdGgsIG9wdHMsIGVuY29kaW5nT3B0cykge1xuICAgICAgICB0aGlzLmJyb3dzZXJKb2IgICAgICAgID0gYnJvd3NlckpvYjtcbiAgICAgICAgdGhpcy5iYXNlUGF0aCAgICAgICAgICA9IGJhc2VQYXRoO1xuICAgICAgICB0aGlzLmZhaWxlZE9ubHkgICAgICAgID0gb3B0cy5mYWlsZWRPbmx5O1xuICAgICAgICB0aGlzLnNpbmdsZUZpbGUgICAgICAgID0gb3B0cy5zaW5nbGVGaWxlO1xuICAgICAgICB0aGlzLmZmbXBlZ1BhdGggICAgICAgID0gb3B0cy5mZm1wZWdQYXRoO1xuICAgICAgICB0aGlzLmN1c3RvbVBhdGhQYXR0ZXJuID0gb3B0cy5wYXRoUGF0dGVybjtcbiAgICAgICAgdGhpcy50aW1lU3RhbXAgICAgICAgICA9IG9wdHMudGltZVN0YW1wO1xuICAgICAgICB0aGlzLmVuY29kaW5nT3B0aW9ucyAgID0gZW5jb2RpbmdPcHRzO1xuXG4gICAgICAgIHRoaXMudGVtcERpcmVjdG9yeSAgICAgICA9IG5ldyBUZW1wRGlyZWN0b3J5KFRFTVBfRElSX1BSRUZJWCk7XG4gICAgICAgIHRoaXMudGVtcFZpZGVvUGF0aCAgICAgICA9ICcnO1xuICAgICAgICB0aGlzLnRlbXBNZXJnZUNvbmZpZ1BhdGggPSAnJztcblxuICAgICAgICB0aGlzLmZpcnN0RmlsZSA9IHRydWU7XG5cbiAgICAgICAgdGhpcy50ZXN0UnVuSW5mbyA9IHt9O1xuXG4gICAgICAgIHRoaXMuX2Fzc2lnbkV2ZW50SGFuZGxlcnMoYnJvd3NlckpvYik7XG4gICAgfVxuXG4gICAgX2NyZWF0ZVNhZmVMaXN0ZW5lciAobGlzdGVuZXIpIHtcbiAgICAgICAgcmV0dXJuIGFzeW5jICguLi5hcmdzKSA9PiB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBsaXN0ZW5lci5hcHBseSh0aGlzLCBhcmdzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIERFQlVHX0xPR0dFUihsaXN0ZW5lciAmJiBsaXN0ZW5lci5uYW1lLCBlcnJvcik7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIF9hc3NpZ25FdmVudEhhbmRsZXJzIChicm93c2VySm9iKSB7XG4gICAgICAgIGJyb3dzZXJKb2Iub25jZSgnc3RhcnQnLCB0aGlzLl9jcmVhdGVTYWZlTGlzdGVuZXIodGhpcy5fb25Ccm93c2VySm9iU3RhcnQpKTtcbiAgICAgICAgYnJvd3NlckpvYi5vbmNlKCdkb25lJywgdGhpcy5fY3JlYXRlU2FmZUxpc3RlbmVyKHRoaXMuX29uQnJvd3NlckpvYkRvbmUpKTtcbiAgICAgICAgYnJvd3NlckpvYi5vbigndGVzdC1ydW4tY3JlYXRlJywgdGhpcy5fY3JlYXRlU2FmZUxpc3RlbmVyKHRoaXMuX29uVGVzdFJ1bkNyZWF0ZSkpO1xuICAgICAgICBicm93c2VySm9iLm9uKCd0ZXN0LXJ1bi1yZWFkeScsIHRoaXMuX2NyZWF0ZVNhZmVMaXN0ZW5lcih0aGlzLl9vblRlc3RSdW5SZWFkeSkpO1xuICAgICAgICBicm93c2VySm9iLm9uKCd0ZXN0LXJ1bi1iZWZvcmUtZG9uZScsIHRoaXMuX2NyZWF0ZVNhZmVMaXN0ZW5lcih0aGlzLl9vblRlc3RSdW5CZWZvcmVEb25lKSk7XG4gICAgfVxuXG4gICAgX2dldFRhcmdldFZpZGVvUGF0aCAodGVzdFJ1bkluZm8pIHtcbiAgICAgICAgY29uc3QgeyB0ZXN0LCBpbmRleCwgdGVzdFJ1biB9ID0gdGVzdFJ1bkluZm87XG5cbiAgICAgICAgY29uc3QgY29ubmVjdGlvbiA9IHRlc3RSdW4uYnJvd3NlckNvbm5lY3Rpb247XG5cbiAgICAgICAgY29uc3QgcGF0aFBhdHRlcm4gPSBuZXcgUGF0aFBhdHRlcm4odGhpcy5jdXN0b21QYXRoUGF0dGVybiwgVklERU9fRVhURU5TSU9OLCB7XG4gICAgICAgICAgICB0ZXN0SW5kZXg6ICAgICAgICAgdGhpcy5zaW5nbGVGaWxlID8gbnVsbCA6IGluZGV4LFxuICAgICAgICAgICAgcXVhcmFudGluZUF0dGVtcHQ6IG51bGwsXG4gICAgICAgICAgICBub3c6ICAgICAgICAgICAgICAgdGhpcy50aW1lU3RhbXAsXG4gICAgICAgICAgICBmaXh0dXJlOiAgICAgICAgICAgdGhpcy5zaW5nbGVGaWxlID8gJycgOiB0ZXN0LmZpeHR1cmUubmFtZSxcbiAgICAgICAgICAgIHRlc3Q6ICAgICAgICAgICAgICB0aGlzLnNpbmdsZUZpbGUgPyAnJyA6IHRlc3QubmFtZSxcbiAgICAgICAgICAgIHBhcnNlZFVzZXJBZ2VudDogICBjb25uZWN0aW9uLmJyb3dzZXJJbmZvLnBhcnNlZFVzZXJBZ2VudCxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGpvaW4odGhpcy5iYXNlUGF0aCwgcGF0aFBhdHRlcm4uZ2V0UGF0aCgpKTtcbiAgICB9XG5cbiAgICBfZ2VuZXJhdGVUZW1wTmFtZXMgKGlkKSB7XG4gICAgICAgIGNvbnN0IHRlbXBGaWxlTmFtZXMgPSB7XG4gICAgICAgICAgICB0ZW1wVmlkZW9QYXRoOiAgICAgICBgJHtURU1QX1ZJREVPX0ZJTEVfUFJFRklYfS0ke2lkfS4ke1ZJREVPX0VYVEVOU0lPTn1gLFxuICAgICAgICAgICAgdGVtcE1lcmdlQ29uZmlnUGF0aDogYCR7VEVNUF9NRVJHRV9DT05GSUdfRklMRV9QUkVGSVh9LSR7aWR9LiR7VEVNUF9NRVJHRV9DT05GSUdfRklMRV9FWFRFTlNJT059YCxcbiAgICAgICAgICAgIHRtcE1lcmdlTmFtZTogICAgICAgIGAke1RFTVBfTUVSR0VfRklMRV9QUkVGSVh9LSR7aWR9LiR7VklERU9fRVhURU5TSU9OfWBcbiAgICAgICAgfTtcblxuICAgICAgICBmb3IgKGNvbnN0IFt0ZW1wRmlsZSwgdGVtcE5hbWVdIG9mIE9iamVjdC5lbnRyaWVzKHRlbXBGaWxlTmFtZXMpKVxuICAgICAgICAgICAgdGVtcEZpbGVOYW1lc1t0ZW1wRmlsZV0gPSBqb2luKHRoaXMudGVtcERpcmVjdG9yeS5wYXRoLCB0ZW1wTmFtZSk7XG5cbiAgICAgICAgcmV0dXJuIHRlbXBGaWxlTmFtZXM7XG4gICAgfVxuXG4gICAgX2NvbmNhdFZpZGVvICh0YXJnZXRWaWRlb1BhdGgsIHsgdGVtcFZpZGVvUGF0aCwgdGVtcE1lcmdlQ29uZmlnUGF0aCwgdG1wTWVyZ2VOYW1lIH0pIHtcbiAgICAgICAgaWYgKHRoaXMuZmlyc3RGaWxlKSB7XG4gICAgICAgICAgICB0aGlzLmZpcnN0RmlsZSA9IGZhbHNlO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyh0ZW1wTWVyZ2VDb25maWdQYXRoLCBgXG4gICAgICAgICAgICBmaWxlICcke3RhcmdldFZpZGVvUGF0aH0nXG4gICAgICAgICAgICBmaWxlICcke3RlbXBWaWRlb1BhdGh9J1xuICAgICAgICBgKTtcblxuICAgICAgICBzcGF3blN5bmModGhpcy5mZm1wZWdQYXRoLCBbJy15JywgJy1mJywgJ2NvbmNhdCcsICctc2FmZScsICcwJywgJy1pJywgdGVtcE1lcmdlQ29uZmlnUGF0aCwgJy1jJywgJ2NvcHknLCB0bXBNZXJnZU5hbWVdLCB7IHN0ZGlvOiAnaWdub3JlJyB9KTtcbiAgICAgICAgZnMuY29weUZpbGVTeW5jKHRtcE1lcmdlTmFtZSwgdGVtcFZpZGVvUGF0aCk7XG4gICAgfVxuXG4gICAgYXN5bmMgX29uQnJvd3NlckpvYlN0YXJ0ICgpIHtcbiAgICAgICAgYXdhaXQgdGhpcy50ZW1wRGlyZWN0b3J5LmluaXQoKTtcbiAgICB9XG5cbiAgICBhc3luYyBfb25Ccm93c2VySm9iRG9uZSAoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMudGVtcERpcmVjdG9yeS5kaXNwb3NlKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgX29uVGVzdFJ1bkNyZWF0ZSAoeyB0ZXN0UnVuLCBsZWdhY3ksIHF1YXJhbnRpbmUsIHRlc3QsIGluZGV4IH0pIHtcbiAgICAgICAgaWYgKGxlZ2FjeSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBjb25zdCB0ZXN0UnVuSW5mbyA9IHsgdGVzdFJ1biwgcXVhcmFudGluZSwgdGVzdCwgaW5kZXggfTtcblxuICAgICAgICBjb25zdCBjb25uZWN0aW9uID0gdGVzdFJ1bi5icm93c2VyQ29ubmVjdGlvbjtcblxuICAgICAgICBjb25zdCBjb25uZWN0aW9uQ2FwYWJpbGl0aWVzID0gYXdhaXQgdGVzdFJ1bi5icm93c2VyQ29ubmVjdGlvbi5wcm92aWRlci5oYXNDdXN0b21BY3Rpb25Gb3JCcm93c2VyKGNvbm5lY3Rpb24uaWQpO1xuXG4gICAgICAgIGlmICghY29ubmVjdGlvbkNhcGFiaWxpdGllcyB8fCAhY29ubmVjdGlvbkNhcGFiaWxpdGllcy5oYXNHZXRWaWRlb0ZyYW1lRGF0YSkge1xuICAgICAgICAgICAgdGhpcy5icm93c2VySm9iLndhcm5pbmdMb2cuYWRkV2FybmluZyhXQVJOSU5HX01FU1NBR0VTLnZpZGVvTm90U3VwcG9ydGVkQnlCcm93c2VyLCBjb25uZWN0aW9uLmJyb3dzZXJJbmZvLmFsaWFzKTtcblxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy50ZXN0UnVuSW5mb1tpbmRleF0gPSB0ZXN0UnVuSW5mbztcblxuICAgICAgICB0ZXN0UnVuSW5mby50ZW1wRmlsZXMgPSB0aGlzLl9nZW5lcmF0ZVRlbXBOYW1lcyhjb25uZWN0aW9uLmlkKTtcblxuXG4gICAgICAgIHRlc3RSdW5JbmZvLnZpZGVvUmVjb3JkZXIgPSBuZXcgVmlkZW9SZWNvcmRlclByb2Nlc3ModGVzdFJ1bkluZm8udGVtcEZpbGVzLnRlbXBWaWRlb1BhdGgsIHRoaXMuZmZtcGVnUGF0aCwgY29ubmVjdGlvbiwgdGhpcy5lbmNvZGluZ09wdGlvbnMpO1xuXG4gICAgICAgIGF3YWl0IHRlc3RSdW5JbmZvLnZpZGVvUmVjb3JkZXIuaW5pdCgpO1xuICAgIH1cblxuICAgIGFzeW5jIF9vblRlc3RSdW5SZWFkeSAodGVzdFJ1bkNvbnRyb2xsZXIpIHtcbiAgICAgICAgY29uc3QgdGVzdFJ1bkluZm8gPSB0aGlzLnRlc3RSdW5JbmZvW3Rlc3RSdW5Db250cm9sbGVyLmluZGV4XTtcblxuICAgICAgICBpZiAoIXRlc3RSdW5JbmZvKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGF3YWl0IHRlc3RSdW5JbmZvLnZpZGVvUmVjb3JkZXIuc3RhcnRDYXB0dXJpbmcoKTtcbiAgICB9XG5cbiAgICBhc3luYyBfb25UZXN0UnVuQmVmb3JlRG9uZSAodGVzdFJ1bkNvbnRyb2xsZXIpIHtcbiAgICAgICAgY29uc3QgdGVzdFJ1bkluZm8gPSB0aGlzLnRlc3RSdW5JbmZvW3Rlc3RSdW5Db250cm9sbGVyLmluZGV4XTtcblxuICAgICAgICBpZiAoIXRlc3RSdW5JbmZvKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGRlbGV0ZSB0aGlzLnRlc3RSdW5JbmZvW3Rlc3RSdW5Db250cm9sbGVyLmluZGV4XTtcblxuICAgICAgICBhd2FpdCB0ZXN0UnVuSW5mby52aWRlb1JlY29yZGVyLmZpbmlzaENhcHR1cmluZygpO1xuXG4gICAgICAgIGNvbnN0IHZpZGVvUGF0aCA9IHRoaXMuX2dldFRhcmdldFZpZGVvUGF0aCh0ZXN0UnVuSW5mbyk7XG5cbiAgICAgICAgaWYgKHRoaXMuZmFpbGVkT25seSAmJiAhdGVzdFJ1bkNvbnRyb2xsZXIudGVzdFJ1bi5lcnJzLmxlbmd0aClcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBhd2FpdCBtYWtlRGlyKGRpcm5hbWUodmlkZW9QYXRoKSk7XG5cbiAgICAgICAgaWYgKHRoaXMuc2luZ2xlRmlsZSlcbiAgICAgICAgICAgIHRoaXMuX2NvbmNhdFZpZGVvKHZpZGVvUGF0aCwgdGVzdFJ1bkluZm8udGVtcEZpbGVzKTtcblxuICAgICAgICBmcy5jb3B5RmlsZVN5bmModGVzdFJ1bkluZm8udGVtcEZpbGVzLnRlbXBWaWRlb1BhdGgsIHZpZGVvUGF0aCk7XG4gICAgfVxufVxuIl19
